{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.array.unshift.js\";\n\n/** @ignore */\n\n/** */\nimport { __extends } from \"tslib\";\nimport { BlendMode } from \"./Renderer\";\nimport { Color } from \"../../util/Color\";\nimport { Matrix } from \"../../util/Matrix\";\nimport { Percent, percent } from \"../../util/Percent\"; //import { Throttler } from \"../../util/Throttler\";\n\nimport { ArrayDisposer, Disposer, DisposerClass, CounterDisposer, MultiDisposer } from \"../../util/Disposer\";\nimport { TextFormatter } from \"../../util/TextFormatter\";\nimport * as $utils from \"../../util/Utils\";\nimport * as $array from \"../../util/Array\";\nimport * as $object from \"../../util/Object\";\nimport * as $type from \"../../util/Type\";\nimport * as $math from \"../../util/Math\";\nimport arcToBezier from 'svg-arc-to-cubic-bezier';\n/**\r\n * @ignore\r\n */\n\nfunction checkArgs(name, actual, expected) {\n  if (actual !== expected) {\n    throw new Error(\"Required \" + expected + \" arguments for \" + name + \" but got \" + actual);\n  }\n}\n/**\r\n * @ignore\r\n */\n\n\nfunction checkMinArgs(name, actual, expected) {\n  if (actual < expected) {\n    throw new Error(\"Required at least \" + expected + \" arguments for \" + name + \" but got \" + actual);\n  }\n}\n/**\r\n * @ignore\r\n */\n\n\nfunction checkEvenArgs(name, actual, expected) {\n  checkMinArgs(name, actual, expected);\n\n  if (actual % expected !== 0) {\n    throw new Error(\"Arguments for \" + name + \" must be in pairs of \" + expected);\n  }\n}\n/**\r\n * @ignore\r\n */\n\n\nfunction assertBinary(value) {\n  if (value === 0 || value === 1) {\n    return value;\n  } else {\n    throw new Error(\"Flag must be 0 or 1\");\n  }\n} //  1 -> 0xffffff * (2 / 2)\n//  2 -> 0xffffff * (1 / 2)\n//\n//  3 -> 0xffffff * (3 / 4)\n//  4 -> 0xffffff * (1 / 4)\n//\n//  5 -> 0xffffff * (7 / 8)\n//  6 -> 0xffffff * (5 / 8)\n//  7 -> 0xffffff * (3 / 8)\n//  8 -> 0xffffff * (1 / 8)\n//\n//  9 -> 0xffffff * (15 / 16)\n// 10 -> 0xffffff * (13 / 16)\n// 11 -> 0xffffff * (11 / 16)\n// 12 -> 0xffffff *  (9 / 16)\n// 13 -> 0xffffff *  (7 / 16)\n// 14 -> 0xffffff *  (5 / 16)\n// 15 -> 0xffffff *  (3 / 16)\n// 16 -> 0xffffff *  (1 / 16)\n// @todo remove this old color distribution algo if the new one pans out\n// function distributeIdBAK(id: number): number {\n// \tif (id === 1) {\n// \t\treturn 0x000001;\n// \t} else {\n// \t\t// Finds the closest power of 2\n// \t\tconst base = Math.pow(2, Math.ceil(Math.log(id) / Math.log(2)));\n// \t\t// Translates the id into an odd fraction index\n// \t\tconst index = ((base - id) * 2) + 1;\n// \t\t// TODO is Math.round correct ?\n// \t\treturn Math.round(0xffffff * (index / base));\n// \t}\n// }\n\n/**\r\n * Function by smeans:\r\n * https://lowcode.life/generating-unique-contrasting-colors-in-javascript/\r\n * @ignore\r\n */\n\n\nfunction distributeId(id) {\n  var rgb = [0, 0, 0];\n\n  for (var i = 0; i < 24; i++) {\n    rgb[i % 3] <<= 1;\n    rgb[i % 3] |= id & 0x01;\n    id >>= 1;\n  }\n\n  return (rgb[2] | 0) + (rgb[1] << 8) + (rgb[0] << 16);\n}\n/**\r\n * @ignore\r\n */\n\n\nfunction eachTargets(hitTarget, f) {\n  for (;;) {\n    if (hitTarget.interactive) {\n      if (!f(hitTarget)) {\n        break;\n      }\n    }\n\n    if (hitTarget._parent) {\n      hitTarget = hitTarget._parent;\n    } else {\n      break;\n    }\n  }\n} // TODO feature detection for mouse/touch/pointer\n\n/**\r\n * @ignore\r\n */\n\n\nfunction onPointerEvent(element, name, f) {\n  return $utils.addEventListener(element, $utils.getRendererEvent(name), function (event) {\n    var touches = event.touches;\n\n    if (touches) {\n      if (touches.length == 0) {\n        touches = event.changedTouches;\n      }\n\n      f($array.copy(touches));\n    } else {\n      f([event]);\n    }\n  });\n}\n/**\r\n * @ignore\r\n */\n\n\nfunction isTainted(image) {\n  var canvas = document.createElement(\"canvas\");\n  canvas.width = 1;\n  canvas.height = 1;\n  var context = canvas.getContext(\"2d\", {\n    willReadFrequently: true\n  });\n  context.drawImage(image, 0, 0, 1, 1);\n\n  try {\n    context.getImageData(0, 0, 1, 1);\n    return false;\n  } catch (err) {\n    console.warn(\"Image \\\"\" + image.src + \"\\\" is loaded from different host and is not covered by CORS policy. For more information about the implications read here: https://www.amcharts.com/docs/v5/concepts/cors\");\n    return true;\n  }\n}\n/**\r\n * This is needed to workaround a bug in iOS which causes it to not GC canvas elements.\r\n *\r\n * @ignore\r\n */\n\n\nfunction clearCanvas(view) {\n  view.width = 0;\n  view.height = 0;\n  view.style.width = \"0px\";\n  view.style.height = \"0px\";\n}\n/**\r\n * @ignore\r\n */\n\n\nvar CanvasPivot =\n/** @class */\nfunction () {\n  function CanvasPivot() {\n    Object.defineProperty(this, \"_x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(this, \"_y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n  }\n\n  Object.defineProperty(CanvasPivot.prototype, \"x\", {\n    get: function () {\n      return this._x;\n    },\n    set: function (value) {\n      this._x = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(CanvasPivot.prototype, \"y\", {\n    get: function () {\n      return this._y;\n    },\n    set: function (value) {\n      this._y = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  return CanvasPivot;\n}();\n\nexport { CanvasPivot };\n/**\r\n * @ignore\r\n */\n\nvar CanvasDisplayObject =\n/** @class */\nfunction (_super) {\n  __extends(CanvasDisplayObject, _super);\n\n  function CanvasDisplayObject(renderer) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"_layer\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"mask\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: null\n    });\n    Object.defineProperty(_this, \"visible\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: true\n    });\n    Object.defineProperty(_this, \"exportable\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: true\n    });\n    Object.defineProperty(_this, \"interactive\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"inactive\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"wheelable\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"cancelTouch\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"isMeasured\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"buttonMode\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"alpha\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 1\n    });\n    Object.defineProperty(_this, \"compoundAlpha\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 1\n    });\n    Object.defineProperty(_this, \"angle\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"scale\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 1\n    });\n    Object.defineProperty(_this, \"x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"pivot\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: new CanvasPivot()\n    });\n    Object.defineProperty(_this, \"filter\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"cursorOverStyle\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_replacedCursorStyle\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_localMatrix\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: new Matrix()\n    });\n    Object.defineProperty(_this, \"_matrix\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: new Matrix()\n    }); // TODO can this be replaced with _localMatrix ?\n\n    Object.defineProperty(_this, \"_uMatrix\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: new Matrix()\n    });\n    Object.defineProperty(_this, \"_renderer\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_parent\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_localBounds\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_bounds\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_colorId\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    _this._renderer = renderer;\n    return _this;\n  }\n\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_dispose\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this._renderer._removeObject(this);\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"getCanvas\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return this.getLayer().view;\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"getLayer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      var self = this;\n\n      for (;;) {\n        if (self._layer) {\n          return self._layer;\n        } else if (self._parent) {\n          self = self._parent;\n        } else {\n          return this._renderer.defaultLayer;\n        }\n      }\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"setLayer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (order, visible) {\n      if (visible === void 0) {\n        visible = true;\n      }\n\n      if (order == null) {\n        this._layer = undefined;\n      } else {\n        this._layer = this._renderer.getLayer(order, visible);\n        this._layer.visible = visible;\n\n        if (this._parent) {\n          this._parent.registerChildLayer(this._layer);\n        }\n      }\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"markDirtyLayer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this.getLayer().dirty = true;\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"clear\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this.invalidateBounds();\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"invalidateBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this._localBounds = undefined;\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (_bounds) {}\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_getColorId\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      if (this._colorId === undefined) {\n        this._colorId = this._renderer.paintId(this);\n      }\n\n      return this._colorId;\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_isInteractive\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return this.inactive == false && (this.interactive || this._renderer._forceInteractive > 0);\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_isInteractiveMask\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return this._isInteractive();\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"contains\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (child) {\n      for (;;) {\n        if (child === this) {\n          return true;\n        } else if (child._parent) {\n          child = child._parent;\n        } else {\n          return false;\n        }\n      }\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"toGlobal\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (point) {\n      return this._matrix.apply(point);\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"toLocal\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (point) {\n      return this._matrix.applyInverse(point);\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"getLocalMatrix\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this._uMatrix.setTransform(0, 0, this.pivot.x, this.pivot.y, this.angle * Math.PI / 180, this.scale);\n\n      return this._uMatrix;\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"getLocalBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      if (!this._localBounds) {\n        var bn = 10000000;\n        this._localBounds = {\n          left: bn,\n          top: bn,\n          right: -bn,\n          bottom: -bn\n        };\n\n        this._addBounds(this._localBounds);\n      }\n\n      return this._localBounds;\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"getAdjustedBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      this._setMatrix();\n\n      var matrix = this.getLocalMatrix();\n      var p0 = matrix.apply({\n        x: bounds.left,\n        y: bounds.top\n      });\n      var p1 = matrix.apply({\n        x: bounds.right,\n        y: bounds.top\n      });\n      var p2 = matrix.apply({\n        x: bounds.right,\n        y: bounds.bottom\n      });\n      var p3 = matrix.apply({\n        x: bounds.left,\n        y: bounds.bottom\n      });\n      return {\n        left: Math.min(p0.x, p1.x, p2.x, p3.x),\n        top: Math.min(p0.y, p1.y, p2.y, p3.y),\n        right: Math.max(p0.x, p1.x, p2.x, p3.x),\n        bottom: Math.max(p0.y, p1.y, p2.y, p3.y)\n      };\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"on\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (key, callback, context) {\n      if (this.interactive) {\n        return this._renderer._addEvent(this, key, callback, context);\n      } else {\n        return new Disposer(function () {});\n      }\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_setMatrix\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      // TODO only calculate this if it has actually changed\n      this._localMatrix.setTransform(this.x, this.y, this.pivot.x, this.pivot.y, // Converts degrees to radians\n      this.angle * Math.PI / 180, this.scale);\n\n      this._matrix.copyFrom(this._localMatrix);\n\n      if (this._parent) {\n        // TODO only calculate this if it has actually changed\n        this._matrix.prepend(this._parent._matrix);\n      }\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_transform\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, resolution) {\n      var m = this._matrix;\n      context.setTransform(m.a * resolution, m.b * resolution, m.c * resolution, m.d * resolution, m.tx * resolution, m.ty * resolution);\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      var _this = this;\n\n      if (this.visible && (this.exportable !== false || !this._renderer._omitTainted)) {\n        this._setMatrix();\n\n        var resolution_1 = this._renderer.resolution;\n        var layers = this._renderer.layers;\n        var ghostContext = this._renderer._ghostContext;\n        var mask_1 = this.mask;\n\n        if (mask_1) {\n          mask_1._setMatrix();\n        } // TODO improve this\n\n\n        $array.each(layers, function (layer) {\n          if (layer) {\n            var context = layer.context;\n            context.save(); // We must apply the mask before we transform the element\n\n            if (mask_1) {\n              mask_1._transform(context, layer.scale || resolution_1);\n\n              mask_1._runPath(context);\n\n              context.clip();\n            }\n\n            context.globalAlpha = _this.compoundAlpha * _this.alpha;\n\n            _this._transform(context, layer.scale || resolution_1);\n\n            if (_this.filter) {\n              context.filter = _this.filter;\n            }\n          }\n        });\n        ghostContext.save(); // We must apply the mask before we transform the element\n\n        if (mask_1 && this._isInteractiveMask()) {\n          mask_1._transform(ghostContext, resolution_1);\n\n          mask_1._runPath(ghostContext);\n\n          ghostContext.clip();\n        }\n\n        this._transform(ghostContext, resolution_1);\n\n        this._render(parentLayer);\n\n        ghostContext.restore();\n        $array.each(layers, function (layer) {\n          if (layer) {\n            layer.context.restore();\n          }\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"_render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      if (this.exportable === false) {\n        var layer = this._layer || parentLayer;\n        layer.tainted = true;\n      }\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"hovering\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return this._renderer._hovering.has(this);\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"dragging\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      var _this = this;\n\n      return this._renderer._dragging.some(function (x) {\n        return x.value === _this;\n      });\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"dispose\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this.getLayer().dirty = true;\n    }\n  });\n  Object.defineProperty(CanvasDisplayObject.prototype, \"shouldCancelTouch\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      var renderer = this._renderer;\n\n      if (renderer.tapToActivate && !renderer._touchActive) {\n        return false;\n      }\n\n      if (this.cancelTouch) {\n        return true;\n      } else if (this._parent) {\n        return this._parent.shouldCancelTouch();\n      }\n\n      return false;\n    }\n  });\n  return CanvasDisplayObject;\n}(DisposerClass);\n\nexport { CanvasDisplayObject };\n/**\r\n * @ignore\r\n */\n\nvar CanvasContainer =\n/** @class */\nfunction (_super) {\n  __extends(CanvasContainer, _super);\n\n  function CanvasContainer() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    Object.defineProperty(_this, \"interactiveChildren\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: true\n    });\n    Object.defineProperty(_this, \"_childLayers\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_children\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: []\n    });\n    return _this;\n  }\n\n  Object.defineProperty(CanvasContainer.prototype, \"_isInteractiveMask\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return this.interactiveChildren || _super.prototype._isInteractiveMask.call(this);\n    }\n  });\n  Object.defineProperty(CanvasContainer.prototype, \"addChild\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (child) {\n      child._parent = this;\n\n      this._children.push(child);\n\n      if (child._layer) {\n        this.registerChildLayer(child._layer);\n      }\n    }\n  });\n  Object.defineProperty(CanvasContainer.prototype, \"addChildAt\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (child, index) {\n      child._parent = this;\n\n      this._children.splice(index, 0, child);\n\n      if (child._layer) {\n        this.registerChildLayer(child._layer);\n      }\n    }\n  });\n  Object.defineProperty(CanvasContainer.prototype, \"removeChild\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (child) {\n      child._parent = undefined;\n      $array.removeFirst(this._children, child);\n    }\n  });\n  Object.defineProperty(CanvasContainer.prototype, \"_render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      var _this = this;\n\n      _super.prototype._render.call(this, parentLayer);\n\n      var renderer = this._renderer;\n\n      if (this.interactive && this.interactiveChildren) {\n        ++renderer._forceInteractive;\n      }\n\n      var layer = this._layer || parentLayer;\n      $array.each(this._children, function (child) {\n        child.compoundAlpha = _this.compoundAlpha * _this.alpha;\n        child.render(layer);\n      });\n\n      if (this.interactive && this.interactiveChildren) {\n        --renderer._forceInteractive;\n      }\n    }\n  });\n  Object.defineProperty(CanvasContainer.prototype, \"registerChildLayer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (layer) {\n      if (!this._childLayers) {\n        this._childLayers = [];\n      }\n\n      $array.pushOne(this._childLayers, layer);\n\n      if (this._parent) {\n        this._parent.registerChildLayer(layer);\n      }\n    }\n  });\n  Object.defineProperty(CanvasContainer.prototype, \"markDirtyLayer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (deep) {\n      if (deep === void 0) {\n        deep = false;\n      }\n\n      _super.prototype.markDirtyLayer.call(this);\n\n      if (deep && this._childLayers) {\n        $array.each(this._childLayers, function (layer) {\n          return layer.dirty = true;\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasContainer.prototype, \"dispose\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      _super.prototype.dispose.call(this);\n\n      if (this._childLayers) {\n        $array.each(this._childLayers, function (layer) {\n          layer.dirty = true;\n        });\n      }\n    }\n  });\n  return CanvasContainer;\n}(CanvasDisplayObject);\n\nexport { CanvasContainer };\n/**\r\n * @ignore\r\n */\n\nfunction setPoint(bounds, point) {\n  bounds.left = Math.min(bounds.left, point.x);\n  bounds.top = Math.min(bounds.top, point.y);\n  bounds.right = Math.max(bounds.right, point.x);\n  bounds.bottom = Math.max(bounds.bottom, point.y);\n}\n/**\r\n * @ignore\r\n */\n\n\nvar Op =\n/** @class */\nfunction () {\n  function Op() {}\n\n  Object.defineProperty(Op.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (_context, _forceColor) {}\n  });\n  Object.defineProperty(Op.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (_context) {}\n  });\n  Object.defineProperty(Op.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (_bounds) {}\n  });\n  return Op;\n}();\n/**\r\n * @ignore\r\n */\n\n\nvar BeginFill =\n/** @class */\nfunction (_super) {\n  __extends(BeginFill, _super);\n\n  function BeginFill(color) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"color\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: color\n    });\n    return _this;\n  }\n\n  Object.defineProperty(BeginFill.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, forceColor) {\n      if (forceColor !== undefined) {\n        context.fillStyle = forceColor;\n      } else {\n        context.fillStyle = this.color;\n      }\n    }\n  });\n  return BeginFill;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar EndFill =\n/** @class */\nfunction (_super) {\n  __extends(EndFill, _super);\n\n  function EndFill(clearShadow) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"clearShadow\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: clearShadow\n    });\n    return _this;\n  }\n\n  Object.defineProperty(EndFill.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, _forceColor) {\n      context.fill();\n\n      if (this.clearShadow) {\n        context.shadowColor = \"\";\n        context.shadowBlur = 0;\n        context.shadowOffsetX = 0;\n        context.shadowOffsetY = 0;\n      }\n    }\n  });\n  return EndFill;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar EndStroke =\n/** @class */\nfunction (_super) {\n  __extends(EndStroke, _super);\n\n  function EndStroke() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  Object.defineProperty(EndStroke.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, _forceColor) {\n      context.stroke();\n    }\n  });\n  return EndStroke;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar LineStyle =\n/** @class */\nfunction (_super) {\n  __extends(LineStyle, _super);\n\n  function LineStyle(width, color, lineJoin) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"width\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: width\n    });\n    Object.defineProperty(_this, \"color\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: color\n    });\n    Object.defineProperty(_this, \"lineJoin\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: lineJoin\n    });\n    return _this;\n  }\n\n  Object.defineProperty(LineStyle.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, forceColor) {\n      if (forceColor !== undefined) {\n        context.strokeStyle = forceColor;\n      } else {\n        context.strokeStyle = this.color;\n      }\n\n      context.lineWidth = this.width;\n\n      if (this.lineJoin) {\n        context.lineJoin = this.lineJoin;\n      }\n    }\n  });\n  return LineStyle;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar LineDash =\n/** @class */\nfunction (_super) {\n  __extends(LineDash, _super);\n\n  function LineDash(dash) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"dash\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: dash\n    });\n    return _this;\n  }\n\n  Object.defineProperty(LineDash.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, _forceColor) {\n      context.setLineDash(this.dash);\n    }\n  });\n  return LineDash;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar LineDashOffset =\n/** @class */\nfunction (_super) {\n  __extends(LineDashOffset, _super);\n\n  function LineDashOffset(dashOffset) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"dashOffset\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: dashOffset\n    });\n    return _this;\n  }\n\n  Object.defineProperty(LineDashOffset.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, _forceColor) {\n      context.lineDashOffset = this.dashOffset;\n    }\n  });\n  return LineDashOffset;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar DrawRect =\n/** @class */\nfunction (_super) {\n  __extends(DrawRect, _super);\n\n  function DrawRect(x, y, width, height) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x\n    });\n    Object.defineProperty(_this, \"y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y\n    });\n    Object.defineProperty(_this, \"width\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: width\n    });\n    Object.defineProperty(_this, \"height\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: height\n    });\n    return _this;\n  }\n\n  Object.defineProperty(DrawRect.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.rect(this.x, this.y, this.width, this.height);\n    }\n  });\n  Object.defineProperty(DrawRect.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      var l = this.x;\n      var t = this.y;\n      var r = l + this.width;\n      var b = t + this.height;\n      setPoint(bounds, {\n        x: l,\n        y: t\n      });\n      setPoint(bounds, {\n        x: r,\n        y: t\n      });\n      setPoint(bounds, {\n        x: l,\n        y: b\n      });\n      setPoint(bounds, {\n        x: r,\n        y: b\n      });\n    }\n  });\n  return DrawRect;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar DrawCircle =\n/** @class */\nfunction (_super) {\n  __extends(DrawCircle, _super);\n\n  function DrawCircle(x, y, radius) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x\n    });\n    Object.defineProperty(_this, \"y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y\n    });\n    Object.defineProperty(_this, \"radius\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: radius\n    });\n    return _this;\n  }\n\n  Object.defineProperty(DrawCircle.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.moveTo(this.x + this.radius, this.y);\n      context.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);\n    }\n  }); // TODO handle skewing and rotation\n\n  Object.defineProperty(DrawCircle.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      setPoint(bounds, {\n        x: this.x - this.radius,\n        y: this.y - this.radius\n      });\n      setPoint(bounds, {\n        x: this.x + this.radius,\n        y: this.y + this.radius\n      });\n    }\n  });\n  return DrawCircle;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar DrawEllipse =\n/** @class */\nfunction (_super) {\n  __extends(DrawEllipse, _super);\n\n  function DrawEllipse(x, y, radiusX, radiusY) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x\n    });\n    Object.defineProperty(_this, \"y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y\n    });\n    Object.defineProperty(_this, \"radiusX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: radiusX\n    });\n    Object.defineProperty(_this, \"radiusY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: radiusY\n    });\n    return _this;\n  }\n\n  Object.defineProperty(DrawEllipse.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.ellipse(0, 0, this.radiusX, this.radiusY, 0, 0, Math.PI * 2);\n    }\n  }); // TODO handle skewing and rotation\n\n  Object.defineProperty(DrawEllipse.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      setPoint(bounds, {\n        x: this.x - this.radiusX,\n        y: this.y - this.radiusY\n      });\n      setPoint(bounds, {\n        x: this.x + this.radiusX,\n        y: this.y + this.radiusY\n      });\n    }\n  });\n  return DrawEllipse;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar Arc =\n/** @class */\nfunction (_super) {\n  __extends(Arc, _super);\n\n  function Arc(cx, cy, radius, startAngle, endAngle, anticlockwise) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"cx\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cx\n    });\n    Object.defineProperty(_this, \"cy\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cy\n    });\n    Object.defineProperty(_this, \"radius\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: radius\n    });\n    Object.defineProperty(_this, \"startAngle\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: startAngle\n    });\n    Object.defineProperty(_this, \"endAngle\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: endAngle\n    });\n    Object.defineProperty(_this, \"anticlockwise\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: anticlockwise\n    });\n    return _this;\n  }\n\n  Object.defineProperty(Arc.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      if (this.radius > 0) {\n        context.arc(this.cx, this.cy, this.radius, this.startAngle, this.endAngle, this.anticlockwise);\n      }\n    }\n  });\n  Object.defineProperty(Arc.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      var arcBounds = $math.getArcBounds(this.cx, this.cy, this.startAngle * $math.DEGREES, this.endAngle * $math.DEGREES, this.radius);\n      setPoint(bounds, {\n        x: arcBounds.left,\n        y: arcBounds.top\n      });\n      setPoint(bounds, {\n        x: arcBounds.right,\n        y: arcBounds.bottom\n      });\n    }\n  });\n  return Arc;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar ArcTo =\n/** @class */\nfunction (_super) {\n  __extends(ArcTo, _super);\n\n  function ArcTo(x1, y1, x2, y2, radius) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"x1\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x1\n    });\n    Object.defineProperty(_this, \"y1\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y1\n    });\n    Object.defineProperty(_this, \"x2\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x2\n    });\n    Object.defineProperty(_this, \"y2\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y2\n    });\n    Object.defineProperty(_this, \"radius\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: radius\n    });\n    return _this;\n  }\n\n  Object.defineProperty(ArcTo.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      if (this.radius > 0) {\n        context.arcTo(this.x1, this.y1, this.x2, this.y2, this.radius);\n      }\n    }\n  }); // TODO: add points\n\n  Object.defineProperty(ArcTo.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (_bounds) {\n      /*\r\n      // not finished\r\n      https://math.stackexchange.com/questions/1781438/finding-the-center-of-a-circle-given-two-points-and-a-radius-algebraically\r\n            if (prevPoint) {\r\n          let x1 = prevPoint.x;\r\n          let y1 = prevPoint.y;\r\n          let x2 = this.x2;\r\n          let y2 = this.y2;\r\n          let r = this.radius;\r\n                let xa = (x2 - x1) / 2;\r\n          let ya = (y2 - y1) / 2;\r\n                let x0 = x1 + xa;\r\n          let y0 = y1 + ya;\r\n                let a = Math.hypot(xa, ya);\r\n          let b = Math.sqrt(r * r - a * a);\r\n                let cx = x0 + b * ya / a;\r\n          let cy = y0 - b * xa / a;\r\n                console.log(cx, cy);\r\n      }*/\n    }\n  });\n  return ArcTo;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar LineTo =\n/** @class */\nfunction (_super) {\n  __extends(LineTo, _super);\n\n  function LineTo(x, y) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x\n    });\n    Object.defineProperty(_this, \"y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y\n    });\n    return _this;\n  }\n\n  Object.defineProperty(LineTo.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.lineTo(this.x, this.y);\n    }\n  });\n  Object.defineProperty(LineTo.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      setPoint(bounds, {\n        x: this.x,\n        y: this.y\n      });\n    }\n  });\n  return LineTo;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar MoveTo =\n/** @class */\nfunction (_super) {\n  __extends(MoveTo, _super);\n\n  function MoveTo(x, y) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x\n    });\n    Object.defineProperty(_this, \"y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y\n    });\n    return _this;\n  }\n\n  Object.defineProperty(MoveTo.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.moveTo(this.x, this.y);\n    }\n  });\n  Object.defineProperty(MoveTo.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      setPoint(bounds, {\n        x: this.x,\n        y: this.y\n      });\n    }\n  });\n  return MoveTo;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar ClosePath =\n/** @class */\nfunction (_super) {\n  __extends(ClosePath, _super);\n\n  function ClosePath() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  Object.defineProperty(ClosePath.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.closePath();\n    }\n  });\n  return ClosePath;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar BezierCurveTo =\n/** @class */\nfunction (_super) {\n  __extends(BezierCurveTo, _super);\n\n  function BezierCurveTo(cpX, cpY, cpX2, cpY2, toX, toY) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"cpX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cpX\n    });\n    Object.defineProperty(_this, \"cpY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cpY\n    });\n    Object.defineProperty(_this, \"cpX2\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cpX2\n    });\n    Object.defineProperty(_this, \"cpY2\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cpY2\n    });\n    Object.defineProperty(_this, \"toX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: toX\n    });\n    Object.defineProperty(_this, \"toY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: toY\n    });\n    return _this;\n  }\n\n  Object.defineProperty(BezierCurveTo.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.bezierCurveTo(this.cpX, this.cpY, this.cpX2, this.cpY2, this.toX, this.toY);\n    }\n  }); // TODO: OK?\n\n  Object.defineProperty(BezierCurveTo.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      setPoint(bounds, {\n        x: this.cpX,\n        y: this.cpY\n      });\n      setPoint(bounds, {\n        x: this.cpX2,\n        y: this.cpY2\n      });\n      setPoint(bounds, {\n        x: this.toX,\n        y: this.toY\n      });\n    }\n  });\n  return BezierCurveTo;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar QuadraticCurveTo =\n/** @class */\nfunction (_super) {\n  __extends(QuadraticCurveTo, _super);\n\n  function QuadraticCurveTo(cpX, cpY, toX, toY) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"cpX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cpX\n    });\n    Object.defineProperty(_this, \"cpY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: cpY\n    });\n    Object.defineProperty(_this, \"toX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: toX\n    });\n    Object.defineProperty(_this, \"toY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: toY\n    });\n    return _this;\n  }\n\n  Object.defineProperty(QuadraticCurveTo.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.quadraticCurveTo(this.cpX, this.cpY, this.toX, this.toY);\n    }\n  }); // TODO: OK?\n\n  Object.defineProperty(QuadraticCurveTo.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      setPoint(bounds, {\n        x: this.cpX,\n        y: this.cpY\n      });\n      setPoint(bounds, {\n        x: this.toX,\n        y: this.toY\n      });\n    }\n  });\n  return QuadraticCurveTo;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar Shadow =\n/** @class */\nfunction (_super) {\n  __extends(Shadow, _super);\n\n  function Shadow(color, blur, offsetX, offsetY, opacity) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"color\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: color\n    });\n    Object.defineProperty(_this, \"blur\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: blur\n    });\n    Object.defineProperty(_this, \"offsetX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: offsetX\n    });\n    Object.defineProperty(_this, \"offsetY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: offsetY\n    });\n    Object.defineProperty(_this, \"opacity\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: opacity\n    });\n    return _this;\n  }\n\n  Object.defineProperty(Shadow.prototype, \"colorize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, _forceColor) {\n      if (this.opacity) {\n        context.fillStyle = this.color;\n      }\n\n      context.shadowColor = this.color;\n      context.shadowBlur = this.blur;\n      context.shadowOffsetX = this.offsetX;\n      context.shadowOffsetY = this.offsetY;\n    }\n  });\n  return Shadow;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar GraphicsImage =\n/** @class */\nfunction (_super) {\n  __extends(GraphicsImage, _super);\n\n  function GraphicsImage(image, width, height, x, y) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"image\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: image\n    });\n    Object.defineProperty(_this, \"width\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: width\n    });\n    Object.defineProperty(_this, \"height\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: height\n    });\n    Object.defineProperty(_this, \"x\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: x\n    });\n    Object.defineProperty(_this, \"y\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: y\n    });\n    return _this;\n  }\n\n  Object.defineProperty(GraphicsImage.prototype, \"path\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.drawImage(this.image, this.x, this.y, this.width, this.height);\n    }\n  }); // TODO: OK?\n\n  Object.defineProperty(GraphicsImage.prototype, \"addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      setPoint(bounds, {\n        x: this.x,\n        y: this.y\n      });\n      setPoint(bounds, {\n        x: this.width,\n        y: this.height\n      });\n    }\n  });\n  return GraphicsImage;\n}(Op);\n/**\r\n * @ignore\r\n */\n\n\nvar CanvasGraphics =\n/** @class */\nfunction (_super) {\n  __extends(CanvasGraphics, _super);\n\n  function CanvasGraphics() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    Object.defineProperty(_this, \"_operations\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: []\n    });\n    Object.defineProperty(_this, \"blendMode\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: BlendMode.NORMAL\n    });\n    Object.defineProperty(_this, \"_hasShadows\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"_fillAlpha\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_strokeAlpha\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    return _this;\n  }\n\n  Object.defineProperty(CanvasGraphics.prototype, \"clear\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      _super.prototype.clear.call(this);\n\n      this._operations.length = 0;\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"_pushOp\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (op) {\n      this._operations.push(op);\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"beginFill\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (color, alpha) {\n      if (alpha === void 0) {\n        alpha = 1;\n      }\n\n      this._fillAlpha = alpha;\n\n      if (color) {\n        if (color instanceof Color) {\n          this._pushOp(new BeginFill(color.toCSS(alpha)));\n        } else {\n          this.isMeasured = true;\n\n          this._pushOp(new BeginFill(color));\n        }\n      } else {\n        this._pushOp(new BeginFill(\"rgba(0, 0, 0, \" + alpha + \")\"));\n      }\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"endFill\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this._pushOp(new EndFill(this._hasShadows));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"endStroke\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this._pushOp(new EndStroke());\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"lineStyle\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (width, color, alpha, lineJoin) {\n      if (width === void 0) {\n        width = 0;\n      }\n\n      if (alpha === void 0) {\n        alpha = 1;\n      }\n\n      this._strokeAlpha = alpha;\n\n      if (color) {\n        if (color instanceof Color) {\n          this._pushOp(new LineStyle(width, color.toCSS(alpha), lineJoin));\n        } else {\n          this._pushOp(new LineStyle(width, color, lineJoin));\n        }\n      } else {\n        this._pushOp(new LineStyle(width, \"rgba(0, 0, 0, \" + alpha + \")\", lineJoin));\n      }\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"setLineDash\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (dash) {\n      this._pushOp(new LineDash(dash ? dash : []));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"setLineDashOffset\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (dashOffset) {\n      if (dashOffset === void 0) {\n        dashOffset = 0;\n      }\n\n      this._pushOp(new LineDashOffset(dashOffset));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"drawRect\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x, y, width, height) {\n      this._pushOp(new DrawRect(x, y, width, height));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"drawCircle\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x, y, radius) {\n      this._pushOp(new DrawCircle(x, y, radius));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"drawEllipse\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x, y, radiusX, radiusY) {\n      this._pushOp(new DrawEllipse(x, y, radiusX, radiusY));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"arc\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (cx, cy, radius, startAngle, endAngle, anticlockwise) {\n      if (anticlockwise === void 0) {\n        anticlockwise = false;\n      }\n\n      this._pushOp(new Arc(cx, cy, radius, startAngle, endAngle, anticlockwise));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"arcTo\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x1, y1, x2, y2, radius) {\n      this._pushOp(new ArcTo(x1, y1, x2, y2, radius));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"lineTo\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x, y) {\n      this._pushOp(new LineTo(x, y));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"moveTo\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x, y) {\n      this._pushOp(new MoveTo(x, y));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"bezierCurveTo\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (cpX, cpY, cpX2, cpY2, toX, toY) {\n      this._pushOp(new BezierCurveTo(cpX, cpY, cpX2, cpY2, toX, toY));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"quadraticCurveTo\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (cpX, cpY, toX, toY) {\n      this._pushOp(new QuadraticCurveTo(cpX, cpY, toX, toY));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"closePath\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      this._pushOp(new ClosePath());\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"shadow\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (color, blur, offsetX, offsetY, opacity) {\n      if (blur === void 0) {\n        blur = 0;\n      }\n\n      if (offsetX === void 0) {\n        offsetX = 0;\n      }\n\n      if (offsetY === void 0) {\n        offsetY = 0;\n      }\n\n      this._hasShadows = true;\n\n      this._pushOp(new Shadow(opacity ? color.toCSS(opacity) : color.toCSS(this._fillAlpha || this._strokeAlpha), blur, offsetX, offsetY));\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"image\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (image, width, height, x, y) {\n      this._pushOp(new GraphicsImage(image, width, height, x, y));\n    }\n  }); // https://svgwg.org/svg2-draft/paths.html#DProperty\n  // TODO better error checking\n\n  Object.defineProperty(CanvasGraphics.prototype, \"svgPath\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (path) {\n      var _this = this;\n\n      var x = 0;\n      var y = 0;\n      var cpx = null;\n      var cpy = null;\n      var qcpx = null;\n      var qcpy = null;\n      var SEGMENTS_REGEXP = /([MmZzLlHhVvCcSsQqTtAa])([^MmZzLlHhVvCcSsQqTtAa]*)/g;\n      var ARGS_REGEXP = /[\\u0009\\u0020\\u000A\\u000C\\u000D]*([\\+\\-]?[0-9]*\\.?[0-9]+(?:[eE][\\+\\-]?[0-9]+)?)[\\u0009\\u0020\\u000A\\u000C\\u000D]*,?/g;\n      var match;\n\n      while ((match = SEGMENTS_REGEXP.exec(path)) !== null) {\n        var name_1 = match[1];\n        var rest = match[2];\n        var args = [];\n\n        while ((match = ARGS_REGEXP.exec(rest)) !== null) {\n          args.push(+match[1]);\n        } // Reset control point\n\n\n        if (name_1 !== \"S\" && name_1 !== \"s\" && name_1 !== \"C\" && name_1 !== \"c\") {\n          cpx = null;\n          cpy = null;\n        } // Reset control point\n\n\n        if (name_1 !== \"Q\" && name_1 !== \"q\" && name_1 !== \"T\" && name_1 !== \"t\") {\n          qcpx = null;\n          qcpy = null;\n        }\n\n        switch (name_1) {\n          case \"M\":\n            checkEvenArgs(name_1, args.length, 2);\n            x = args[0];\n            y = args[1];\n            this.moveTo(x, y);\n\n            for (var i = 2; i < args.length; i += 2) {\n              x = args[i];\n              y = args[i + 1];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"m\":\n            checkEvenArgs(name_1, args.length, 2);\n            x += args[0];\n            y += args[1];\n            this.moveTo(x, y);\n\n            for (var i = 2; i < args.length; i += 2) {\n              x += args[i];\n              y += args[i + 1];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"L\":\n            checkEvenArgs(name_1, args.length, 2);\n\n            for (var i = 0; i < args.length; i += 2) {\n              x = args[i];\n              y = args[i + 1];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"l\":\n            checkEvenArgs(name_1, args.length, 2);\n\n            for (var i = 0; i < args.length; i += 2) {\n              x += args[i];\n              y += args[i + 1];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"H\":\n            checkMinArgs(name_1, args.length, 1);\n\n            for (var i = 0; i < args.length; ++i) {\n              x = args[i];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"h\":\n            checkMinArgs(name_1, args.length, 1);\n\n            for (var i = 0; i < args.length; ++i) {\n              x += args[i];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"V\":\n            checkMinArgs(name_1, args.length, 1);\n\n            for (var i = 0; i < args.length; ++i) {\n              y = args[i];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"v\":\n            checkMinArgs(name_1, args.length, 1);\n\n            for (var i = 0; i < args.length; ++i) {\n              y += args[i];\n              this.lineTo(x, y);\n            }\n\n            break;\n\n          case \"C\":\n            checkEvenArgs(name_1, args.length, 6);\n\n            for (var i = 0; i < args.length; i += 6) {\n              var x1 = args[i];\n              var y1 = args[i + 1];\n              cpx = args[i + 2];\n              cpy = args[i + 3];\n              x = args[i + 4];\n              y = args[i + 5];\n              this.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n            }\n\n            break;\n\n          case \"c\":\n            checkEvenArgs(name_1, args.length, 6);\n\n            for (var i = 0; i < args.length; i += 6) {\n              var x1 = args[i] + x;\n              var y1 = args[i + 1] + y;\n              cpx = args[i + 2] + x;\n              cpy = args[i + 3] + y;\n              x += args[i + 4];\n              y += args[i + 5];\n              this.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n            }\n\n            break;\n\n          case \"S\":\n            checkEvenArgs(name_1, args.length, 4);\n\n            if (cpx === null || cpy === null) {\n              cpx = x;\n              cpy = y;\n            }\n\n            for (var i = 0; i < args.length; i += 4) {\n              var x1 = 2 * x - cpx;\n              var y1 = 2 * y - cpy;\n              cpx = args[i];\n              cpy = args[i + 1];\n              x = args[i + 2];\n              y = args[i + 3];\n              this.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n            }\n\n            break;\n\n          case \"s\":\n            checkEvenArgs(name_1, args.length, 4);\n\n            if (cpx === null || cpy === null) {\n              cpx = x;\n              cpy = y;\n            }\n\n            for (var i = 0; i < args.length; i += 4) {\n              var x1 = 2 * x - cpx;\n              var y1 = 2 * y - cpy;\n              cpx = args[i] + x;\n              cpy = args[i + 1] + y;\n              x += args[i + 2];\n              y += args[i + 3];\n              this.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n            }\n\n            break;\n\n          case \"Q\":\n            checkEvenArgs(name_1, args.length, 4);\n\n            for (var i = 0; i < args.length; i += 4) {\n              qcpx = args[i];\n              qcpy = args[i + 1];\n              x = args[i + 2];\n              y = args[i + 3];\n              this.quadraticCurveTo(qcpx, qcpy, x, y);\n            }\n\n            break;\n\n          case \"q\":\n            checkEvenArgs(name_1, args.length, 4);\n\n            for (var i = 0; i < args.length; i += 4) {\n              qcpx = args[i] + x;\n              qcpy = args[i + 1] + y;\n              x += args[i + 2];\n              y += args[i + 3];\n              this.quadraticCurveTo(qcpx, qcpy, x, y);\n            }\n\n            break;\n\n          case \"T\":\n            checkEvenArgs(name_1, args.length, 2);\n\n            if (qcpx === null || qcpy === null) {\n              qcpx = x;\n              qcpy = y;\n            }\n\n            for (var i = 0; i < args.length; i += 2) {\n              qcpx = 2 * x - qcpx;\n              qcpy = 2 * y - qcpy;\n              x = args[i];\n              y = args[i + 1];\n              this.quadraticCurveTo(qcpx, qcpy, x, y);\n            }\n\n            break;\n\n          case \"t\":\n            checkEvenArgs(name_1, args.length, 2);\n\n            if (qcpx === null || qcpy === null) {\n              qcpx = x;\n              qcpy = y;\n            }\n\n            for (var i = 0; i < args.length; i += 2) {\n              qcpx = 2 * x - qcpx;\n              qcpy = 2 * y - qcpy;\n              x += args[i];\n              y += args[i + 1];\n              this.quadraticCurveTo(qcpx, qcpy, x, y);\n            }\n\n            break;\n\n          case \"A\":\n          case \"a\":\n            var relative = name_1 === \"a\";\n            checkEvenArgs(name_1, args.length, 7);\n\n            for (var i = 0; i < args.length; i += 7) {\n              var cx = args[i + 5];\n              var cy = args[i + 6];\n\n              if (relative) {\n                cx += x;\n                cy += y;\n              }\n\n              var bs = arcToBezier({\n                px: x,\n                py: y,\n                rx: args[i],\n                ry: args[i + 1],\n                xAxisRotation: args[i + 2],\n                largeArcFlag: assertBinary(args[i + 3]),\n                sweepFlag: assertBinary(args[i + 4]),\n                cx: cx,\n                cy: cy\n              });\n              $array.each(bs, function (b) {\n                _this.bezierCurveTo(b.x1, b.y1, b.x2, b.y2, b.x, b.y);\n\n                x = b.x;\n                y = b.y;\n              });\n            }\n\n            break;\n\n          case \"Z\":\n          case \"z\":\n            checkArgs(name_1, args.length, 0);\n            this.closePath();\n            break;\n        }\n      }\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"_runPath\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      context.beginPath();\n      $array.each(this._operations, function (op) {\n        op.path(context);\n      });\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"_render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      _super.prototype._render.call(this, parentLayer);\n\n      var layer = this._layer || parentLayer;\n      var layerDirty = layer.dirty;\n\n      var interactive = this._isInteractive();\n\n      if (layerDirty || interactive) {\n        var context_1 = layer.context;\n        var ghostContext_1 = this._renderer._ghostContext;\n\n        if (layerDirty) {\n          context_1.globalCompositeOperation = this.blendMode;\n          context_1.beginPath();\n        }\n\n        var color_1;\n\n        if (interactive) {\n          ghostContext_1.beginPath();\n          color_1 = this._getColorId();\n        }\n\n        $array.each(this._operations, function (op) {\n          if (layerDirty) {\n            op.path(context_1);\n            op.colorize(context_1, undefined);\n          }\n\n          if (interactive) {\n            op.path(ghostContext_1);\n            op.colorize(ghostContext_1, color_1);\n          }\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"renderDetached\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      if (this.visible) {\n        this._setMatrix();\n\n        context.save(); // We must apply the mask before we transform the element\n\n        var mask = this.mask;\n\n        if (mask) {\n          mask._setMatrix();\n\n          mask._transform(context, 1);\n\n          mask._runPath(context);\n\n          context.clip();\n        } // TODO handle compoundAlpha somehow ?\n\n\n        context.globalAlpha = this.compoundAlpha * this.alpha;\n\n        this._transform(context, 1);\n\n        if (this.filter) {\n          context.filter = this.filter;\n        }\n\n        context.globalCompositeOperation = this.blendMode;\n        context.beginPath();\n        $array.each(this._operations, function (op) {\n          op.path(context);\n          op.colorize(context, undefined);\n        });\n        context.restore();\n      }\n    }\n  });\n  Object.defineProperty(CanvasGraphics.prototype, \"_addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      if (this.visible && this.isMeasured) {\n        $array.each(this._operations, function (op) {\n          op.addBounds(bounds);\n        });\n      }\n    }\n  });\n  return CanvasGraphics;\n}(CanvasDisplayObject);\n\nexport { CanvasGraphics };\n/**\r\n * @ignore\r\n */\n\nvar CanvasText =\n/** @class */\nfunction (_super) {\n  __extends(CanvasText, _super);\n\n  function CanvasText(renderer, text, style) {\n    var _this = _super.call(this, renderer) || this;\n\n    Object.defineProperty(_this, \"text\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"style\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"resolution\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 1\n    });\n    Object.defineProperty(_this, \"_textInfo\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_textVisible\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: true\n    });\n    Object.defineProperty(_this, \"_originalScale\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 1\n    });\n    _this.text = text;\n    _this.style = style;\n    return _this;\n  }\n\n  Object.defineProperty(CanvasText.prototype, \"invalidateBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      _super.prototype.invalidateBounds.call(this);\n\n      this._textInfo = undefined;\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_shared\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context) {\n      if (this.style.textAlign) {\n        context.textAlign = this.style.textAlign;\n      }\n\n      if (this.style.direction) {\n        context.direction = this.style.direction;\n      }\n\n      if (this.style.textBaseline) {\n        context.textBaseline = this.style.textBaseline;\n      }\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_prerender\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (layer, ignoreGhost, ignoreFontWeight) {\n      if (ignoreGhost === void 0) {\n        ignoreGhost = false;\n      }\n\n      if (ignoreFontWeight === void 0) {\n        ignoreFontWeight = false;\n      }\n\n      _super.prototype._render.call(this, layer);\n\n      var context = layer.context;\n      var ghostContext = this._renderer._ghostContext; // Font style\n\n      var style = this.style;\n\n      var fontStyle = this._getFontStyle(undefined, ignoreFontWeight);\n\n      context.font = fontStyle;\n\n      if (this._isInteractive() && !ignoreGhost) {\n        ghostContext.font = fontStyle;\n      } // Other parameters\n\n\n      if (style.fill) {\n        if (style.fill instanceof Color) {\n          context.fillStyle = style.fill.toCSS();\n        } else {\n          context.fillStyle = style.fill;\n        }\n      }\n\n      if (style.shadowColor) {\n        layer.context.shadowColor = style.shadowColor.toCSS(style.shadowOpacity || 1);\n      }\n\n      if (style.shadowBlur) {\n        layer.context.shadowBlur = style.shadowBlur;\n      }\n\n      if (style.shadowOffsetX) {\n        layer.context.shadowOffsetX = style.shadowOffsetX;\n      }\n\n      if (style.shadowOffsetY) {\n        layer.context.shadowOffsetY = style.shadowOffsetY;\n      }\n\n      this._shared(context);\n\n      if (this._isInteractive() && !ignoreGhost) {\n        ghostContext.fillStyle = this._getColorId();\n\n        this._shared(ghostContext);\n      }\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_getFontStyle\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (style2, ignoreFontWeight) {\n      if (ignoreFontWeight === void 0) {\n        ignoreFontWeight = false;\n      } // Process defaults\n\n\n      var style = this.style;\n      var fontStyle = [];\n\n      if (style2 && style2.fontVariant) {\n        fontStyle.push(style2.fontVariant);\n      } else if (style.fontVariant) {\n        fontStyle.push(style.fontVariant);\n      }\n\n      if (!ignoreFontWeight) {\n        if (style2 && style2.fontWeight) {\n          fontStyle.push(style2.fontWeight);\n        } else if (style.fontWeight) {\n          fontStyle.push(style.fontWeight);\n        }\n      }\n\n      if (style2 && style2.fontStyle) {\n        fontStyle.push(style2.fontStyle);\n      } else if (style.fontStyle) {\n        fontStyle.push(style.fontStyle);\n      }\n\n      if (style2 && style2.fontSize) {\n        if ($type.isNumber(style2.fontSize)) {\n          style2.fontSize = style2.fontSize + \"px\";\n        }\n\n        fontStyle.push(style2.fontSize);\n      } else if (style.fontSize) {\n        if ($type.isNumber(style.fontSize)) {\n          style.fontSize = style.fontSize + \"px\";\n        }\n\n        fontStyle.push(style.fontSize);\n      }\n\n      if (style2 && style2.fontFamily) {\n        fontStyle.push(style2.fontFamily);\n      } else if (style.fontFamily) {\n        fontStyle.push(style.fontFamily);\n      } else if (fontStyle.length) {\n        fontStyle.push(\"Arial\");\n      }\n\n      return fontStyle.join(\" \");\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      var _this = this;\n\n      var layer = this._layer || parentLayer; // We need measurements in order to properly position text for alignment\n\n      if (!this._textInfo) {\n        this._measure(layer);\n      }\n\n      if (this._textVisible) {\n        var interactive_1 = this._isInteractive();\n\n        var context_2 = layer.context;\n        var layerDirty_1 = layer.dirty;\n        var ghostContext_2 = this._renderer._ghostContext;\n        context_2.save();\n        ghostContext_2.save();\n\n        this._prerender(layer); // const lines = this.text.toString().replace(/\\r/g, \"\").split(/\\n/);\n        // const x = this._localBounds && (this._localBounds.left < 0) ? Math.abs(this._localBounds.left) : 0;\n        // Process text info produced by _measure()\n\n\n        $array.each(this._textInfo, function (line, _index) {\n          $array.each(line.textChunks, function (chunk, _index) {\n            // Set style\n            if (chunk.style) {\n              context_2.save();\n              ghostContext_2.save();\n              context_2.font = chunk.style;\n\n              if (_this._isInteractive()) {\n                ghostContext_2.font = chunk.style;\n              }\n            }\n\n            if (chunk.fill) {\n              context_2.save();\n              context_2.fillStyle = chunk.fill.toCSS(); // Color does not affect ghostContext so we not set it\n            } // Draw text\n\n\n            if (layerDirty_1) {\n              context_2.fillText(chunk.text, chunk.offsetX, line.offsetY + chunk.offsetY);\n            } // Draw underline\n\n\n            if (chunk.textDecoration == \"underline\" || chunk.textDecoration == \"line-through\") {\n              var thickness = 1;\n              var offset = 1;\n              var fontSize = chunk.height;\n              var offsetX = chunk.offsetX;\n\n              switch (_this.style.textAlign) {\n                case \"right\":\n                case \"end\":\n                  offsetX -= chunk.width;\n                  break;\n\n                case \"center\":\n                  offsetX -= chunk.width / 2;\n                  break;\n              }\n\n              if (chunk.style) {\n                var format = TextFormatter.getTextStyle(chunk.style);\n\n                switch (format.fontWeight) {\n                  case \"bolder\":\n                  case \"bold\":\n                  case \"700\":\n                  case \"800\":\n                  case \"900\":\n                    thickness = 2;\n                    break;\n                }\n              }\n\n              if (fontSize) {\n                offset = fontSize / 20;\n              }\n\n              var y = void 0;\n\n              if (chunk.textDecoration == \"line-through\") {\n                y = thickness + line.offsetY + chunk.offsetY - chunk.height / 2;\n              } else {\n                y = thickness + offset * 1.5 + line.offsetY + chunk.offsetY;\n              }\n\n              context_2.save();\n              context_2.beginPath();\n\n              if (chunk.fill) {\n                context_2.strokeStyle = chunk.fill.toCSS();\n              } else if (_this.style.fill && _this.style.fill instanceof Color) {\n                context_2.strokeStyle = _this.style.fill.toCSS();\n              }\n\n              context_2.lineWidth = thickness * offset;\n              context_2.moveTo(offsetX, y);\n              context_2.lineTo(offsetX + chunk.width, y);\n              context_2.stroke();\n              context_2.restore();\n            }\n\n            if (interactive_1 && _this.interactive) {\n              // Draw text in ghost canvas ONLY if it is set as interactive\n              // explicitly. This way we avoid hit test anomalies caused by anti\n              // aliasing of text.\n              ghostContext_2.fillText(chunk.text, chunk.offsetX, line.offsetY + chunk.offsetY);\n            }\n\n            if (chunk.fill) {\n              context_2.restore(); // Color does not affect ghostContext so we not set it\n            } // Reset style\n\n\n            if (chunk.style) {\n              context_2.restore();\n              ghostContext_2.restore();\n            }\n          });\n        });\n        context_2.restore();\n        ghostContext_2.restore();\n      }\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_addBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      if (this.visible && this.isMeasured) {\n        //if (this._textVisible) {\n        var x = this._measure(this.getLayer());\n\n        setPoint(bounds, {\n          x: x.left,\n          y: x.top\n        });\n        setPoint(bounds, {\n          x: x.right,\n          y: x.bottom\n        }); //}\n      }\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_measure\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (layer) {\n      var _this = this;\n\n      var context = layer.context;\n      var ghostContext = this._renderer._ghostContext;\n      var rtl = this.style.direction == \"rtl\"; // Reset text info\n\n      this._textInfo = []; // Init\n\n      var oversizedBehavior = this.style.oversizedBehavior;\n      var maxWidth = this.style.maxWidth;\n      var truncate = $type.isNumber(maxWidth) && oversizedBehavior == \"truncate\";\n      var wrap = $type.isNumber(maxWidth) && (oversizedBehavior == \"wrap\" || oversizedBehavior == \"wrap-no-break\"); // Pre-render\n\n      context.save();\n      ghostContext.save();\n\n      this._prerender(layer, true, true); // Get default font metrix\n\n\n      var refText = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 \"; // Split up text into lines\n\n      var lines = this.text.toString().replace(/\\r/g, \"\").split(/\\n/);\n      var styleRestored = true;\n      var minX = 0;\n      var maxX = 0; // Iterate through the lines\n\n      var offsetY = 0;\n      var currentStyle;\n      $array.each(lines, function (line, _index) {\n        // Split up line into format/value chunks\n        var chunks;\n\n        if (line == \"\") {\n          chunks = [{\n            type: \"value\",\n            text: \"\"\n          }];\n        } else {\n          chunks = TextFormatter.chunk(line, false, _this.style.ignoreFormatting);\n        }\n\n        var _loop_1 = function () {\n          // Init line object\n          var lineInfo = {\n            offsetY: offsetY,\n            ascent: 0,\n            width: 0,\n            height: 0,\n            left: 0,\n            right: 0,\n            textChunks: []\n          }; // Measure reference text\n\n          var metrics = _this._measureText(refText, context);\n\n          var height = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;\n          lineInfo.height = height;\n          lineInfo.ascent = metrics.actualBoundingBoxAscent;\n          var currentFormat;\n          var currentDecoration = _this.style.textDecoration;\n          var currentFill;\n          var currentChunkWidth;\n          var skipFurtherText = false;\n          var firstTextChunk = true;\n          var leftoverChunks = [];\n          var currentVerticalAlign; //let offsetX = 0;\n          //let chunk;\n          //while(chunk = chunks.shift()) {\n\n          $array.eachContinue(chunks, function (chunk, index) {\n            // Format chunk\n            if (chunk.type == \"format\") {\n              if (chunk.text == \"[/]\") {\n                if (!styleRestored) {\n                  context.restore();\n                  ghostContext.restore();\n                  styleRestored = true;\n                }\n\n                currentFill = undefined;\n                currentStyle = undefined;\n                currentChunkWidth = undefined;\n                currentDecoration = _this.style.textDecoration;\n                currentVerticalAlign = undefined;\n                currentFormat = chunk.text;\n              } else {\n                if (!styleRestored) {\n                  context.restore();\n                  ghostContext.restore();\n                }\n\n                var format = TextFormatter.getTextStyle(chunk.text);\n\n                var fontStyle = _this._getFontStyle(format);\n\n                context.save();\n                ghostContext.save();\n                context.font = fontStyle;\n                currentStyle = fontStyle;\n                currentFormat = chunk.text;\n\n                if (format.textDecoration) {\n                  currentDecoration = format.textDecoration;\n                }\n\n                if (format.fill) {\n                  currentFill = format.fill;\n                }\n\n                if (format.width) {\n                  currentChunkWidth = $type.toNumber(format.width);\n                }\n\n                if (format.verticalAlign) {\n                  currentVerticalAlign = format.verticalAlign;\n                }\n\n                styleRestored = false; // Measure reference text after change of format\n\n                var metrics_1 = _this._measureText(refText, context);\n\n                var height_1 = metrics_1.actualBoundingBoxAscent + metrics_1.actualBoundingBoxDescent;\n\n                if (height_1 > lineInfo.height) {\n                  lineInfo.height = height_1;\n                }\n\n                if (metrics_1.actualBoundingBoxAscent > lineInfo.ascent) {\n                  lineInfo.ascent = metrics_1.actualBoundingBoxAscent;\n                }\n              }\n            } // Text chunk\n            else if (chunk.type == \"value\" && !skipFurtherText) {\n              // Measure\n              var metrics_2 = _this._measureText(chunk.text, context);\n\n              var chunkWidth = metrics_2.actualBoundingBoxLeft + metrics_2.actualBoundingBoxRight; // Check for fit\n\n              if (truncate) {\n                // Break words?\n                var breakWords = firstTextChunk || _this.style.breakWords || false; // Measure ellipsis and check if it fits\n\n                var ellipsis = _this.style.ellipsis || \"\";\n\n                var ellipsisMetrics = _this._measureText(ellipsis, context);\n\n                var ellipsisWidth = ellipsisMetrics.actualBoundingBoxLeft + ellipsisMetrics.actualBoundingBoxRight; // Check fit\n\n                if (lineInfo.width + chunkWidth > maxWidth) {\n                  var excessWidth = maxWidth - lineInfo.width - ellipsisWidth;\n                  chunk.text = _this._truncateText(context, chunk.text, excessWidth, breakWords);\n                  chunk.text += ellipsis;\n                  skipFurtherText = true;\n                }\n              } else if (wrap) {\n                // Check fit\n                if (lineInfo.width + chunkWidth > maxWidth) {\n                  var excessWidth = maxWidth - lineInfo.width;\n\n                  var tmpText = _this._truncateText(context, chunk.text, excessWidth, false, firstTextChunk && _this.style.oversizedBehavior != \"wrap-no-break\");\n\n                  if (tmpText == \"\") {\n                    // Unable to fit a single letter - hide the whole label\n                    _this._textVisible = true;\n                    return false;\n                  } //skipFurtherText = true;\n                  //Add remaining chunks for the next line\n\n\n                  leftoverChunks = chunks.slice(index + 1); //Add remaining text of current chunk if it was forced-cut\n\n                  if ($utils.trim(tmpText) != $utils.trim(chunk.text)) {\n                    leftoverChunks.unshift({\n                      type: \"value\",\n                      text: chunk.text.substr(tmpText.length)\n                    });\n\n                    if (currentFormat) {\n                      leftoverChunks.unshift({\n                        type: \"format\",\n                        text: currentFormat\n                      });\n                    }\n                  } // Set current chunk (truncated)\n\n\n                  chunk.text = $utils.trim(tmpText);\n                  chunks = [];\n                  skipFurtherText = true;\n                }\n              } // Chunk width?\n\n\n              var leftBoundMod = 1;\n              var rightBoundMod = 1;\n\n              if (currentStyle && currentChunkWidth && currentChunkWidth > chunkWidth) {\n                // increase horizontal bounding boxes accordingly\n                var boundsMod = chunkWidth / currentChunkWidth;\n\n                switch (_this.style.textAlign) {\n                  case \"right\":\n                  case \"end\":\n                    leftBoundMod = boundsMod;\n                    break;\n\n                  case \"center\":\n                    leftBoundMod = boundsMod;\n                    rightBoundMod = boundsMod;\n                    break;\n\n                  default:\n                    rightBoundMod = boundsMod;\n                }\n\n                chunkWidth = currentChunkWidth;\n              }\n\n              var chunkHeight = metrics_2.actualBoundingBoxAscent + metrics_2.actualBoundingBoxDescent;\n\n              if (chunkHeight > lineInfo.height) {\n                lineInfo.height = chunkHeight;\n              }\n\n              if (metrics_2.actualBoundingBoxAscent > lineInfo.ascent) {\n                lineInfo.ascent = metrics_2.actualBoundingBoxAscent;\n              }\n\n              lineInfo.width += chunkWidth;\n              lineInfo.left += metrics_2.actualBoundingBoxLeft / leftBoundMod;\n              lineInfo.right += metrics_2.actualBoundingBoxRight / rightBoundMod;\n              lineInfo.textChunks.push({\n                style: currentStyle,\n                fill: currentFill,\n                text: chunk.text,\n                width: chunkWidth,\n                height: chunkHeight,\n                left: metrics_2.actualBoundingBoxLeft,\n                right: metrics_2.actualBoundingBoxRight,\n                ascent: metrics_2.actualBoundingBoxAscent,\n                offsetX: 0,\n                offsetY: 0,\n                textDecoration: currentDecoration,\n                verticalAlign: currentVerticalAlign\n              }); //offsetX += chunkWidth;\n\n              firstTextChunk = false;\n            }\n\n            if (leftoverChunks) {//return false;\n            }\n\n            return true; //}\n          });\n\n          if (_this.style.lineHeight instanceof Percent) {\n            lineInfo.height *= _this.style.lineHeight.value;\n            lineInfo.ascent *= _this.style.lineHeight.value;\n          } else {\n            lineInfo.height *= _this.style.lineHeight || 1.2;\n            lineInfo.ascent *= _this.style.lineHeight || 1.2;\n          }\n\n          if (minX < lineInfo.left) {\n            minX = lineInfo.left;\n          }\n\n          if (maxX < lineInfo.right) {\n            maxX = lineInfo.right;\n          }\n\n          _this._textInfo.push(lineInfo); //lineInfo.offsetY += lineInfo.ascent;\n\n\n          offsetY += lineInfo.height; // Reset chunks so that it can proceed to the next line\n\n          chunks = leftoverChunks || [];\n        };\n\n        while (chunks.length > 0) {\n          _loop_1();\n        }\n      });\n\n      if (!styleRestored) {\n        context.restore();\n        ghostContext.restore();\n      } // Adjust chunk internal offsets\n\n\n      $array.each(this._textInfo, function (lineInfo, _index) {\n        var currentChunkOffset = 0;\n        $array.each(lineInfo.textChunks, function (chunk) {\n          chunk.offsetX = currentChunkOffset + chunk.left - lineInfo.left;\n          chunk.offsetY += lineInfo.height - lineInfo.height * (_this.style.baselineRatio || 0.19);\n          currentChunkOffset += chunk.width;\n\n          if (chunk.verticalAlign) {\n            switch (chunk.verticalAlign) {\n              case \"super\":\n                chunk.offsetY -= lineInfo.height / 2 - chunk.height / 2;\n                break;\n\n              case \"sub\":\n                chunk.offsetY += chunk.height / 2;\n                break;\n            }\n          }\n        });\n      });\n      var bounds = {\n        left: rtl ? -maxX : -minX,\n        top: 0,\n        right: rtl ? minX : maxX,\n        bottom: offsetY\n      }; // We need to fit?\n\n      if (oversizedBehavior !== \"none\") {\n        var ratio = this._fitRatio(bounds);\n\n        if (ratio < 1) {\n          if (oversizedBehavior == \"fit\") {\n            if ($type.isNumber(this.style.minScale) && ratio < this.style.minScale) {\n              this._textVisible = false;\n            } else {\n              if (!this._originalScale || this._originalScale == 1) {\n                this._originalScale = this.scale;\n              }\n\n              this.scale = ratio;\n              this._textVisible = true;\n            }\n          } else if (oversizedBehavior == \"hide\") {\n            this._textVisible = false;\n          } else {\n            switch (this.style.textAlign) {\n              case \"right\":\n              case \"end\":\n                bounds.left = -maxWidth;\n                bounds.right = 0;\n                break;\n\n              case \"center\":\n                bounds.left = -maxWidth / 2;\n                bounds.right = maxWidth / 2;\n                break;\n\n              default:\n                bounds.left = 0;\n                bounds.right = maxWidth;\n            }\n\n            this.scale = this._originalScale || 1;\n            this._originalScale = undefined;\n            this._textVisible = true;\n          }\n        } else {\n          this.scale = this._originalScale || 1;\n          this._originalScale = undefined;\n          this._textVisible = true;\n        }\n      }\n\n      context.restore();\n      ghostContext.restore();\n      return bounds;\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_fitRatio\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (bounds) {\n      var maxW = this.style.maxWidth;\n      var maxH = this.style.maxHeight;\n\n      if (!$type.isNumber(maxW) && !$type.isNumber(maxH)) {\n        return 1;\n      }\n\n      var w = bounds.right - bounds.left;\n      var h = bounds.bottom - bounds.top;\n      return Math.min(maxW / w || 1, maxH / h || 1);\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_truncateText\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (context, text, maxWidth, breakWords, fallbackBreakWords) {\n      if (breakWords === void 0) {\n        breakWords = false;\n      }\n\n      if (fallbackBreakWords === void 0) {\n        fallbackBreakWords = true;\n      }\n\n      var width;\n\n      do {\n        if (breakWords) {\n          text = text.slice(0, -1);\n        } else {\n          var tmp = text.replace(/[^,;:!?\\\\\\/\\s]+[,;:!?\\\\\\/\\s]*$/g, \"\");\n\n          if (tmp == \"\" && fallbackBreakWords) {\n            breakWords = true;\n          } else if (tmp == \"\") {\n            return text;\n          } else {\n            text = tmp;\n          }\n        }\n\n        var metrics = this._measureText(text, context);\n\n        width = metrics.actualBoundingBoxLeft + metrics.actualBoundingBoxRight;\n      } while (width > maxWidth && text != \"\");\n\n      return text;\n    }\n  });\n  Object.defineProperty(CanvasText.prototype, \"_measureText\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (text, context) {\n      var metrics = context.measureText(text);\n      var fakeMetrics = {};\n\n      if (metrics.actualBoundingBoxAscent == null) {\n        var div = document.createElement(\"div\");\n        div.innerText = text;\n        div.style.visibility = \"hidden\";\n        div.style.position = \"absolute\";\n        div.style.top = \"-1000000px;\";\n        div.style.fontFamily = this.style.fontFamily || \"\";\n        div.style.fontSize = this.style.fontSize + \"\";\n        document.body.appendChild(div);\n        var bbox = div.getBoundingClientRect();\n        document.body.removeChild(div);\n        var h = bbox.height;\n        var w_1 = metrics.width;\n        var left = 0;\n        var right = w_1;\n        fakeMetrics = {\n          actualBoundingBoxAscent: h,\n          actualBoundingBoxDescent: 0,\n          actualBoundingBoxLeft: left,\n          actualBoundingBoxRight: right,\n          fontBoundingBoxAscent: h,\n          fontBoundingBoxDescent: 0,\n          width: w_1\n        }; //return fake;\n      } else {\n        fakeMetrics = {\n          actualBoundingBoxAscent: metrics.actualBoundingBoxAscent,\n          actualBoundingBoxDescent: metrics.actualBoundingBoxDescent,\n          actualBoundingBoxLeft: metrics.actualBoundingBoxLeft,\n          actualBoundingBoxRight: metrics.actualBoundingBoxRight,\n          fontBoundingBoxAscent: metrics.actualBoundingBoxAscent,\n          fontBoundingBoxDescent: metrics.actualBoundingBoxDescent,\n          width: metrics.width\n        };\n      }\n\n      var w = metrics.width;\n\n      switch (this.style.textAlign) {\n        case \"right\":\n        case \"end\":\n          fakeMetrics.actualBoundingBoxLeft = w;\n          fakeMetrics.actualBoundingBoxRight = 0;\n          break;\n\n        case \"center\":\n          fakeMetrics.actualBoundingBoxLeft = w / 2;\n          fakeMetrics.actualBoundingBoxRight = w / 2;\n          break;\n\n        default:\n          fakeMetrics.actualBoundingBoxLeft = 0;\n          fakeMetrics.actualBoundingBoxRight = w;\n      }\n\n      return fakeMetrics;\n    }\n  });\n  return CanvasText;\n}(CanvasDisplayObject);\n\nexport { CanvasText };\n/**\r\n * @ignore\r\n */\n\nvar CanvasTextStyle =\n/** @class */\nfunction () {\n  function CanvasTextStyle() {\n    //public wordWrapWidth: number = 100;\n    Object.defineProperty(this, \"fill\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"textAlign\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"fontFamily\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"fontSize\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"fontWeight\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"fontStyle\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"fontVariant\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"textDecoration\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"shadowColor\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"shadowBlur\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"shadowOffsetX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"shadowOffsetY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"shadowOpacity\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    }); // leading?: number;\n    // letterSpacing?: number;\n\n    Object.defineProperty(this, \"lineHeight\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: percent(120)\n    });\n    Object.defineProperty(this, \"baselineRatio\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0.19\n    }); // padding?: number;\n    // stroke?: number;\n    // strokeThickness?: number;\n    // trim?: number;\n    // wordWrap?: boolean;\n\n    Object.defineProperty(this, \"direction\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"textBaseline\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"oversizedBehavior\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: \"none\"\n    });\n    Object.defineProperty(this, \"breakWords\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(this, \"ellipsis\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: \"…\"\n    });\n    Object.defineProperty(this, \"maxWidth\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"maxHeight\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"minScale\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"ignoreFormatting\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n  }\n\n  return CanvasTextStyle;\n}();\n\nexport { CanvasTextStyle };\n/**\r\n * @ignore\r\n */\n\nvar CanvasRadialText =\n/** @class */\nfunction (_super) {\n  __extends(CanvasRadialText, _super);\n\n  function CanvasRadialText() {\n    var _this = _super !== null && _super.apply(this, arguments) || this;\n\n    Object.defineProperty(_this, \"textType\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: \"circular\"\n    });\n    Object.defineProperty(_this, \"radius\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"startAngle\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"inside\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"orientation\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: \"auto\"\n    });\n    Object.defineProperty(_this, \"kerning\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"_textReversed\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    return _this;\n  }\n\n  Object.defineProperty(CanvasRadialText.prototype, \"_render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      switch (this.textType) {\n        case \"circular\":\n          this._renderCircular(parentLayer);\n\n          break;\n\n        default:\n          _super.prototype._render.call(this, parentLayer);\n\n          break;\n      }\n    }\n  });\n  Object.defineProperty(CanvasRadialText.prototype, \"_renderCircular\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      var layer = this._layer || parentLayer;\n\n      this._prerender(layer);\n\n      var interactive = this._isInteractive();\n\n      var context = layer.context;\n      var layerDirty = layer.dirty;\n      var ghostContext = this._renderer._ghostContext; // Savepoint\n\n      context.save();\n\n      if (interactive) {\n        ghostContext.save();\n      } // Init\n\n\n      var radius = this.radius || 0;\n      var startAngle = this.startAngle || 0;\n      var deltaAngle = 0;\n      var orientation = this.orientation;\n      var inward = orientation == \"auto\" ? \"auto\" : orientation == \"inward\";\n      var inside = this.inside;\n      var align = this.style.textAlign || \"left\";\n      var kerning = this.kerning || 0;\n      var clockwise = align == \"left\" ? 1 : -1;\n      var shouldReverse = !this._textReversed; // We need measurements in order to properly position text for alignment\n\n      if (!this._textInfo) {\n        this._measure(layer);\n      } // Check if we need to invert the whole stuff\n\n\n      if (inward == \"auto\") {\n        // Calc max angle so we know whether we need to flip it\n        var maxAngle_1 = 0;\n        var midAngle = 0;\n        $array.each(this._textInfo, function (line, _index) {\n          var deltaAngle = startAngle + line.width / (radius - line.height) / 2 * -clockwise;\n\n          if (deltaAngle > maxAngle_1) {\n            maxAngle_1 = deltaAngle;\n          }\n        });\n\n        if (align == \"left\") {\n          midAngle = (maxAngle_1 + deltaAngle / 2) * $math.DEGREES;\n        } else if (align == \"right\") {\n          midAngle = (maxAngle_1 - deltaAngle / 2) * $math.DEGREES;\n        } else {\n          midAngle = startAngle * $math.DEGREES;\n        }\n\n        midAngle = $math.normalizeAngle(midAngle);\n        inward = midAngle >= 270 || midAngle <= 90;\n      }\n\n      if (inward == true && shouldReverse) {\n        this._textInfo.reverse();\n\n        this._textReversed = true;\n      } // if ((inward == false && align == \"left\") || (inward == true && align == \"right\")) {\n      // \tclockwise *= -1;\n      // }\n      // Process text info produced by _measure()\n\n\n      $array.each(this._textInfo, function (line, _index) {\n        var textHeight = line.height; // Adjust radius (for `inside = false`)\n        // Radius adjustment for `inside = false` is below the line calculation\n\n        if (!inside) {\n          radius += textHeight;\n        } // Reverse letters if we're painting them counter-clockwise\n\n\n        if ((clockwise == -1 && inward || clockwise == 1 && !inward) && shouldReverse) {\n          line.textChunks.reverse();\n        } // Init angles\n\n\n        var lineStartAngle = startAngle;\n        deltaAngle = 0; // Adjust for center-align\n\n        if (align == \"center\") {\n          lineStartAngle += line.width / (radius - textHeight) / 2 * -clockwise;\n          deltaAngle = lineStartAngle - startAngle;\n        } // if (inward == \"auto\") {\n        // \tlet midAngle;\n        // \tif (align == \"left\") {\n        // \t\tmidAngle = (lineStartAngle + deltaAngle / 2) * $math.DEGREES;\n        // \t}\n        // \telse if () {\n        // \t\tmidAngle = (lineStartAngle - deltaAngle / 2) * $math.DEGREES;\n        // \t}\n        // \tinward = (midAngle >= 270) || (midAngle <= 90);\n        // }\n        // Rotate letters if they are facing outward\n\n\n        lineStartAngle += Math.PI * (inward ? 0 : 1); // Rotate 180 if outward\n        // Savepoint\n\n        context.save();\n\n        if (interactive) {\n          ghostContext.save();\n        } // Assume starting angle\n\n\n        context.rotate(lineStartAngle);\n\n        if (interactive) {\n          ghostContext.rotate(lineStartAngle);\n        }\n\n        var angleShift = 0;\n        $array.each(line.textChunks, function (chunk, _index) {\n          // Draw the letter\n          var char = chunk.text;\n          var charWidth = chunk.width; // Rotate half a letter\n\n          angleShift = charWidth / 2 / (radius - textHeight) * clockwise;\n          context.rotate(angleShift);\n\n          if (interactive) {\n            ghostContext.rotate(angleShift);\n          } // Set style\n\n\n          if (chunk.style) {\n            context.save();\n            ghostContext.save();\n            context.font = chunk.style;\n\n            if (interactive) {\n              ghostContext.font = chunk.style;\n            }\n          }\n\n          if (chunk.fill) {\n            context.save();\n            context.fillStyle = chunk.fill.toCSS(); // Color does not affect ghostContext so we not set it\n          } // Center letters\n\n\n          context.textBaseline = \"middle\";\n          context.textAlign = \"center\";\n\n          if (interactive) {\n            ghostContext.textBaseline = \"middle\";\n            ghostContext.textAlign = \"center\";\n          } // Plop the letter\n\n\n          if (layerDirty) {\n            context.fillText(char, 0, (inward ? 1 : -1) * (0 - radius + textHeight / 2));\n          }\n\n          if (interactive) {\n            ghostContext.fillText(char, 0, (inward ? 1 : -1) * (0 - radius + textHeight / 2));\n          }\n\n          if (chunk.fill) {\n            context.restore(); // Color does not affect ghostContext so we not set it\n          } // Reset style\n\n\n          if (chunk.style) {\n            context.restore();\n            ghostContext.restore();\n          } // Rotate half a letter and add spacing\n\n\n          angleShift = (charWidth / 2 + kerning) / (radius - textHeight) * clockwise;\n          context.rotate(angleShift);\n\n          if (interactive) {\n            ghostContext.rotate(angleShift);\n          }\n        }); // Restore angle\n\n        context.restore();\n\n        if (interactive) {\n          ghostContext.restore();\n        } // Adjust radius (for `inside = true`)\n\n\n        if (inside) {\n          radius -= textHeight;\n        }\n      }); // Restore\n\n      context.restore();\n\n      if (interactive) {\n        ghostContext.restore();\n      }\n    }\n  });\n  Object.defineProperty(CanvasRadialText.prototype, \"_measure\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (layer) {\n      switch (this.textType) {\n        case \"circular\":\n          return this._measureCircular(layer);\n\n        default:\n          return _super.prototype._measure.call(this, layer);\n      }\n    }\n  });\n  Object.defineProperty(CanvasRadialText.prototype, \"_measureCircular\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (layer) {\n      var _this = this;\n\n      var context = layer.context;\n      var ghostContext = this._renderer._ghostContext;\n      var rtl = this.style.direction == \"rtl\"; // Reset text info\n\n      this._textInfo = [];\n      this._textReversed = false; // Pre-render\n\n      context.save();\n      ghostContext.save();\n\n      this._prerender(layer, true); // Split up text into lines\n\n\n      var lines = this.text.toString().replace(/\\r/g, \"\").split(/\\n/);\n      var styleRestored = true; // Iterate through the lines\n\n      var offsetY = 0;\n      $array.each(lines, function (line, _index) {\n        // Split up line into format/value chunks\n        var chunks = TextFormatter.chunk(line, false, _this.style.ignoreFormatting); // Init line object\n\n        var lineInfo = {\n          offsetY: offsetY,\n          ascent: 0,\n          width: 0,\n          height: 0,\n          left: 0,\n          right: 0,\n          textChunks: []\n        };\n        var currentStyle;\n        var currentFill;\n        var currentChunkWidth; //while(chunk = chunks.shift()) {\n\n        $array.each(chunks, function (chunk, _index) {\n          // Format chunk\n          if (chunk.type == \"format\") {\n            if (chunk.text == \"[/]\") {\n              if (!styleRestored) {\n                context.restore();\n                ghostContext.restore();\n                styleRestored = true;\n              }\n\n              currentFill = undefined;\n              currentStyle = undefined;\n              currentChunkWidth = undefined;\n            } else {\n              var format = TextFormatter.getTextStyle(chunk.text);\n\n              var fontStyle = _this._getFontStyle(format);\n\n              context.save();\n              ghostContext.save();\n              context.font = fontStyle;\n              currentStyle = fontStyle;\n\n              if (format.fill) {\n                currentFill = format.fill;\n              }\n\n              if (format.width) {\n                currentChunkWidth = $type.toNumber(format.width);\n              }\n\n              styleRestored = false;\n            }\n          } // Text format\n          else if (chunk.type == \"value\") {\n            // Measure each letter\n            var chars = chunk.text.match(/./ug) || [];\n\n            if (rtl) {\n              chars.reverse();\n            }\n\n            for (var i = 0; i < chars.length; i++) {\n              var char = chars[i]; // Measure\n\n              var metrics = _this._measureText(char, context);\n\n              var chunkWidth = metrics.width; // Chunk width?\n\n              if (currentStyle && currentChunkWidth && currentChunkWidth > chunkWidth) {\n                chunkWidth = currentChunkWidth;\n              }\n\n              var chunkHeight = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;\n\n              if (chunkHeight > lineInfo.height) {\n                lineInfo.height = chunkHeight;\n              }\n\n              if (metrics.actualBoundingBoxAscent > lineInfo.ascent) {\n                lineInfo.ascent = metrics.actualBoundingBoxAscent;\n              }\n\n              lineInfo.width += chunkWidth;\n              lineInfo.left += metrics.actualBoundingBoxLeft;\n              lineInfo.right += metrics.actualBoundingBoxRight;\n              lineInfo.textChunks.push({\n                style: currentStyle,\n                fill: currentFill,\n                text: char,\n                width: chunkWidth,\n                height: chunkHeight + metrics.actualBoundingBoxDescent,\n                left: metrics.actualBoundingBoxLeft,\n                right: metrics.actualBoundingBoxRight,\n                ascent: metrics.actualBoundingBoxAscent,\n                offsetX: 0,\n                offsetY: chunkHeight,\n                textDecoration: undefined\n              });\n\n              if (rtl) {\n                break;\n              }\n            }\n          }\n        });\n\n        if (_this.style.lineHeight instanceof Percent) {\n          lineInfo.height *= _this.style.lineHeight.value;\n        } else {\n          lineInfo.height *= _this.style.lineHeight || 1.2;\n        }\n\n        _this._textInfo.push(lineInfo); //lineInfo.offsetY += lineInfo.ascent;\n\n\n        offsetY += lineInfo.height;\n      });\n\n      if (!styleRestored) {\n        context.restore();\n        ghostContext.restore();\n      } // Adjust chunk internal offsets\n\n\n      $array.each(this._textInfo, function (lineInfo) {\n        $array.each(lineInfo.textChunks, function (chunk) {\n          chunk.offsetY += Math.round((lineInfo.height - chunk.height + (lineInfo.ascent - chunk.ascent)) / 2);\n        });\n      });\n      context.restore();\n      ghostContext.restore();\n      return {\n        left: 0,\n        top: 0,\n        right: 0,\n        bottom: 0\n      };\n    }\n  });\n  return CanvasRadialText;\n}(CanvasText);\n\nexport { CanvasRadialText };\n/**\r\n * @ignore\r\n */\n\nvar CanvasImage =\n/** @class */\nfunction (_super) {\n  __extends(CanvasImage, _super);\n\n  function CanvasImage(renderer, image) {\n    var _this = _super.call(this, renderer) || this;\n\n    Object.defineProperty(_this, \"width\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"height\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"image\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"tainted\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"shadowColor\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"shadowBlur\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"shadowOffsetX\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"shadowOffsetY\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"shadowOpacity\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_imageMask\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    _this.image = image;\n    return _this;\n  }\n\n  Object.defineProperty(CanvasImage.prototype, \"_dispose\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      _super.prototype._dispose.call(this);\n\n      if (this._imageMask) {\n        clearCanvas(this._imageMask);\n      }\n    }\n  });\n  Object.defineProperty(CanvasImage.prototype, \"getLocalBounds\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      if (!this._localBounds) {\n        var w = 0;\n        var h = 0;\n\n        if (this.width) {\n          w = this.width;\n        }\n\n        if (this.height) {\n          h = this.height;\n        }\n\n        this._localBounds = {\n          left: 0,\n          top: 0,\n          right: w,\n          bottom: h\n        };\n\n        this._addBounds(this._localBounds);\n      }\n\n      return this._localBounds;\n    }\n  });\n  Object.defineProperty(CanvasImage.prototype, \"_render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (parentLayer) {\n      _super.prototype._render.call(this, parentLayer);\n\n      if (this.image) {\n        var layer = this._layer || parentLayer;\n\n        if (this.tainted === undefined) {\n          this.tainted = isTainted(this.image);\n          layer.tainted = true;\n        }\n\n        if (this.tainted && this._renderer._omitTainted) {\n          return;\n        }\n\n        if (layer.dirty) {\n          if (this.shadowColor) {\n            layer.context.shadowColor = this.shadowColor.toCSS(this.shadowOpacity || 1);\n          }\n\n          if (this.shadowBlur) {\n            layer.context.shadowBlur = this.shadowBlur;\n          }\n\n          if (this.shadowOffsetX) {\n            layer.context.shadowOffsetX = this.shadowOffsetX;\n          }\n\n          if (this.shadowOffsetY) {\n            layer.context.shadowOffsetY = this.shadowOffsetY;\n          } // TODO should this round ?\n\n\n          var width = this.width || this.image.naturalWidth;\n          var height = this.height || this.image.naturalHeight;\n          layer.context.drawImage(this.image, 0, 0, width, height);\n        }\n\n        if (this.interactive && this._isInteractive()) {\n          var mask = this._getMask(this.image);\n\n          this._renderer._ghostContext.drawImage(mask, 0, 0);\n        }\n      }\n    }\n  });\n  Object.defineProperty(CanvasImage.prototype, \"clear\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      _super.prototype.clear.call(this);\n\n      this.image = undefined;\n      this._imageMask = undefined;\n    }\n  });\n  Object.defineProperty(CanvasImage.prototype, \"_getMask\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (image) {\n      if (this._imageMask === undefined) {\n        // TODO should this round ?\n        var width = this.width || image.naturalWidth;\n        var height = this.height || image.naturalHeight; // We need to create a second canvas because destination-in clears out the entire canvas\n\n        var canvas = document.createElement(\"canvas\");\n        canvas.width = width;\n        canvas.height = height;\n        var context = canvas.getContext(\"2d\");\n        context.imageSmoothingEnabled = false;\n        context.fillStyle = this._getColorId();\n        context.fillRect(0, 0, width, height);\n\n        if (!isTainted(image)) {\n          context.globalCompositeOperation = \"destination-in\";\n          context.drawImage(image, 0, 0, width, height);\n        }\n\n        this._imageMask = canvas;\n      }\n\n      return this._imageMask;\n    }\n  });\n  return CanvasImage;\n}(CanvasDisplayObject);\n\nexport { CanvasImage };\n/**\r\n * @ignore\r\n */\n\nvar CanvasRendererEvent =\n/** @class */\nfunction () {\n  function CanvasRendererEvent(event, point, bbox) {\n    Object.defineProperty(this, \"event\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: event\n    });\n    Object.defineProperty(this, \"point\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: point\n    });\n    Object.defineProperty(this, \"bbox\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: bbox\n    });\n    Object.defineProperty(this, \"id\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(this, \"simulated\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(this, \"native\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: true\n    });\n\n    if ($utils.supports(\"touchevents\") && event instanceof Touch) {\n      this.id = event.identifier;\n    } else {\n      this.id = null;\n    }\n  }\n\n  return CanvasRendererEvent;\n}();\n\nexport { CanvasRendererEvent };\n/**\r\n * @ignore\r\n */\n\nvar CanvasRenderer =\n/** @class */\nfunction (_super) {\n  __extends(CanvasRenderer, _super);\n  /*protected _mouseMoveThrottler: Throttler = new Throttler(() => {\r\n      this._dispatchGlobalMousemove(this._lastPointerMoveEvent.event, this._lastPointerMoveEvent.native);\r\n  });\r\n  */\n\n\n  function CanvasRenderer(resolution) {\n    var _this = _super.call(this) || this;\n\n    Object.defineProperty(_this, \"view\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: document.createElement(\"div\")\n    });\n    Object.defineProperty(_this, \"_layerDom\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: document.createElement(\"div\")\n    });\n    Object.defineProperty(_this, \"layers\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: []\n    });\n    Object.defineProperty(_this, \"_dirtyLayers\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: []\n    });\n    Object.defineProperty(_this, \"defaultLayer\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: _this.getLayer(0)\n    });\n    Object.defineProperty(_this, \"_ghostView\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_ghostContext\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"_patternCanvas\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: document.createElement(\"canvas\")\n    });\n    Object.defineProperty(_this, \"_patternContext\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: _this._patternCanvas.getContext(\"2d\")\n    });\n    Object.defineProperty(_this, \"_width\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"_height\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"_clientWidth\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"_clientHeight\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"resolution\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"interactionsEnabled\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: true\n    });\n    Object.defineProperty(_this, \"_listeners\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: {}\n    });\n    Object.defineProperty(_this, \"_events\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: {}\n    });\n    Object.defineProperty(_this, \"_colorId\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"_colorMap\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: {}\n    });\n    Object.defineProperty(_this, \"_forceInteractive\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 0\n    });\n    Object.defineProperty(_this, \"_omitTainted\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    }); // TODO this should store the Id as well\n\n    Object.defineProperty(_this, \"_hovering\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: new Set()\n    });\n    Object.defineProperty(_this, \"_dragging\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: []\n    });\n    Object.defineProperty(_this, \"_mousedown\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: []\n    });\n    Object.defineProperty(_this, \"_lastPointerMoveEvent\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n    Object.defineProperty(_this, \"tapToActivate\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"tapToActivateTimeout\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: 3000\n    });\n    Object.defineProperty(_this, \"_touchActive\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: false\n    });\n    Object.defineProperty(_this, \"_touchActiveTimeout\", {\n      enumerable: true,\n      configurable: true,\n      writable: true,\n      value: void 0\n    });\n\n    if (resolution == null) {\n      _this.resolution = window.devicePixelRatio;\n    } else {\n      _this.resolution = resolution;\n    }\n\n    _this.view.style.position = \"absolute\";\n\n    _this.view.appendChild(_this._layerDom);\n\n    _this._disposers.push(new Disposer(function () {\n      $object.each(_this._events, function (_key, events) {\n        events.disposer.dispose();\n      });\n      $array.each(_this.layers, function (layer) {\n        clearCanvas(layer.view);\n\n        if (layer.exportableView) {\n          clearCanvas(layer.exportableView);\n        }\n      });\n      clearCanvas(_this._ghostView);\n      clearCanvas(_this._patternCanvas);\n    })); // @todo : do the same for ghost\n\n\n    _this._ghostView = document.createElement(\"canvas\");\n    _this._ghostContext = _this._ghostView.getContext(\"2d\", {\n      alpha: false,\n      willReadFrequently: true\n    });\n    _this._ghostContext.imageSmoothingEnabled = false;\n    _this._ghostView.style.position = \"absolute\";\n    _this._ghostView.style.top = \"0px\";\n    _this._ghostView.style.left = \"0px\";\n\n    _this._disposers.push($utils.addEventListener(_this._ghostView, \"click\", function (originalEvent) {\n      var event = _this.getEvent(originalEvent);\n\n      var target = _this._getHitTarget(event.point, event.bbox);\n\n      console.debug(target);\n    })); // Monitor for possible pixel ratio changes (when page is zoomed)\n\n\n    _this._disposers.push($utils.onZoom(function () {\n      if (resolution == null) {\n        _this.resolution = window.devicePixelRatio;\n      }\n    })); // We need this in order top prevent default touch gestures when dragging\n    // draggable elements\n\n\n    if ($utils.supports(\"touchevents\")) {\n      var listener = function (ev) {\n        if (_this._dragging.length !== 0) {\n          $array.eachContinue(_this._dragging, function (item) {\n            if (item.value.shouldCancelTouch()) {\n              ev.preventDefault();\n              return false;\n            }\n\n            return true;\n          });\n        } // If touch down happends, delay touch out\n\n\n        if (_this._touchActiveTimeout) {\n          _this._delayTouchDeactivate();\n        }\n      };\n\n      _this._disposers.push($utils.addEventListener(window, \"touchstart\", listener, {\n        passive: false\n      }));\n\n      _this._disposers.push($utils.addEventListener(_this.view, \"touchstart\", listener, {\n        passive: false\n      }));\n\n      _this._disposers.push($utils.addEventListener(_this.view, \"touchmove\", function () {\n        // If touch is moving, delay touch out\n        if (_this._touchActiveTimeout) {\n          _this._delayTouchDeactivate();\n        }\n      }, {\n        passive: true\n      }));\n\n      _this._disposers.push($utils.addEventListener(window, \"click\", function (_ev) {\n        _this._touchActive = false;\n      }, {\n        passive: true\n      }));\n\n      _this._disposers.push($utils.addEventListener(_this.view, \"click\", function (_ev) {\n        window.setTimeout(function () {\n          _this._touchActive = true;\n\n          _this._delayTouchDeactivate();\n        }, 100);\n      }, {\n        passive: true\n      }));\n    } // Prevent scrolling of the window when hovering on \"wheelable\" object\n\n\n    if ($utils.supports(\"wheelevents\")) {\n      _this._disposers.push($utils.addEventListener(_this.view, \"wheel\", function (ev) {\n        var prevent = false;\n\n        _this._hovering.forEach(function (obj) {\n          if (obj.wheelable) {\n            prevent = true;\n            return false;\n          }\n        });\n\n        if (prevent) {\n          ev.preventDefault();\n        }\n      }, {\n        passive: false\n      }));\n    }\n\n    return _this;\n  }\n\n  Object.defineProperty(CanvasRenderer.prototype, \"_delayTouchDeactivate\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      var _this = this;\n\n      if (this._touchActiveTimeout) {\n        clearTimeout(this._touchActiveTimeout);\n      }\n\n      if (this.tapToActivateTimeout > 0) {\n        this._touchActiveTimeout = window.setTimeout(function () {\n          _this._touchActive = false;\n        }, this.tapToActivateTimeout);\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"debugGhostView\", {\n    get: function () {\n      return !!this._ghostView.parentNode;\n    },\n    set: function (value) {\n      if (value) {\n        if (!this._ghostView.parentNode) {\n          this.view.appendChild(this._ghostView);\n        }\n      } else {\n        if (this._ghostView.parentNode) {\n          this._ghostView.parentNode.removeChild(this._ghostView);\n        }\n      }\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"createLinearGradient\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x1, y1, x2, y2) {\n      return this.defaultLayer.context.createLinearGradient(x1, y1, x2, y2);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"createRadialGradient\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (x1, y1, radius1, x2, y2, radius2) {\n      return this.defaultLayer.context.createRadialGradient(x1, y1, radius1, x2, y2, radius2);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"createPattern\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (graphics, background, repetition, width, height) {\n      // const patternCanvas = document.createElement(\"canvas\");\n      // const patternContext = patternCanvas.getContext(\"2d\")!;\n      // patternCanvas.width = width;\n      // patternCanvas.height = height;\n      // if (fill) {\n      // \tpatternContext.fillStyle = fill.toCSS();\n      // \tpatternContext.fillRect(0, 0, patternCanvas.width, patternCanvas.height);\n      // }\n      // const layer = {\n      // \tview: patternCanvas,\n      // \tcontext: patternContext,\n      // \tvisible: true,\n      // \torder: 0,\n      // \twidth: width,\n      // \theight: height,\n      // \tdirty: true\n      // };\n      // // patternContext.arc(0, 0, 50, 0, .5 * Math.PI);\n      // // patternContext.stroke();\n      // image.targetLayer = layer;\n      // image.render(layer);\n      //this._layerDom.appendChild(patternCanvas);\n      this._patternCanvas.width = width;\n      this._patternCanvas.height = height;\n\n      this._patternContext.clearRect(0, 0, width, height); // patternCanvas.style.width = width * this.resolution + \"px\";\n      // patternCanvas.style.height = height * this.resolution + \"px\";\n\n\n      background.renderDetached(this._patternContext);\n      graphics.renderDetached(this._patternContext);\n      return this._patternContext.createPattern(this._patternCanvas, repetition);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"makeContainer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return new CanvasContainer(this);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"makeGraphics\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return new CanvasGraphics(this);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"makeText\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (text, style) {\n      return new CanvasText(this, text, style);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"makeTextStyle\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function () {\n      return new CanvasTextStyle();\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"makeRadialText\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (text, style) {\n      return new CanvasRadialText(this, text, style);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"makePicture\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (image) {\n      return new CanvasImage(this, image);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"resize\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (width, height) {\n      var _this = this;\n\n      this._clientWidth = width;\n      this._clientHeight = height;\n      this._width = Math.floor(width * this.resolution);\n      this._height = Math.floor(height * this.resolution);\n      $array.each(this.layers, function (layer) {\n        if (layer) {\n          layer.dirty = true;\n\n          if (layer.width != null) {\n            layer.view.width = layer.width;\n            layer.view.style.width = layer.width + \"px\";\n          } else {\n            layer.view.width = _this._width;\n            layer.view.style.width = width + \"px\";\n          }\n\n          if (layer.height != null) {\n            layer.view.height = layer.height;\n            layer.view.style.height = layer.height + \"px\";\n          } else {\n            layer.view.height = _this._height;\n            layer.view.style.height = height + \"px\";\n          }\n        }\n      }); // @todo: do the same for ghost canvases\n\n      this._ghostView.width = this._width;\n      this._ghostView.height = this._height;\n      this._ghostView.style.width = width + \"px\";\n      this._ghostView.style.height = height + \"px\";\n      this.view.style.width = width + \"px\";\n      this.view.style.height = height + \"px\";\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"createDetachedLayer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (willReadFrequently) {\n      if (willReadFrequently === void 0) {\n        willReadFrequently = false;\n      }\n\n      var view = document.createElement(\"canvas\");\n      var context = view.getContext(\"2d\", {\n        willReadFrequently: willReadFrequently\n      });\n      var layer = {\n        view: view,\n        context: context,\n        order: 0,\n        visible: true,\n        width: undefined,\n        height: undefined,\n        dirty: true,\n        tainted: false\n      };\n      view.style.position = \"absolute\";\n      view.style.top = \"0px\";\n      view.style.left = \"0px\";\n      return layer;\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"getLayerByOrder\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (order) {\n      var layers = this.layers;\n      var length = layers.length;\n\n      for (var i = 0; i < length; i++) {\n        var layer = layers[i];\n\n        if (layer.order == order) {\n          return layer;\n        }\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"getLayer\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (order, visible) {\n      if (visible === void 0) {\n        visible = true;\n      }\n\n      var existingLayer = this.getLayerByOrder(order);\n\n      if (existingLayer) {\n        return existingLayer;\n      }\n\n      var layer = this.createDetachedLayer(order == 99);\n      layer.order = order;\n      layer.visible = visible;\n\n      if (layer.visible && this._width) {\n        layer.view.width = this._width;\n        layer.view.style.width = this._clientWidth + \"px\";\n        layer.view.height = this._height;\n        layer.view.style.height = this._clientHeight + \"px\";\n      }\n\n      var layers = this.layers;\n      layers.push(layer);\n      layers.sort(function (a, b) {\n        if (a.order > b.order) {\n          return 1;\n        } else if (a.order < b.order) {\n          return -1;\n        } else {\n          return 0;\n        }\n      });\n      var length = layers.length;\n      var layerIndex = $array.indexOf(layers, layer);\n      var next;\n\n      for (var i = layerIndex + 1; i < length; i++) {\n        if (layers[i].visible) {\n          next = layers[i];\n          break;\n        }\n      }\n\n      if (layer.visible) {\n        if (next === undefined) {\n          this._layerDom.appendChild(layer.view);\n        } else {\n          this._layerDom.insertBefore(layer.view, next.view);\n        }\n      }\n\n      return layer;\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"render\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (root) {\n      var _this = this;\n\n      this._dirtyLayers.length = 0;\n      $array.each(this.layers, function (layer) {\n        if (layer) {\n          if (layer.dirty && layer.visible) {\n            var context = layer.context;\n\n            _this._dirtyLayers.push(layer);\n\n            context.save();\n            context.clearRect(0, 0, _this._width, _this._height);\n          }\n        }\n      });\n\n      this._ghostContext.save(); //this._ghostContext.clearRect(0, 0, this._width, this._height);\n      //this._ghostContext.beginPath();\n\n\n      this._ghostContext.fillStyle = '#000';\n\n      this._ghostContext.fillRect(0, 0, this._width, this._height);\n\n      root.render(this.defaultLayer);\n\n      this._ghostContext.restore(); //setTimeout(() => {\n      // Remove this after the Chrome bug is fixed:\n      // https://bugs.chromium.org/p/chromium/issues/detail?id=1279394\n\n\n      $array.each(this.layers, function (layer) {\n        if (layer) {\n          var context = layer.context;\n          context.beginPath();\n          context.moveTo(0, 0);\n          context.stroke();\n        }\n      });\n      $array.each(this._dirtyLayers, function (layer) {\n        layer.context.restore();\n        layer.dirty = false;\n      }); //}, 100)\n\n      if (this._hovering.size && this._lastPointerMoveEvent) {\n        //this._mouseMoveThrottler.run();\n        var native_1 = this._lastPointerMoveEvent.native;\n        $array.each(this._lastPointerMoveEvent.events, function (event) {\n          _this._dispatchGlobalMousemove(event, native_1);\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"paintId\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (obj) {\n      var id = distributeId(++this._colorId);\n      var color = Color.fromHex(id).toCSS();\n      this._colorMap[color] = obj;\n      return color;\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_removeObject\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (obj) {\n      if (obj._colorId !== undefined) {\n        delete this._colorMap[obj._colorId];\n      }\n    }\n  }); // protected _identifyObjectByColor(colorId: number): CanvasDisplayObject | undefined {\n  // \treturn this._colorMap[colorId];\n  // }\n\n  Object.defineProperty(CanvasRenderer.prototype, \"getEvent\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent, adjustPoint) {\n      if (adjustPoint === void 0) {\n        adjustPoint = true;\n      }\n\n      var bbox = adjustPoint ? this.view.getBoundingClientRect() : new DOMRect(0, 0, 0, 0);\n      return new CanvasRendererEvent(originalEvent, originalEvent.clientX || originalEvent.clientY ? {\n        x: originalEvent.clientX - (originalEvent.clientX ? bbox.left : 0),\n        y: originalEvent.clientY - (originalEvent.clientY ? bbox.top : 0)\n      } : {\n        x: 0,\n        y: 0\n      }, bbox);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_getHitTarget\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (point, bbox) {\n      if (point.x < 0 || point.x > bbox.width || point.y < 0 || point.y > bbox.height) {\n        return;\n      } else {\n        var pixel = this._ghostContext.getImageData( // TODO should this round ?\n        Math.round(point.x / bbox.width * this._width), Math.round(point.y / bbox.height * this._height), 1, 1);\n\n        if (pixel.data[0] === 0 && pixel.data[1] === 0 && pixel.data[2] === 0) {\n          return false;\n        }\n\n        var colorId = Color.fromRGB(pixel.data[0], pixel.data[1], pixel.data[2]).toCSS();\n        var hit = this._colorMap[colorId];\n        return hit;\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_withEvents\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (key, f) {\n      var events = this._events[key];\n\n      if (events !== undefined) {\n        events.dispatching = true;\n\n        try {\n          f(events);\n        } finally {\n          events.dispatching = false;\n\n          if (events.cleanup) {\n            events.cleanup = false;\n            $array.keepIf(events.callbacks, function (callback) {\n              return !callback.disposed;\n            });\n\n            if (events.callbacks.length === 0) {\n              events.disposer.dispose();\n              delete this._events[key];\n            }\n          }\n        }\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchEventAll\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (key, event) {\n      if (!this.interactionsEnabled) {\n        return;\n      }\n\n      this._withEvents(key, function (events) {\n        $array.each(events.callbacks, function (callback) {\n          if (!callback.disposed) {\n            callback.callback.call(callback.context, event);\n          }\n        });\n      });\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchEvent\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (key, target, event) {\n      if (!this.interactionsEnabled) {\n        return false;\n      }\n\n      var dispatched = false;\n\n      this._withEvents(key, function (events) {\n        $array.each(events.callbacks, function (callback) {\n          if (!callback.disposed && callback.object === target) {\n            callback.callback.call(callback.context, event);\n            dispatched = true;\n          }\n        });\n      });\n\n      return dispatched;\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchMousedown\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent) {\n      var _this = this;\n\n      var button = originalEvent.button;\n\n      if (button != 0 && button != 2 && button != 1 && button !== undefined) {\n        // Ignore non-primary mouse buttons\n        return;\n      }\n\n      var event = this.getEvent(originalEvent);\n\n      var target = this._getHitTarget(event.point, event.bbox);\n\n      if (target) {\n        var id_1 = event.id;\n        var dragged_1 = false;\n        eachTargets(target, function (obj) {\n          var info = {\n            id: id_1,\n            value: obj\n          };\n\n          _this._mousedown.push(info);\n\n          if (!dragged_1 && _this._dispatchEvent(\"pointerdown\", obj, event)) {\n            // Only dispatch the first element which matches\n            dragged_1 = true;\n\n            var has = _this._dragging.some(function (x) {\n              return x.value === obj && x.id === id_1;\n            });\n\n            if (!has) {\n              _this._dragging.push(info);\n            }\n          }\n\n          return true;\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchGlobalMousemove\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent, native) {\n      var _this = this;\n\n      var event = this.getEvent(originalEvent);\n\n      var target = this._getHitTarget(event.point, event.bbox);\n\n      event.native = native;\n\n      if (target) {\n        this._hovering.forEach(function (obj) {\n          if (!obj.contains(target)) {\n            _this._hovering.delete(obj);\n\n            if (obj.cursorOverStyle) {\n              $utils.setStyle(document.body, \"cursor\", obj._replacedCursorStyle);\n            }\n\n            _this._dispatchEvent(\"pointerout\", obj, event);\n          }\n        });\n\n        if (event.native) {\n          eachTargets(target, function (obj) {\n            if (!_this._hovering.has(obj)) {\n              _this._hovering.add(obj);\n\n              if (obj.cursorOverStyle) {\n                obj._replacedCursorStyle = $utils.getStyle(document.body, \"cursor\");\n                $utils.setStyle(document.body, \"cursor\", obj.cursorOverStyle);\n              }\n\n              _this._dispatchEvent(\"pointerover\", obj, event);\n            }\n\n            return true;\n          });\n        } //} else if (target === false) {\n\n      } else {\n        this._hovering.forEach(function (obj) {\n          if (obj.cursorOverStyle) {\n            $utils.setStyle(document.body, \"cursor\", obj._replacedCursorStyle);\n          }\n\n          _this._dispatchEvent(\"pointerout\", obj, event);\n        });\n\n        this._hovering.clear();\n      }\n\n      this._dispatchEventAll(\"globalpointermove\", event);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchGlobalMouseup\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent, native) {\n      var event = this.getEvent(originalEvent);\n      event.native = native; //const target = this._getHitTarget(event.point);\n\n      this._dispatchEventAll(\"globalpointerup\", event);\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchDragMove\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent) {\n      var _this = this;\n\n      if (this._dragging.length !== 0) {\n        var event_1 = this.getEvent(originalEvent);\n        var id_2 = event_1.id;\n\n        this._dragging.forEach(function (obj) {\n          if (obj.id === id_2) {\n            _this._dispatchEvent(\"pointermove\", obj.value, event_1);\n          }\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchDragEnd\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent) {\n      var _this = this;\n\n      var button = originalEvent.button;\n      var clickevent;\n\n      if (button == 0 || button === undefined) {\n        clickevent = \"click\";\n      } else if (button == 2) {\n        clickevent = \"rightclick\";\n      } else if (button == 1) {\n        clickevent = \"middleclick\";\n      } else {\n        // Ignore non-primary mouse buttons\n        return;\n      }\n\n      var event = this.getEvent(originalEvent);\n      var id = event.id;\n\n      if (this._mousedown.length !== 0) {\n        var target_1 = this._getHitTarget(event.point, event.bbox);\n\n        if (target_1) {\n          this._mousedown.forEach(function (obj) {\n            if (obj.id === id && obj.value.contains(target_1)) {\n              _this._dispatchEvent(clickevent, obj.value, event);\n            }\n          });\n        }\n\n        this._mousedown.length = 0;\n      }\n\n      if (this._dragging.length !== 0) {\n        this._dragging.forEach(function (obj) {\n          if (obj.id === id) {\n            _this._dispatchEvent(\"pointerup\", obj.value, event);\n          }\n        });\n\n        this._dragging.length = 0;\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchDoubleClick\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent) {\n      var _this = this;\n\n      var event = this.getEvent(originalEvent);\n\n      var target = this._getHitTarget(event.point, event.bbox);\n\n      if (target) {\n        eachTargets(target, function (obj) {\n          if (_this._dispatchEvent(\"dblclick\", obj, event)) {\n            return false;\n          } else {\n            return true;\n          }\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_dispatchWheel\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (originalEvent) {\n      var _this = this;\n\n      var event = this.getEvent(originalEvent);\n\n      var target = this._getHitTarget(event.point, event.bbox);\n\n      if (target) {\n        eachTargets(target, function (obj) {\n          if (_this._dispatchEvent(\"wheel\", obj, event)) {\n            return false;\n          } else {\n            return true;\n          }\n        });\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_makeSharedEvent\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (key, f) {\n      var _this = this;\n\n      if (this._listeners[key] === undefined) {\n        var listener_1 = f();\n        this._listeners[key] = new CounterDisposer(function () {\n          delete _this._listeners[key];\n          listener_1.dispose();\n        });\n      }\n\n      return this._listeners[key].increment();\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_onPointerEvent\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (name, f) {\n      var native = false;\n      var timer = null;\n\n      function clear() {\n        timer = null;\n        native = false;\n      }\n\n      return new MultiDisposer([new Disposer(function () {\n        if (timer !== null) {\n          clearTimeout(timer);\n        }\n\n        clear();\n      }), $utils.addEventListener(this.view, $utils.getRendererEvent(name), function (_) {\n        native = true;\n\n        if (timer !== null) {\n          clearTimeout(timer);\n        }\n\n        timer = window.setTimeout(clear, 0);\n      }), onPointerEvent(window, name, function (ev) {\n        if (timer !== null) {\n          clearTimeout(timer);\n          timer = null;\n        }\n\n        f(ev, native);\n        native = false;\n      })]);\n    }\n  }); // This ensures that only a single DOM event is added (e.g. only a single mousemove event listener)\n\n  Object.defineProperty(CanvasRenderer.prototype, \"_initEvent\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (key) {\n      var _this = this;\n\n      switch (key) {\n        case \"globalpointermove\":\n        case \"pointerover\":\n        case \"pointerout\":\n          return this._makeSharedEvent(\"pointermove\", function () {\n            var listener = function (events, native) {\n              _this._lastPointerMoveEvent = {\n                events: events,\n                native: native\n              };\n              $array.each(events, function (event) {\n                _this._dispatchGlobalMousemove(event, native);\n              });\n            };\n\n            return new MultiDisposer([_this._onPointerEvent(\"pointerdown\", listener), _this._onPointerEvent(\"pointermove\", listener)]);\n          });\n\n        case \"globalpointerup\":\n          return this._makeSharedEvent(\"pointerup\", function () {\n            var mouseup = _this._onPointerEvent(\"pointerup\", function (events, native) {\n              $array.each(events, function (event) {\n                _this._dispatchGlobalMouseup(event, native);\n              });\n              _this._lastPointerMoveEvent = {\n                events: events,\n                native: native\n              };\n            });\n\n            var pointercancel = _this._onPointerEvent(\"pointercancel\", function (events, native) {\n              $array.each(events, function (event) {\n                _this._dispatchGlobalMouseup(event, native);\n              });\n              _this._lastPointerMoveEvent = {\n                events: events,\n                native: native\n              };\n            });\n\n            return new Disposer(function () {\n              mouseup.dispose();\n              pointercancel.dispose();\n            });\n          });\n\n        case \"click\":\n        case \"rightclick\":\n        case \"middleclick\":\n        case \"pointerdown\":\n        /*\r\n            return this._makeSharedEvent(\"pointerdown\", () => {\r\n                return this._onPointerEvent(\"pointerdown\", (event, native) => {\r\n                    this._lastPointerMoveEvent = { event, native };\r\n                    this._dispatchMousedown(event)\r\n                });\r\n            });\r\n        */\n\n        case \"pointermove\":\n        case \"pointerup\":\n          return this._makeSharedEvent(\"pointerdown\", function () {\n            //const throttler = new Throttler();\n            var mousedown = onPointerEvent(_this.view, \"pointerdown\", function (events) {\n              $array.each(events, function (ev) {\n                _this._dispatchMousedown(ev);\n              });\n            }); // TODO handle throttling properly for multitouch\n\n            var mousemove = _this._onPointerEvent(\"pointermove\", function (ev) {\n              //throttler.throttle(() => {\n              $array.each(ev, function (ev) {\n                _this._dispatchDragMove(ev);\n              }); //});\n            });\n\n            var mouseup = _this._onPointerEvent(\"pointerup\", function (ev) {\n              $array.each(ev, function (ev) {\n                _this._dispatchDragEnd(ev);\n              });\n            });\n\n            var pointercancel = _this._onPointerEvent(\"pointercancel\", function (ev) {\n              $array.each(ev, function (ev) {\n                _this._dispatchDragEnd(ev);\n              });\n            });\n\n            return new Disposer(function () {\n              mousedown.dispose();\n              mousemove.dispose();\n              mouseup.dispose();\n              pointercancel.dispose();\n            });\n          });\n\n        case \"dblclick\":\n          return this._makeSharedEvent(\"dblclick\", function () {\n            return _this._onPointerEvent(\"dblclick\", function (ev) {\n              $array.each(ev, function (ev) {\n                _this._dispatchDoubleClick(ev);\n              });\n            });\n          });\n\n        case \"wheel\":\n          return this._makeSharedEvent(\"wheel\", function () {\n            return $utils.addEventListener(window, $utils.getRendererEvent(\"wheel\"), function (event) {\n              _this._dispatchWheel(event);\n            }, {\n              passive: false\n            });\n          });\n      }\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"_addEvent\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (object, key, callback, context) {\n      var _this = this;\n\n      var events = this._events[key];\n\n      if (events === undefined) {\n        events = this._events[key] = {\n          disposer: this._initEvent(key),\n          callbacks: [],\n          dispatching: false,\n          cleanup: false\n        };\n      }\n\n      var listener = {\n        object: object,\n        context: context,\n        callback: callback,\n        disposed: false\n      };\n      events.callbacks.push(listener);\n      return new Disposer(function () {\n        listener.disposed = true;\n\n        if (events.dispatching) {\n          events.cleanup = true;\n        } else {\n          $array.removeFirst(events.callbacks, listener);\n\n          if (events.callbacks.length === 0) {\n            events.disposer.dispose();\n            delete _this._events[key];\n          }\n        }\n      });\n    }\n  });\n  Object.defineProperty(CanvasRenderer.prototype, \"getCanvas\", {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value: function (root, options) {\n      var _this = this; // Make sure everything is rendered\n\n\n      this.render(root);\n\n      if (!options) {\n        options = {};\n      }\n\n      var scale = this.resolution; // Check if we need to scale\n\n      if (options.minWidth && options.minWidth > this._width) {\n        var minScale = options.minWidth / this._width;\n\n        if (minScale > scale) {\n          scale = minScale * this.resolution;\n        }\n      }\n\n      if (options.minHeight && options.minHeight > this._height) {\n        var minScale = options.minHeight / this._height;\n\n        if (minScale > scale) {\n          scale = minScale * this.resolution;\n        }\n      }\n\n      if (options.maxWidth && options.maxWidth < this._width) {\n        var maxScale = options.maxWidth / this._width;\n\n        if (maxScale < scale) {\n          scale = maxScale * this.resolution;\n        }\n      }\n\n      if (options.maxHeight && options.maxHeight > this._height) {\n        var maxScale = options.maxHeight / this._height;\n\n        if (maxScale < scale) {\n          scale = maxScale * this.resolution;\n        }\n      } // Check if we need to compensate for pixel ratio\n\n\n      if (options.maintainPixelRatio) {\n        scale /= this.resolution;\n      } // Init list canvases to remove from DOM after export\n\n\n      var canvases = []; // Set up new canvas for export\n\n      var forceRender = false;\n      var canvasWidth = this._width;\n      var canvasHeight = this._height;\n      var canvas = document.createElement(\"canvas\");\n\n      if (scale != this.resolution) {\n        forceRender = true;\n        canvasWidth = this._width * scale / this.resolution;\n        canvasHeight = this._height * scale / this.resolution;\n      }\n\n      canvas.width = canvasWidth;\n      canvas.height = canvasHeight; // Add to DOM so it inherits CSS\n\n      canvas.style.position = \"fixed\";\n      canvas.style.top = \"-10000px\";\n      this.view.appendChild(canvas);\n      canvases.push(canvas); // Context\n\n      var context = canvas.getContext(\"2d\");\n      var width = 0;\n      var height = 0;\n      var needRerender = false;\n      $array.each(this.layers, function (layer) {\n        if (layer && layer.visible) {\n          if (layer.tainted || forceRender) {\n            needRerender = true;\n            layer.exportableView = layer.view;\n            layer.exportableContext = layer.context;\n            layer.view = document.createElement(\"canvas\"); // Add to DOM so it inherits CSS\n\n            layer.view.style.position = \"fixed\";\n            layer.view.style.top = \"-10000px\";\n\n            _this.view.appendChild(layer.view);\n\n            canvases.push(layer.view);\n            layer.view.width = canvasWidth;\n            layer.view.height = canvasHeight;\n            layer.context = layer.view.getContext(\"2d\");\n            layer.dirty = true;\n            layer.scale = scale;\n          }\n        }\n      });\n\n      if (needRerender) {\n        this._omitTainted = true;\n        this.render(root);\n        this._omitTainted = false;\n      }\n\n      $array.each(this.layers, function (layer) {\n        if (layer && layer.visible) {\n          // Layer is fine. Just plop it into our target canvas\n          context.drawImage(layer.view, 0, 0); // Restore layer original canvas\n\n          if (layer.exportableView) {\n            layer.view = layer.exportableView;\n            layer.exportableView = undefined;\n          }\n\n          if (layer.exportableContext) {\n            layer.context = layer.exportableContext;\n            layer.exportableContext = undefined;\n          }\n\n          if (width < layer.view.clientWidth) {\n            width = layer.view.clientWidth;\n          }\n\n          if (height < layer.view.clientHeight) {\n            height = layer.view.clientHeight;\n          }\n\n          layer.scale = undefined;\n        }\n      });\n      canvas.style.width = width + \"px\";\n      canvas.style.height = height + \"px\";\n      $array.each(canvases, function (canvas) {\n        canvas.style.position = \"\";\n        canvas.style.top = \"\";\n\n        _this.view.removeChild(canvas);\n      });\n      return canvas;\n    }\n  });\n  return CanvasRenderer;\n}(ArrayDisposer);\n\nexport { CanvasRenderer };","map":{"version":3,"mappings":"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","names":["BlendMode","Color","Matrix","Percent","percent","ArrayDisposer","Disposer","DisposerClass","CounterDisposer","MultiDisposer","TextFormatter","$utils","$array","$object","$type","$math","arcToBezier","checkArgs","name","actual","expected","Error","checkMinArgs","checkEvenArgs","assertBinary","value","distributeId","id","rgb","i","eachTargets","hitTarget","f","interactive","_parent","onPointerEvent","element","addEventListener","getRendererEvent","event","touches","length","changedTouches","copy","isTainted","image","canvas","document","createElement","width","height","context","getContext","willReadFrequently","drawImage","getImageData","err","console","warn","src","clearCanvas","view","style","Object","CanvasPivot","_x","_y","__extends","renderer","_super","_this","_renderer","_removeObject","getLayer","self","_layer","defaultLayer","order","visible","undefined","registerChildLayer","dirty","invalidateBounds","_localBounds","_bounds","_colorId","paintId","inactive","_forceInteractive","_isInteractive","child","point","_matrix","apply","applyInverse","_uMatrix","setTransform","pivot","x","y","angle","Math","PI","scale","bn","left","top","right","bottom","_addBounds","bounds","_setMatrix","matrix","getLocalMatrix","p0","p1","p2","p3","min","max","key","callback","_addEvent","_localMatrix","copyFrom","prepend","resolution","m","a","b","c","d","tx","ty","parentLayer","exportable","_omitTainted","resolution_1","layers","ghostContext","_ghostContext","mask_1","mask","each","layer","save","_transform","_runPath","clip","globalAlpha","compoundAlpha","alpha","filter","_isInteractiveMask","_render","restore","tainted","_hovering","has","_dragging","some","tapToActivate","_touchActive","cancelTouch","shouldCancelTouch","interactiveChildren","call","_children","push","index","splice","removeFirst","render","_childLayers","pushOne","deep","markDirtyLayer","dispose","CanvasDisplayObject","setPoint","_context","_forceColor","color","forceColor","fillStyle","Op","clearShadow","fill","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","stroke","lineJoin","strokeStyle","lineWidth","dash","setLineDash","dashOffset","lineDashOffset","rect","l","t","r","radius","moveTo","arc","radiusX","radiusY","ellipse","cx","cy","startAngle","endAngle","anticlockwise","arcBounds","getArcBounds","DEGREES","x1","y1","x2","y2","arcTo","lineTo","closePath","cpX","cpY","cpX2","cpY2","toX","toY","bezierCurveTo","quadraticCurveTo","blur","offsetX","offsetY","opacity","NORMAL","clear","_operations","op","_fillAlpha","_pushOp","BeginFill","toCSS","isMeasured","EndFill","_hasShadows","EndStroke","_strokeAlpha","LineStyle","LineDash","LineDashOffset","DrawRect","DrawCircle","DrawEllipse","Arc","ArcTo","LineTo","MoveTo","BezierCurveTo","QuadraticCurveTo","ClosePath","Shadow","GraphicsImage","path","cpx","cpy","qcpx","qcpy","SEGMENTS_REGEXP","ARGS_REGEXP","match","exec","name_1","rest","args","relative","bs","px","py","rx","ry","xAxisRotation","largeArcFlag","sweepFlag","beginPath","layerDirty","context_1","ghostContext_1","globalCompositeOperation","blendMode","color_1","_getColorId","colorize","addBounds","text","_textInfo","textAlign","direction","textBaseline","ignoreGhost","ignoreFontWeight","fontStyle","_getFontStyle","font","shadowOpacity","_shared","style2","fontVariant","fontWeight","fontSize","isNumber","fontFamily","join","_measure","_textVisible","interactive_1","context_2","layerDirty_1","ghostContext_2","_prerender","line","_index","textChunks","chunk","fillText","textDecoration","thickness","offset","format","getTextStyle","rtl","oversizedBehavior","maxWidth","truncate","wrap","refText","lines","toString","replace","split","styleRestored","minX","maxX","currentStyle","chunks","type","ignoreFormatting","lineInfo","ascent","metrics","_measureText","actualBoundingBoxAscent","actualBoundingBoxDescent","currentFormat","currentDecoration","currentFill","currentChunkWidth","skipFurtherText","firstTextChunk","leftoverChunks","currentVerticalAlign","eachContinue","toNumber","verticalAlign","metrics_1","height_1","metrics_2","chunkWidth","actualBoundingBoxLeft","actualBoundingBoxRight","breakWords","ellipsis","ellipsisMetrics","ellipsisWidth","excessWidth","_truncateText","tmpText","slice","trim","unshift","substr","leftBoundMod","rightBoundMod","boundsMod","chunkHeight","lineHeight","currentChunkOffset","baselineRatio","ratio","_fitRatio","minScale","_originalScale","maxW","maxH","maxHeight","w","h","fallbackBreakWords","tmp","measureText","fakeMetrics","div","innerText","visibility","position","body","appendChild","bbox","getBoundingClientRect","removeChild","w_1","fontBoundingBoxAscent","fontBoundingBoxDescent","textType","_renderCircular","deltaAngle","orientation","inward","inside","align","kerning","clockwise","shouldReverse","_textReversed","maxAngle_1","midAngle","normalizeAngle","reverse","textHeight","lineStartAngle","rotate","angleShift","char","charWidth","_measureCircular","chars","round","CanvasText","_dispose","_imageMask","naturalWidth","naturalHeight","_getMask","imageSmoothingEnabled","fillRect","supports","Touch","identifier","_patternCanvas","Set","window","devicePixelRatio","_layerDom","_disposers","_events","_key","events","disposer","exportableView","_ghostView","originalEvent","getEvent","target","_getHitTarget","debug","onZoom","listener","ev","item","preventDefault","_touchActiveTimeout","_delayTouchDeactivate","passive","_ev","setTimeout","prevent","forEach","obj","wheelable","clearTimeout","tapToActivateTimeout","CanvasRenderer","parentNode","createLinearGradient","radius1","radius2","createRadialGradient","graphics","background","repetition","_patternContext","clearRect","renderDetached","createPattern","CanvasContainer","CanvasGraphics","CanvasTextStyle","CanvasRadialText","CanvasImage","_clientWidth","_clientHeight","_width","floor","_height","existingLayer","getLayerByOrder","createDetachedLayer","sort","layerIndex","indexOf","next","insertBefore","root","_dirtyLayers","size","_lastPointerMoveEvent","native_1","native","_dispatchGlobalMousemove","fromHex","_colorMap","adjustPoint","DOMRect","CanvasRendererEvent","clientX","clientY","pixel","data","colorId","fromRGB","hit","dispatching","cleanup","keepIf","callbacks","disposed","interactionsEnabled","_withEvents","dispatched","object","button","id_1","dragged_1","info","_mousedown","_dispatchEvent","contains","delete","cursorOverStyle","setStyle","_replacedCursorStyle","add","getStyle","_dispatchEventAll","event_1","id_2","clickevent","target_1","_listeners","listener_1","increment","timer","_","_makeSharedEvent","_onPointerEvent","mouseup","_dispatchGlobalMouseup","pointercancel","mousedown","_dispatchMousedown","mousemove","_dispatchDragMove","_dispatchDragEnd","_dispatchDoubleClick","_dispatchWheel","_initEvent","options","minWidth","minHeight","maxScale","maintainPixelRatio","canvases","forceRender","canvasWidth","canvasHeight","needRerender","exportableContext","clientWidth","clientHeight"],"sourceRoot":"","sources":["../../../../../../src/.internal/core/render/backend/CanvasRenderer.ts"],"sourcesContent":["/** @ignore *//** */\n\nimport {\n\tIRenderer, IContainer, IDisplayObject, IGraphics, IRendererEvents,\n\tIText, ITextStyle, IRadialText, IPicture, IRendererEvent, ILayer, ICanvasOptions, BlendMode, IPointerEvent, Id\n} from \"./Renderer\";\nimport type { IBounds } from \"../../util/IBounds\";\nimport type { IPoint } from \"../../util/IPoint\";\nimport { Color } from \"../../util/Color\";\nimport { Matrix } from \"../../util/Matrix\";\nimport { Percent, percent } from \"../../util/Percent\";\n//import { Throttler } from \"../../util/Throttler\";\nimport { ArrayDisposer, Disposer, DisposerClass, IDisposer, CounterDisposer, MultiDisposer } from \"../../util/Disposer\";\nimport { TextFormatter, ITextChunk } from \"../../util/TextFormatter\";\nimport * as $utils from \"../../util/Utils\";\nimport * as $array from \"../../util/Array\";\nimport * as $object from \"../../util/Object\";\nimport * as $type from \"../../util/Type\";\nimport * as $math from \"../../util/Math\";\nimport arcToBezier from 'svg-arc-to-cubic-bezier';\n\n\n/**\n * @ignore\n */\nfunction checkArgs(name: string, actual: number, expected: number) {\n\tif (actual !== expected) {\n\t\tthrow new Error(\"Required \" + expected + \" arguments for \" + name + \" but got \" + actual);\n\t}\n}\n\n/**\n * @ignore\n */\nfunction checkMinArgs(name: string, actual: number, expected: number) {\n\tif (actual < expected) {\n\t\tthrow new Error(\"Required at least \" + expected + \" arguments for \" + name + \" but got \" + actual);\n\t}\n}\n\n/**\n * @ignore\n */\nfunction checkEvenArgs(name: string, actual: number, expected: number) {\n\tcheckMinArgs(name, actual, expected);\n\n\tif ((actual % expected) !== 0) {\n\t\tthrow new Error(\"Arguments for \" + name + \" must be in pairs of \" + expected);\n\t}\n}\n\n/**\n * @ignore\n */\nfunction assertBinary(value: number): 0 | 1 {\n\tif (value === 0 || value === 1) {\n\t\treturn value;\n\n\t} else {\n\t\tthrow new Error(\"Flag must be 0 or 1\");\n\t}\n}\n\n//  1 -> 0xffffff * (2 / 2)\n//  2 -> 0xffffff * (1 / 2)\n//\n//  3 -> 0xffffff * (3 / 4)\n//  4 -> 0xffffff * (1 / 4)\n//\n//  5 -> 0xffffff * (7 / 8)\n//  6 -> 0xffffff * (5 / 8)\n//  7 -> 0xffffff * (3 / 8)\n//  8 -> 0xffffff * (1 / 8)\n//\n//  9 -> 0xffffff * (15 / 16)\n// 10 -> 0xffffff * (13 / 16)\n// 11 -> 0xffffff * (11 / 16)\n// 12 -> 0xffffff *  (9 / 16)\n// 13 -> 0xffffff *  (7 / 16)\n// 14 -> 0xffffff *  (5 / 16)\n// 15 -> 0xffffff *  (3 / 16)\n// 16 -> 0xffffff *  (1 / 16)\n// @todo remove this old color distribution algo if the new one pans out\n// function distributeIdBAK(id: number): number {\n// \tif (id === 1) {\n// \t\treturn 0x000001;\n\n// \t} else {\n// \t\t// Finds the closest power of 2\n// \t\tconst base = Math.pow(2, Math.ceil(Math.log(id) / Math.log(2)));\n\n// \t\t// Translates the id into an odd fraction index\n// \t\tconst index = ((base - id) * 2) + 1;\n\n// \t\t// TODO is Math.round correct ?\n// \t\treturn Math.round(0xffffff * (index / base));\n// \t}\n// }\n\n/**\n * Function by smeans:\n * https://lowcode.life/generating-unique-contrasting-colors-in-javascript/\n * @ignore\n */\nfunction distributeId(id: number): number {\n\tconst rgb = [0, 0, 0];\n\tfor (let i = 0; i < 24; i++) {\n\t\trgb[i % 3] <<= 1;\n\t\trgb[i % 3] |= id & 0x01;\n\t\tid >>= 1;\n\t}\n\treturn (rgb[2] | 0) + (rgb[1] << 8) + (rgb[0] << 16);\n}\n\n/**\n * @ignore\n */\nfunction eachTargets(hitTarget: CanvasDisplayObject, f: (target: CanvasDisplayObject) => boolean): void {\n\tfor (; ;) {\n\t\tif (hitTarget.interactive) {\n\t\t\tif (!f(hitTarget)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (hitTarget._parent) {\n\t\t\thitTarget = hitTarget._parent;\n\n\t\t} else {\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\n// TODO feature detection for mouse/touch/pointer\n/**\n * @ignore\n */\nfunction onPointerEvent(element: EventTarget, name: string, f: (event: Array<IPointerEvent>) => void): IDisposer {\n\treturn $utils.addEventListener(element, $utils.getRendererEvent(name), (event: MouseEvent | TouchEvent) => {\n\t\tlet touches = (<any>event).touches;\n\t\tif (touches) {\n\t\t\tif (touches.length == 0) {\n\t\t\t\ttouches = (<any>event).changedTouches;\n\t\t\t}\n\n\t\t\tf($array.copy(<TouchList>touches));\n\n\t\t} else {\n\t\t\tf([<MouseEvent>event]);\n\t\t}\n\t});\n}\n\n/**\n * @ignore\n */\nfunction isTainted(image: HTMLImageElement): boolean {\n\tconst canvas = document.createElement(\"canvas\");\n\tcanvas.width = 1;\n\tcanvas.height = 1;\n\tconst context = canvas.getContext(\"2d\", { willReadFrequently: true })! as CanvasRenderingContext2D;\n\tcontext.drawImage(image, 0, 0, 1, 1);\n\n\ttry {\n\t\tcontext.getImageData(0, 0, 1, 1);\n\t\treturn false;\n\t}\n\tcatch (err) {\n\t\tconsole.warn(\"Image \\\"\" + image.src + \"\\\" is loaded from different host and is not covered by CORS policy. For more information about the implications read here: https://www.amcharts.com/docs/v5/concepts/cors\");\n\t\treturn true;\n\t}\n}\n\n/**\n * This is needed to workaround a bug in iOS which causes it to not GC canvas elements.\n *\n * @ignore\n */\nfunction clearCanvas(view: HTMLCanvasElement) {\n\tview.width = 0;\n\tview.height = 0;\n\tview.style.width = \"0px\";\n\tview.style.height = \"0px\";\n}\n\n/**\n * @ignore\n */\nexport class CanvasPivot implements IPoint {\n\tprotected _x: number = 0;\n\tprotected _y: number = 0;\n\n\tget x(): number {\n\t\treturn this._x;\n\t}\n\n\tget y(): number {\n\t\treturn this._y;\n\t}\n\n\tset x(value: number) {\n\t\tthis._x = value;\n\t}\n\n\tset y(value: number) {\n\t\tthis._y = value;\n\t}\n}\n\n/**\n * @ignore\n */\nexport class CanvasDisplayObject extends DisposerClass implements IDisplayObject, IDisposer {\n\tpublic _layer?: CanvasLayer;\n\n\tpublic mask: CanvasGraphics | null = null;\n\tpublic visible: boolean = true;\n\tpublic exportable?: boolean = true;\n\tpublic interactive: boolean = false;\n\tpublic inactive: boolean = false;\n\tpublic wheelable: boolean = false;\n\tpublic cancelTouch: boolean = false;\n\tpublic isMeasured: boolean = false;\n\tpublic buttonMode: boolean = false;\n\tpublic alpha: number = 1;\n\tpublic compoundAlpha: number = 1;\n\tpublic angle: number = 0;\n\tpublic scale: number = 1;\n\tpublic x: number = 0;\n\tpublic y: number = 0;\n\tpublic pivot: CanvasPivot = new CanvasPivot();\n\n\tpublic filter?: string;\n\n\tpublic cursorOverStyle?: string;\n\tpublic _replacedCursorStyle?: string;\n\n\tpublic _localMatrix: Matrix = new Matrix();\n\tpublic _matrix: Matrix = new Matrix();\n\t// TODO can this be replaced with _localMatrix ?\n\tprotected _uMatrix: Matrix = new Matrix();\n\n\tpublic _renderer: CanvasRenderer;\n\tpublic _parent: CanvasContainer | undefined;\n\n\tprotected _localBounds: IBounds | undefined;\n\tprotected _bounds: IBounds | undefined;\n\tpublic _colorId: string | undefined;\n\n\tconstructor(renderer: CanvasRenderer) {\n\t\tsuper();\n\t\tthis._renderer = renderer;\n\t}\n\n\tprotected _dispose(): void {\n\t\tthis._renderer._removeObject(this);\n\t}\n\n\tpublic getCanvas(): HTMLCanvasElement {\n\t\treturn this.getLayer().view;\n\t}\n\n\tpublic getLayer(): CanvasLayer {\n\t\tlet self: CanvasDisplayObject = this;\n\n\t\tfor (; ;) {\n\t\t\tif (self._layer) {\n\t\t\t\treturn self._layer;\n\n\t\t\t} else if (self._parent) {\n\t\t\t\tself = self._parent;\n\n\t\t\t} else {\n\t\t\t\treturn this._renderer.defaultLayer;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic setLayer(order: number | undefined, visible: boolean = true): void {\n\t\tif (order == null) {\n\t\t\tthis._layer = undefined;\n\n\t\t} else {\n\t\t\tthis._layer = this._renderer.getLayer(order, visible);\n\t\t\tthis._layer.visible = visible;\n\t\t\tif (this._parent) {\n\t\t\t\tthis._parent.registerChildLayer(this._layer);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic markDirtyLayer(): void {\n\t\tthis.getLayer().dirty = true;\n\t}\n\n\tpublic clear(): void {\n\t\tthis.invalidateBounds();\n\t}\n\n\tpublic invalidateBounds(): void {\n\t\tthis._localBounds = undefined;\n\t}\n\n\tpublic _addBounds(_bounds: IBounds): void { }\n\n\tprotected _getColorId(): string {\n\t\tif (this._colorId === undefined) {\n\t\t\tthis._colorId = this._renderer.paintId(this);\n\t\t}\n\n\t\treturn this._colorId;\n\t}\n\n\tprotected _isInteractive(): boolean {\n\t\treturn this.inactive == false && (this.interactive || this._renderer._forceInteractive > 0);\n\t}\n\n\tprotected _isInteractiveMask(): boolean {\n\t\treturn this._isInteractive();\n\t}\n\n\tpublic contains(child: CanvasDisplayObject): boolean {\n\t\tfor (; ;) {\n\t\t\tif (child === this) {\n\t\t\t\treturn true;\n\n\t\t\t} else if (child._parent) {\n\t\t\t\tchild = child._parent;\n\n\t\t\t} else {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\n\ttoGlobal(point: IPoint): IPoint {\n\t\treturn this._matrix.apply(point);\n\t}\n\n\ttoLocal(point: IPoint): IPoint {\n\t\treturn this._matrix.applyInverse(point);\n\t}\n\n\tpublic getLocalMatrix(): Matrix {\n\t\tthis._uMatrix.setTransform(0, 0, this.pivot.x, this.pivot.y, this.angle * Math.PI / 180, this.scale);\n\t\treturn this._uMatrix;\n\t}\n\n\tgetLocalBounds(): IBounds {\n\t\tif (!this._localBounds) {\n\n\t\t\tconst bn = 10000000;\n\t\t\tthis._localBounds = {\n\t\t\t\tleft: bn,\n\t\t\t\ttop: bn,\n\t\t\t\tright: -bn,\n\t\t\t\tbottom: -bn\n\t\t\t};\n\n\t\t\tthis._addBounds(this._localBounds);\n\t\t}\n\t\treturn this._localBounds;\n\t}\n\n\tgetAdjustedBounds(bounds: IBounds): IBounds {\n\t\tthis._setMatrix();\n\n\t\tconst matrix = this.getLocalMatrix();\n\n\t\tconst p0 = matrix.apply({ x: bounds.left, y: bounds.top });\n\t\tconst p1 = matrix.apply({ x: bounds.right, y: bounds.top });\n\t\tconst p2 = matrix.apply({ x: bounds.right, y: bounds.bottom });\n\t\tconst p3 = matrix.apply({ x: bounds.left, y: bounds.bottom });\n\n\t\treturn {\n\t\t\tleft: Math.min(p0.x, p1.x, p2.x, p3.x),\n\t\t\ttop: Math.min(p0.y, p1.y, p2.y, p3.y),\n\t\t\tright: Math.max(p0.x, p1.x, p2.x, p3.x),\n\t\t\tbottom: Math.max(p0.y, p1.y, p2.y, p3.y)\n\t\t}\n\t}\n\n\ton<C, Key extends keyof IRendererEvents>(key: Key, callback: (this: C, event: IRendererEvents[Key]) => void, context?: C): IDisposer {\n\t\tif (this.interactive) {\n\t\t\treturn this._renderer._addEvent(this, key, callback, context);\n\n\t\t} else {\n\t\t\treturn new Disposer(() => { });\n\t\t}\n\t}\n\n\tpublic _setMatrix(): void {\n\t\t// TODO only calculate this if it has actually changed\n\t\tthis._localMatrix.setTransform(\n\t\t\tthis.x,\n\t\t\tthis.y,\n\t\t\tthis.pivot.x,\n\t\t\tthis.pivot.y,\n\t\t\t// Converts degrees to radians\n\t\t\tthis.angle * Math.PI / 180,\n\t\t\tthis.scale\n\t\t);\n\n\t\tthis._matrix.copyFrom(this._localMatrix);\n\n\t\tif (this._parent) {\n\t\t\t// TODO only calculate this if it has actually changed\n\t\t\tthis._matrix.prepend(this._parent._matrix);\n\t\t}\n\t}\n\n\tpublic _transform(context: CanvasRenderingContext2D, resolution: number): void {\n\t\tconst m = this._matrix;\n\t\tcontext.setTransform(\n\t\t\tm.a * resolution,\n\t\t\tm.b * resolution,\n\t\t\tm.c * resolution,\n\t\t\tm.d * resolution,\n\t\t\tm.tx * resolution,\n\t\t\tm.ty * resolution\n\t\t);\n\t}\n\n\tpublic render(parentLayer: CanvasLayer): void {\n\t\tif (this.visible && (this.exportable !== false || !this._renderer._omitTainted)) {\n\t\t\tthis._setMatrix();\n\n\t\t\tconst resolution = this._renderer.resolution;\n\n\t\t\tconst layers = this._renderer.layers;\n\t\t\tconst ghostContext = this._renderer._ghostContext;\n\n\t\t\tconst mask = this.mask;\n\t\t\tif (mask) {\n\t\t\t\tmask._setMatrix();\n\t\t\t}\n\n\t\t\t// TODO improve this\n\t\t\t$array.each(layers, (layer) => {\n\t\t\t\tif (layer) {\n\t\t\t\t\tconst context = layer.context;\n\t\t\t\t\tcontext.save();\n\n\t\t\t\t\t// We must apply the mask before we transform the element\n\t\t\t\t\tif (mask) {\n\t\t\t\t\t\tmask._transform(context, layer.scale || resolution);\n\t\t\t\t\t\tmask._runPath(context);\n\t\t\t\t\t\tcontext.clip();\n\t\t\t\t\t}\n\n\t\t\t\t\tcontext.globalAlpha = this.compoundAlpha * this.alpha;\n\n\t\t\t\t\tthis._transform(context, layer.scale || resolution);\n\n\t\t\t\t\tif (this.filter) {\n\t\t\t\t\t\tcontext.filter = this.filter;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tghostContext.save();\n\n\t\t\t// We must apply the mask before we transform the element\n\t\t\tif (mask && this._isInteractiveMask()) {\n\t\t\t\tmask._transform(ghostContext, resolution);\n\t\t\t\tmask._runPath(ghostContext);\n\t\t\t\tghostContext.clip();\n\t\t\t}\n\n\t\t\tthis._transform(ghostContext, resolution);\n\n\t\t\tthis._render(parentLayer);\n\n\t\t\tghostContext.restore();\n\n\t\t\t$array.each(layers, (layer) => {\n\t\t\t\tif (layer) {\n\t\t\t\t\tlayer.context.restore();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tprotected _render(parentLayer: CanvasLayer): void {\n\t\tif (this.exportable === false) {\n\t\t\tconst layer = this._layer || parentLayer;\n\t\t\tlayer.tainted = true;\n\t\t}\n\t}\n\n\thovering(): boolean {\n\t\treturn this._renderer._hovering.has(this);\n\t}\n\n\tdragging(): boolean {\n\t\treturn this._renderer._dragging.some((x) => x.value === this);\n\t}\n\n\tpublic dispose() {\n\t\tthis.getLayer().dirty = true;\n\t}\n\n\tpublic shouldCancelTouch(): boolean {\n\t\tconst renderer = this._renderer;\n\t\tif (renderer.tapToActivate && !renderer._touchActive) {\n\t\t\treturn false;\n\t\t}\n\t\tif (this.cancelTouch) {\n\t\t\treturn true;\n\t\t}\n\t\telse if (this._parent) {\n\t\t\treturn this._parent.shouldCancelTouch();\n\t\t}\n\t\treturn false;\n\t}\n\n}\n\n/**\n * @ignore\n */\nexport class CanvasContainer extends CanvasDisplayObject implements IContainer {\n\tpublic interactiveChildren: boolean = true;\n\tprivate _childLayers?: CanvasLayer[];\n\n\tprotected _children: Array<CanvasDisplayObject> = [];\n\n\tprotected _isInteractiveMask(): boolean {\n\t\treturn this.interactiveChildren || super._isInteractiveMask();\n\t}\n\n\taddChild(child: CanvasDisplayObject): void {\n\t\tchild._parent = this;\n\t\tthis._children.push(child);\n\t\tif (child._layer) {\n\t\t\tthis.registerChildLayer(child._layer);\n\t\t}\n\t}\n\n\taddChildAt(child: CanvasDisplayObject, index: number): void {\n\t\tchild._parent = this;\n\t\tthis._children.splice(index, 0, child);\n\t\tif (child._layer) {\n\t\t\tthis.registerChildLayer(child._layer);\n\t\t}\n\t}\n\n\tremoveChild(child: CanvasDisplayObject): void {\n\t\tchild._parent = undefined;\n\t\t$array.removeFirst(this._children, child);\n\t}\n\n\tprotected _render(parentLayer: CanvasLayer): void {\n\t\tsuper._render(parentLayer);\n\n\t\tconst renderer = this._renderer;\n\n\t\tif (this.interactive && this.interactiveChildren) {\n\t\t\t++renderer._forceInteractive;\n\t\t}\n\n\t\tconst layer = this._layer || parentLayer;\n\n\t\t$array.each(this._children, (child) => {\n\t\t\tchild.compoundAlpha = this.compoundAlpha * this.alpha;\n\t\t\tchild.render(layer);\n\t\t});\n\n\t\tif (this.interactive && this.interactiveChildren) {\n\t\t\t--renderer._forceInteractive;\n\t\t}\n\t}\n\n\tregisterChildLayer(layer: CanvasLayer): void {\n\t\tif (!this._childLayers) {\n\t\t\tthis._childLayers = [];\n\t\t}\n\t\t$array.pushOne(this._childLayers, layer);\n\t\tif (this._parent) {\n\t\t\tthis._parent.registerChildLayer(layer);\n\t\t}\n\t}\n\n\tpublic markDirtyLayer(deep: boolean = false): void {\n\t\tsuper.markDirtyLayer();\n\t\tif (deep && this._childLayers) {\n\t\t\t$array.each(this._childLayers, (layer) => layer.dirty = true);\n\t\t}\n\t}\n\n\tpublic dispose() {\n\t\tsuper.dispose();\n\t\tif (this._childLayers) {\n\t\t\t$array.each(this._childLayers, (layer) => {\n\t\t\t\tlayer.dirty = true;\n\t\t\t});\n\t\t}\n\t}\n}\n\n/**\n * @ignore\n */\nfunction setPoint(bounds: IBounds, point: IPoint): void {\n\tbounds.left = Math.min(bounds.left, point.x);\n\tbounds.top = Math.min(bounds.top, point.y);\n\tbounds.right = Math.max(bounds.right, point.x);\n\tbounds.bottom = Math.max(bounds.bottom, point.y);\n}\n\n/**\n * @ignore\n */\nabstract class Op {\n\tpublic colorize(_context: CanvasRenderingContext2D, _forceColor: string | undefined): void { }\n\n\tpublic path(_context: CanvasRenderingContext2D): void { }\n\n\tpublic addBounds(_bounds: IBounds): void { }\n}\n\n/**\n * @ignore\n */\nclass BeginFill extends Op {\n\tconstructor(public color: string | CanvasGradient | CanvasPattern) { super(); }\n\n\tpublic colorize(context: CanvasRenderingContext2D, forceColor: string | undefined): void {\n\t\tif (forceColor !== undefined) {\n\t\t\tcontext.fillStyle = forceColor;\n\n\t\t} else {\n\t\t\tcontext.fillStyle = this.color;\n\t\t}\n\t}\n}\n\n/**\n * @ignore\n */\nclass EndFill extends Op {\n\tconstructor(public clearShadow: boolean) { super(); }\n\tpublic colorize(context: CanvasRenderingContext2D, _forceColor: string | undefined): void {\n\t\tcontext.fill();\n\t\tif (this.clearShadow) {\n\t\t\tcontext.shadowColor = \"\";\n\t\t\tcontext.shadowBlur = 0;\n\t\t\tcontext.shadowOffsetX = 0;\n\t\t\tcontext.shadowOffsetY = 0;\n\t\t}\n\t}\n}\n\n/**\n * @ignore\n */\nclass EndStroke extends Op {\n\tpublic colorize(context: CanvasRenderingContext2D, _forceColor: string | undefined): void {\n\t\tcontext.stroke();\n\t}\n}\n\n/**\n * @ignore\n */\nclass LineStyle extends Op {\n\tconstructor(public width: number, public color: string | CanvasGradient | CanvasPattern, public lineJoin?: \"miter\" | \"round\" | \"bevel\") { super(); }\n\n\tpublic colorize(context: CanvasRenderingContext2D, forceColor: string | undefined): void {\n\t\tif (forceColor !== undefined) {\n\t\t\tcontext.strokeStyle = forceColor;\n\n\t\t} else {\n\t\t\tcontext.strokeStyle = this.color;\n\t\t}\n\n\t\tcontext.lineWidth = this.width;\n\t\tif (this.lineJoin) {\n\t\t\tcontext.lineJoin = this.lineJoin;\n\t\t}\n\t}\n}\n\n/**\n * @ignore\n */\nclass LineDash extends Op {\n\tconstructor(public dash: number[]) { super(); }\n\n\tpublic colorize(context: CanvasRenderingContext2D, _forceColor: string | undefined): void {\n\t\tcontext.setLineDash(this.dash);\n\t}\n}\n\n/**\n * @ignore\n */\nclass LineDashOffset extends Op {\n\tconstructor(public dashOffset: number) { super(); }\n\n\tpublic colorize(context: CanvasRenderingContext2D, _forceColor: string | undefined): void {\n\t\tcontext.lineDashOffset = this.dashOffset;\n\t}\n}\n\n/**\n * @ignore\n */\nclass DrawRect extends Op {\n\tconstructor(public x: number, public y: number, public width: number, public height: number) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.rect(this.x, this.y, this.width, this.height);\n\t}\n\n\tpublic addBounds(bounds: IBounds): void {\n\t\tconst l = this.x;\n\t\tconst t = this.y;\n\t\tconst r = l + this.width;\n\t\tconst b = t + this.height;\n\n\t\tsetPoint(bounds, { x: l, y: t });\n\t\tsetPoint(bounds, { x: r, y: t });\n\t\tsetPoint(bounds, { x: l, y: b });\n\t\tsetPoint(bounds, { x: r, y: b });\n\t}\n}\n\n/**\n * @ignore\n */\nclass DrawCircle extends Op {\n\tconstructor(public x: number, public y: number, public radius: number) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.moveTo(this.x + this.radius, this.y);\n\t\tcontext.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);\n\t}\n\n\t// TODO handle skewing and rotation\n\tpublic addBounds(bounds: IBounds): void {\n\t\tsetPoint(bounds, { x: this.x - this.radius, y: this.y - this.radius });\n\t\tsetPoint(bounds, { x: this.x + this.radius, y: this.y + this.radius });\n\t}\n}\n\n/**\n * @ignore\n */\nclass DrawEllipse extends Op {\n\tconstructor(public x: number, public y: number, public radiusX: number, public radiusY: number) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.ellipse(0, 0, this.radiusX, this.radiusY, 0, 0, Math.PI * 2);\n\t}\n\n\t// TODO handle skewing and rotation\n\tpublic addBounds(bounds: IBounds): void {\n\t\tsetPoint(bounds, { x: this.x - this.radiusX, y: this.y - this.radiusY });\n\t\tsetPoint(bounds, { x: this.x + this.radiusX, y: this.y + this.radiusY });\n\t}\n}\n\n/**\n * @ignore\n */\nclass Arc extends Op {\n\tconstructor(\n\t\tpublic cx: number,\n\t\tpublic cy: number,\n\t\tpublic radius: number,\n\t\tpublic startAngle: number,\n\t\tpublic endAngle: number,\n\t\tpublic anticlockwise: boolean,\n\t) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tif (this.radius > 0) {\n\t\t\tcontext.arc(this.cx, this.cy, this.radius, this.startAngle, this.endAngle, this.anticlockwise);\n\t\t}\n\t}\n\n\tpublic addBounds(bounds: IBounds): void {\n\t\tlet arcBounds = $math.getArcBounds(this.cx, this.cy, this.startAngle * $math.DEGREES, this.endAngle * $math.DEGREES, this.radius);\n\t\tsetPoint(bounds, { x: arcBounds.left, y: arcBounds.top });\n\t\tsetPoint(bounds, { x: arcBounds.right, y: arcBounds.bottom });\n\t}\n}\n\n/**\n * @ignore\n */\nclass ArcTo extends Op {\n\tconstructor(\n\t\tpublic x1: number,\n\t\tpublic y1: number,\n\t\tpublic x2: number,\n\t\tpublic y2: number,\n\t\tpublic radius: number,\n\t) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tif (this.radius > 0) {\n\t\t\tcontext.arcTo(this.x1, this.y1, this.x2, this.y2, this.radius);\n\t\t}\n\t}\n\n\t// TODO: add points\n\tpublic addBounds(_bounds: IBounds): void {\n\t\t/*\n\t\t// not finished\n\t\thttps://math.stackexchange.com/questions/1781438/finding-the-center-of-a-circle-given-two-points-and-a-radius-algebraically\n\n\t\tif (prevPoint) {\n\t\t\tlet x1 = prevPoint.x;\n\t\t\tlet y1 = prevPoint.y;\n\t\t\tlet x2 = this.x2;\n\t\t\tlet y2 = this.y2;\n\t\t\tlet r = this.radius;\n\n\t\t\tlet xa = (x2 - x1) / 2;\n\t\t\tlet ya = (y2 - y1) / 2;\n\n\t\t\tlet x0 = x1 + xa;\n\t\t\tlet y0 = y1 + ya;\n\n\t\t\tlet a = Math.hypot(xa, ya);\n\t\t\tlet b = Math.sqrt(r * r - a * a);\n\n\t\t\tlet cx = x0 + b * ya / a;\n\t\t\tlet cy = y0 - b * xa / a;\n\n\t\t\tconsole.log(cx, cy);\n\t\t}*/\n\t}\n}\n\n/**\n * @ignore\n */\nclass LineTo extends Op {\n\tconstructor(public x: number, public y: number) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.lineTo(this.x, this.y);\n\t}\n\n\tpublic addBounds(bounds: IBounds): void {\n\t\tsetPoint(bounds, { x: this.x, y: this.y });\n\t}\n}\n\n/**\n * @ignore\n */\nclass MoveTo extends Op {\n\tconstructor(public x: number, public y: number) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.moveTo(this.x, this.y);\n\t}\n\n\tpublic addBounds(bounds: IBounds): void {\n\t\tsetPoint(bounds, { x: this.x, y: this.y });\n\t}\n}\n\n/**\n * @ignore\n */\nclass ClosePath extends Op {\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.closePath();\n\t}\n}\n\n/**\n * @ignore\n */\nclass BezierCurveTo extends Op {\n\tconstructor(\n\t\tpublic cpX: number,\n\t\tpublic cpY: number,\n\t\tpublic cpX2: number,\n\t\tpublic cpY2: number,\n\t\tpublic toX: number,\n\t\tpublic toY: number,\n\t) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.bezierCurveTo(this.cpX, this.cpY, this.cpX2, this.cpY2, this.toX, this.toY);\n\t}\n\n\t// TODO: OK?\n\tpublic addBounds(bounds: IBounds): void {\n\t\tsetPoint(bounds, { x: this.cpX, y: this.cpY });\n\t\tsetPoint(bounds, { x: this.cpX2, y: this.cpY2 });\n\t\tsetPoint(bounds, { x: this.toX, y: this.toY });\n\t}\n}\n\n/**\n * @ignore\n */\nclass QuadraticCurveTo extends Op {\n\tconstructor(\n\t\tpublic cpX: number,\n\t\tpublic cpY: number,\n\t\tpublic toX: number,\n\t\tpublic toY: number,\n\t) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.quadraticCurveTo(this.cpX, this.cpY, this.toX, this.toY);\n\t}\n\n\t// TODO: OK?\n\tpublic addBounds(bounds: IBounds): void {\n\t\tsetPoint(bounds, { x: this.cpX, y: this.cpY });\n\t\tsetPoint(bounds, { x: this.toX, y: this.toY });\n\t}\n}\n\n/**\n * @ignore\n */\nclass Shadow extends Op {\n\tconstructor(\n\t\tpublic color: string,\n\t\tpublic blur: number,\n\t\tpublic offsetX: number,\n\t\tpublic offsetY: number,\n\t\tpublic opacity?: number\n\t) { super(); }\n\n\tpublic colorize(context: CanvasRenderingContext2D, _forceColor: string | undefined): void {\n\t\tif (this.opacity) {\n\t\t\tcontext.fillStyle = this.color;\n\t\t}\n\t\tcontext.shadowColor = this.color;\n\t\tcontext.shadowBlur = this.blur;\n\t\tcontext.shadowOffsetX = this.offsetX;\n\t\tcontext.shadowOffsetY = this.offsetY;\n\t}\n}\n\n/**\n * @ignore\n */\nclass GraphicsImage extends Op {\n\tconstructor(\n\t\tpublic image: HTMLImageElement,\n\t\tpublic width: number,\n\t\tpublic height: number,\n\t\tpublic x: number,\n\t\tpublic y: number\n\t) { super(); }\n\n\tpublic path(context: CanvasRenderingContext2D): void {\n\t\tcontext.drawImage(this.image, this.x, this.y, this.width, this.height);\n\t}\n\n\t// TODO: OK?\n\tpublic addBounds(bounds: IBounds): void {\n\t\tsetPoint(bounds, { x: this.x, y: this.y });\n\t\tsetPoint(bounds, { x: this.width, y: this.height });\n\t}\n}\n\n/**\n * @ignore\n */\nexport class CanvasGraphics extends CanvasDisplayObject implements IGraphics {\n\tprotected _operations: Array<Op> = [];\n\n\tpublic blendMode: BlendMode = BlendMode.NORMAL;\n\n\tprotected _hasShadows: boolean = false;\n\tprotected _fillAlpha?: number;\n\tprotected _strokeAlpha?: number;\n\n\tclear(): void {\n\t\tsuper.clear();\n\t\tthis._operations.length = 0;\n\t}\n\n\tprotected _pushOp(op: Op): void {\n\t\tthis._operations.push(op);\n\t}\n\n\tbeginFill(color?: Color | CanvasGradient | CanvasPattern, alpha: number = 1): void {\n\t\tthis._fillAlpha = alpha;\n\t\tif (color) {\n\t\t\tif (color instanceof Color) {\n\t\t\t\tthis._pushOp(new BeginFill(color.toCSS(alpha)));\n\n\t\t\t} else {\n\t\t\t\tthis.isMeasured = true;\n\t\t\t\tthis._pushOp(new BeginFill(color));\n\t\t\t}\n\t\t} else {\n\t\t\tthis._pushOp(new BeginFill(\"rgba(0, 0, 0, \" + alpha + \")\"));\n\t\t}\n\t}\n\n\tendFill(): void {\n\t\tthis._pushOp(new EndFill(this._hasShadows));\n\t}\n\n\tendStroke(): void {\n\t\tthis._pushOp(new EndStroke());\n\t}\n\n\tlineStyle(width: number = 0, color?: Color | CanvasGradient | CanvasPattern, alpha: number = 1, lineJoin?: \"miter\" | \"round\" | \"bevel\"): void {\n\t\tthis._strokeAlpha = alpha;\n\t\tif (color) {\n\t\t\tif (color instanceof Color) {\n\t\t\t\tthis._pushOp(new LineStyle(width, color.toCSS(alpha), lineJoin));\n\t\t\t} else {\n\t\t\t\tthis._pushOp(new LineStyle(width, color, lineJoin));\n\t\t\t}\n\t\t} else {\n\t\t\tthis._pushOp(new LineStyle(width, \"rgba(0, 0, 0, \" + alpha + \")\", lineJoin));\n\t\t}\n\t}\n\n\tsetLineDash(dash?: number[]): void {\n\t\tthis._pushOp(new LineDash(dash ? dash : []));\n\t}\n\n\tsetLineDashOffset(dashOffset: number = 0): void {\n\t\tthis._pushOp(new LineDashOffset(dashOffset));\n\t}\n\n\tdrawRect(x: number, y: number, width: number, height: number): void {\n\t\tthis._pushOp(new DrawRect(x, y, width, height));\n\t}\n\n\tdrawCircle(x: number, y: number, radius: number): void {\n\t\tthis._pushOp(new DrawCircle(x, y, radius));\n\t}\n\n\tdrawEllipse(x: number, y: number, radiusX: number, radiusY: number): void {\n\t\tthis._pushOp(new DrawEllipse(x, y, radiusX, radiusY));\n\t}\n\n\tarc(cx: number, cy: number, radius: number, startAngle: number, endAngle: number, anticlockwise: boolean = false): void {\n\t\tthis._pushOp(new Arc(cx, cy, radius, startAngle, endAngle, anticlockwise));\n\t}\n\n\tarcTo(x1: number, y1: number, x2: number, y2: number, radius: number): void {\n\t\tthis._pushOp(new ArcTo(x1, y1, x2, y2, radius));\n\t}\n\n\tlineTo(x: number, y: number): void {\n\t\tthis._pushOp(new LineTo(x, y));\n\t}\n\n\tmoveTo(x: number, y: number): void {\n\t\tthis._pushOp(new MoveTo(x, y));\n\t}\n\n\tbezierCurveTo(cpX: number, cpY: number, cpX2: number, cpY2: number, toX: number, toY: number): void {\n\t\tthis._pushOp(new BezierCurveTo(cpX, cpY, cpX2, cpY2, toX, toY));\n\t}\n\n\tquadraticCurveTo(cpX: number, cpY: number, toX: number, toY: number): void {\n\t\tthis._pushOp(new QuadraticCurveTo(cpX, cpY, toX, toY));\n\t}\n\n\tclosePath(): void {\n\t\tthis._pushOp(new ClosePath());\n\t}\n\n\tshadow(color: Color, blur: number = 0, offsetX: number = 0, offsetY: number = 0, opacity?: number): void {\n\t\tthis._hasShadows = true;\n\t\tthis._pushOp(new Shadow(opacity ? color.toCSS(opacity) : color.toCSS(this._fillAlpha || this._strokeAlpha), blur, offsetX, offsetY));\n\t}\n\n\timage(image: HTMLImageElement, width: number, height: number, x: number, y: number): void {\n\t\tthis._pushOp(new GraphicsImage(image, width, height, x, y));\n\t}\n\n\t// https://svgwg.org/svg2-draft/paths.html#DProperty\n\t// TODO better error checking\n\tsvgPath(path: string): void {\n\t\tlet x = 0;\n\t\tlet y = 0;\n\t\tlet cpx: number | null = null;\n\t\tlet cpy: number | null = null;\n\t\tlet qcpx: number | null = null;\n\t\tlet qcpy: number | null = null;\n\n\t\tconst SEGMENTS_REGEXP = /([MmZzLlHhVvCcSsQqTtAa])([^MmZzLlHhVvCcSsQqTtAa]*)/g;\n\t\tconst ARGS_REGEXP = /[\\u0009\\u0020\\u000A\\u000C\\u000D]*([\\+\\-]?[0-9]*\\.?[0-9]+(?:[eE][\\+\\-]?[0-9]+)?)[\\u0009\\u0020\\u000A\\u000C\\u000D]*,?/g;\n\n\t\tlet match;\n\n\t\twhile ((match = SEGMENTS_REGEXP.exec(path)) !== null) {\n\t\t\tconst name = match[1];\n\t\t\tconst rest = match[2];\n\n\t\t\tconst args = [];\n\n\t\t\twhile ((match = ARGS_REGEXP.exec(rest)) !== null) {\n\t\t\t\targs.push(+match[1]);\n\t\t\t}\n\n\t\t\t// Reset control point\n\t\t\tif (name !== \"S\" && name !== \"s\" && name !== \"C\" && name !== \"c\") {\n\t\t\t\tcpx = null;\n\t\t\t\tcpy = null;\n\t\t\t}\n\n\t\t\t// Reset control point\n\t\t\tif (name !== \"Q\" && name !== \"q\" && name !== \"T\" && name !== \"t\") {\n\t\t\t\tqcpx = null;\n\t\t\t\tqcpy = null;\n\t\t\t}\n\n\t\t\tswitch (name) {\n\t\t\t\tcase \"M\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 2);\n\t\t\t\t\tx = args[0];\n\t\t\t\t\ty = args[1];\n\t\t\t\t\tthis.moveTo(x, y);\n\n\t\t\t\t\tfor (let i = 2; i < args.length; i += 2) {\n\t\t\t\t\t\tx = args[i];\n\t\t\t\t\t\ty = args[i + 1];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"m\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 2);\n\t\t\t\t\tx += args[0];\n\t\t\t\t\ty += args[1];\n\t\t\t\t\tthis.moveTo(x, y);\n\n\t\t\t\t\tfor (let i = 2; i < args.length; i += 2) {\n\t\t\t\t\t\tx += args[i];\n\t\t\t\t\t\ty += args[i + 1];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"L\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 2);\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 2) {\n\t\t\t\t\t\tx = args[i];\n\t\t\t\t\t\ty = args[i + 1];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"l\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 2);\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 2) {\n\t\t\t\t\t\tx += args[i];\n\t\t\t\t\t\ty += args[i + 1];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"H\":\n\t\t\t\t\tcheckMinArgs(name, args.length, 1);\n\t\t\t\t\tfor (let i = 0; i < args.length; ++i) {\n\t\t\t\t\t\tx = args[i];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"h\":\n\t\t\t\t\tcheckMinArgs(name, args.length, 1);\n\t\t\t\t\tfor (let i = 0; i < args.length; ++i) {\n\t\t\t\t\t\tx += args[i];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"V\":\n\t\t\t\t\tcheckMinArgs(name, args.length, 1);\n\t\t\t\t\tfor (let i = 0; i < args.length; ++i) {\n\t\t\t\t\t\ty = args[i];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"v\":\n\t\t\t\t\tcheckMinArgs(name, args.length, 1);\n\t\t\t\t\tfor (let i = 0; i < args.length; ++i) {\n\t\t\t\t\t\ty += args[i];\n\t\t\t\t\t\tthis.lineTo(x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"C\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 6);\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 6) {\n\t\t\t\t\t\tconst x1 = args[i];\n\t\t\t\t\t\tconst y1 = args[i + 1];\n\t\t\t\t\t\tcpx = args[i + 2];\n\t\t\t\t\t\tcpy = args[i + 3];\n\t\t\t\t\t\tx = args[i + 4];\n\t\t\t\t\t\ty = args[i + 5];\n\t\t\t\t\t\tthis.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"c\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 6);\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 6) {\n\t\t\t\t\t\tconst x1 = args[i] + x;\n\t\t\t\t\t\tconst y1 = args[i + 1] + y;\n\t\t\t\t\t\tcpx = args[i + 2] + x;\n\t\t\t\t\t\tcpy = args[i + 3] + y;\n\t\t\t\t\t\tx += args[i + 4];\n\t\t\t\t\t\ty += args[i + 5];\n\t\t\t\t\t\tthis.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"S\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 4);\n\t\t\t\t\tif (cpx === null || cpy === null) {\n\t\t\t\t\t\tcpx = x;\n\t\t\t\t\t\tcpy = y;\n\t\t\t\t\t}\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 4) {\n\t\t\t\t\t\tconst x1 = 2 * x - cpx;\n\t\t\t\t\t\tconst y1 = 2 * y - cpy;\n\t\t\t\t\t\tcpx = args[i];\n\t\t\t\t\t\tcpy = args[i + 1];\n\t\t\t\t\t\tx = args[i + 2];\n\t\t\t\t\t\ty = args[i + 3];\n\t\t\t\t\t\tthis.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"s\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 4);\n\t\t\t\t\tif (cpx === null || cpy === null) {\n\t\t\t\t\t\tcpx = x;\n\t\t\t\t\t\tcpy = y;\n\t\t\t\t\t}\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 4) {\n\t\t\t\t\t\tconst x1 = 2 * x - cpx;\n\t\t\t\t\t\tconst y1 = 2 * y - cpy;\n\t\t\t\t\t\tcpx = args[i] + x;\n\t\t\t\t\t\tcpy = args[i + 1] + y;\n\t\t\t\t\t\tx += args[i + 2];\n\t\t\t\t\t\ty += args[i + 3];\n\t\t\t\t\t\tthis.bezierCurveTo(x1, y1, cpx, cpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"Q\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 4);\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 4) {\n\t\t\t\t\t\tqcpx = args[i];\n\t\t\t\t\t\tqcpy = args[i + 1];\n\t\t\t\t\t\tx = args[i + 2];\n\t\t\t\t\t\ty = args[i + 3];\n\t\t\t\t\t\tthis.quadraticCurveTo(qcpx, qcpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"q\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 4);\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 4) {\n\t\t\t\t\t\tqcpx = args[i] + x;\n\t\t\t\t\t\tqcpy = args[i + 1] + y;\n\t\t\t\t\t\tx += args[i + 2];\n\t\t\t\t\t\ty += args[i + 3];\n\t\t\t\t\t\tthis.quadraticCurveTo(qcpx, qcpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"T\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 2);\n\t\t\t\t\tif (qcpx === null || qcpy === null) {\n\t\t\t\t\t\tqcpx = x;\n\t\t\t\t\t\tqcpy = y;\n\t\t\t\t\t}\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 2) {\n\t\t\t\t\t\tqcpx = 2 * x - qcpx;\n\t\t\t\t\t\tqcpy = 2 * y - qcpy;\n\t\t\t\t\t\tx = args[i];\n\t\t\t\t\t\ty = args[i + 1];\n\t\t\t\t\t\tthis.quadraticCurveTo(qcpx, qcpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"t\":\n\t\t\t\t\tcheckEvenArgs(name, args.length, 2);\n\t\t\t\t\tif (qcpx === null || qcpy === null) {\n\t\t\t\t\t\tqcpx = x;\n\t\t\t\t\t\tqcpy = y;\n\t\t\t\t\t}\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 2) {\n\t\t\t\t\t\tqcpx = 2 * x - qcpx;\n\t\t\t\t\t\tqcpy = 2 * y - qcpy;\n\t\t\t\t\t\tx += args[i];\n\t\t\t\t\t\ty += args[i + 1];\n\t\t\t\t\t\tthis.quadraticCurveTo(qcpx, qcpy, x, y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase \"A\":\n\t\t\t\tcase \"a\":\n\t\t\t\t\tconst relative = (name === \"a\");\n\n\t\t\t\t\tcheckEvenArgs(name, args.length, 7);\n\n\t\t\t\t\tfor (let i = 0; i < args.length; i += 7) {\n\t\t\t\t\t\tlet cx = args[i + 5];\n\t\t\t\t\t\tlet cy = args[i + 6];\n\n\t\t\t\t\t\tif (relative) {\n\t\t\t\t\t\t\tcx += x;\n\t\t\t\t\t\t\tcy += y;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst bs = arcToBezier({\n\t\t\t\t\t\t\tpx: x,\n\t\t\t\t\t\t\tpy: y,\n\t\t\t\t\t\t\trx: args[i],\n\t\t\t\t\t\t\try: args[i + 1],\n\t\t\t\t\t\t\txAxisRotation: args[i + 2],\n\t\t\t\t\t\t\tlargeArcFlag: assertBinary(args[i + 3]),\n\t\t\t\t\t\t\tsweepFlag: assertBinary(args[i + 4]),\n\t\t\t\t\t\t\tcx,\n\t\t\t\t\t\t\tcy,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t$array.each(bs, (b) => {\n\t\t\t\t\t\t\tthis.bezierCurveTo(b.x1, b.y1, b.x2, b.y2, b.x, b.y);\n\t\t\t\t\t\t\tx = b.x;\n\t\t\t\t\t\t\ty = b.y;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"Z\":\n\t\t\t\tcase \"z\":\n\t\t\t\t\tcheckArgs(name, args.length, 0);\n\t\t\t\t\tthis.closePath();\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\n\tpublic _runPath(context: CanvasRenderingContext2D): void {\n\t\tcontext.beginPath();\n\n\t\t$array.each(this._operations, (op) => {\n\t\t\top.path(context);\n\t\t});\n\t}\n\n\tprotected _render(parentLayer: CanvasLayer): void {\n\t\tsuper._render(parentLayer);\n\n\t\tconst layer = this._layer || parentLayer;\n\n\t\tconst layerDirty = layer.dirty;\n\t\tconst interactive = this._isInteractive();\n\n\t\tif (layerDirty || interactive) {\n\n\t\t\tconst context = layer.context;\n\t\t\tconst ghostContext = this._renderer._ghostContext;\n\n\t\t\tif (layerDirty) {\n\t\t\t\tcontext.globalCompositeOperation = this.blendMode;\n\n\t\t\t\tcontext.beginPath();\n\t\t\t}\n\n\t\t\tlet color: string | undefined;\n\n\t\t\tif (interactive) {\n\t\t\t\tghostContext.beginPath();\n\t\t\t\tcolor = this._getColorId();\n\t\t\t}\n\n\t\t\t$array.each(this._operations, (op) => {\n\t\t\t\tif (layerDirty) {\n\t\t\t\t\top.path(context);\n\t\t\t\t\top.colorize(context, undefined);\n\t\t\t\t}\n\n\t\t\t\tif (interactive) {\n\t\t\t\t\top.path(ghostContext);\n\t\t\t\t\top.colorize(ghostContext, color);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tpublic renderDetached(context: CanvasRenderingContext2D): void {\n\t\tif (this.visible) {\n\t\t\tthis._setMatrix();\n\n\t\t\tcontext.save();\n\n\t\t\t// We must apply the mask before we transform the element\n\t\t\tconst mask = this.mask;\n\t\t\tif (mask) {\n\t\t\t\tmask._setMatrix();\n\t\t\t\tmask._transform(context, 1);\n\t\t\t\tmask._runPath(context);\n\t\t\t\tcontext.clip();\n\t\t\t}\n\n\t\t\t// TODO handle compoundAlpha somehow ?\n\t\t\tcontext.globalAlpha = this.compoundAlpha * this.alpha;\n\n\t\t\tthis._transform(context, 1);\n\n\t\t\tif (this.filter) {\n\t\t\t\tcontext.filter = this.filter;\n\t\t\t}\n\n\t\t\tcontext.globalCompositeOperation = this.blendMode;\n\n\t\t\tcontext.beginPath();\n\n\t\t\t$array.each(this._operations, (op) => {\n\t\t\t\top.path(context);\n\t\t\t\top.colorize(context, undefined);\n\t\t\t});\n\n\t\t\tcontext.restore();\n\t\t}\n\t}\n\n\tpublic _addBounds(bounds: IBounds): void {\n\t\tif (this.visible && this.isMeasured) {\n\t\t\t$array.each(this._operations, (op) => {\n\t\t\t\top.addBounds(bounds);\n\t\t\t});\n\t\t}\n\t}\n}\n\n/**\n * @ignore\n */\ninterface ILineChunk {\n\tstyle: string | undefined,\n\tfill: Color | undefined,\n\ttext: string,\n\twidth: number,\n\theight: number,\n\tleft: number,\n\tright: number,\n\tascent: number,\n\toffsetX: number,\n\toffsetY: number,\n\ttextDecoration: string | undefined,\n\tverticalAlign?: \"baseline\" | \"sub\" | \"super\"\n}\n\n/**\n * @ignore\n */\ninterface ILine {\n\toffsetY: number,\n\tascent: number,\n\twidth: number,\n\theight: number,\n\tleft: number,\n\tright: number,\n\ttextChunks: Array<ILineChunk>,\n}\n\n/**\n * @ignore\n */\nexport class CanvasText extends CanvasDisplayObject implements IText {\n\tpublic text: string;\n\tpublic style: CanvasTextStyle;\n\tpublic resolution: number = 1;\n\n\tprotected _textInfo: Array<ILine> | undefined;\n\tprotected _textVisible: boolean = true;\n\tprotected _originalScale?: number = 1;\n\n\tconstructor(renderer: CanvasRenderer, text: string, style: CanvasTextStyle) {\n\t\tsuper(renderer);\n\t\tthis.text = text;\n\t\tthis.style = style;\n\t}\n\n\tpublic invalidateBounds(): void {\n\t\tsuper.invalidateBounds();\n\t\tthis._textInfo = undefined;\n\t}\n\n\tprivate _shared(context: CanvasRenderingContext2D) {\n\t\tif (this.style.textAlign) {\n\t\t\tcontext.textAlign = this.style.textAlign;\n\t\t}\n\n\t\tif (this.style.direction) {\n\t\t\tcontext.direction = this.style.direction;\n\t\t}\n\n\t\tif (this.style.textBaseline) {\n\t\t\tcontext.textBaseline = this.style.textBaseline;\n\t\t}\n\n\t}\n\n\tprotected _prerender(layer: CanvasLayer, ignoreGhost = false, ignoreFontWeight = false): void {\n\t\tsuper._render(layer);\n\n\t\tconst context = layer.context;\n\t\tconst ghostContext = this._renderer._ghostContext;\n\n\t\t// Font style\n\n\t\tconst style = this.style;\n\t\tlet fontStyle = this._getFontStyle(undefined, ignoreFontWeight);\n\n\t\tcontext.font = fontStyle;\n\t\tif (this._isInteractive() && !ignoreGhost) {\n\t\t\tghostContext.font = fontStyle;\n\t\t}\n\n\t\t// Other parameters\n\t\tif (style.fill) {\n\t\t\tif (style.fill instanceof Color) {\n\t\t\t\tcontext.fillStyle = style.fill.toCSS();\n\t\t\t} else {\n\t\t\t\tcontext.fillStyle = style.fill;\n\t\t\t}\n\t\t}\n\n\t\tif (style.shadowColor) {\n\t\t\tlayer.context.shadowColor = style.shadowColor.toCSS(style.shadowOpacity || 1);\n\t\t}\n\t\tif (style.shadowBlur) {\n\t\t\tlayer.context.shadowBlur = style.shadowBlur;\n\t\t}\n\t\tif (style.shadowOffsetX) {\n\t\t\tlayer.context.shadowOffsetX = style.shadowOffsetX;\n\t\t}\n\t\tif (style.shadowOffsetY) {\n\t\t\tlayer.context.shadowOffsetY = style.shadowOffsetY;\n\t\t}\n\n\t\tthis._shared(context);\n\n\t\tif (this._isInteractive() && !ignoreGhost) {\n\t\t\tghostContext.fillStyle = this._getColorId();\n\t\t\tthis._shared(ghostContext);\n\t\t}\n\t}\n\n\tprotected _getFontStyle(style2?: ITextStyle, ignoreFontWeight = false): string {\n\n\t\t// Process defaults\n\t\tconst style = this.style;\n\t\tlet fontStyle: string[] = [];\n\n\t\tif (style2 && style2.fontVariant) {\n\t\t\tfontStyle.push(style2.fontVariant);\n\t\t}\n\t\telse if (style.fontVariant) {\n\t\t\tfontStyle.push(style.fontVariant);\n\t\t}\n\n\t\tif (!ignoreFontWeight) {\n\t\t\tif (style2 && style2.fontWeight) {\n\t\t\t\tfontStyle.push(style2.fontWeight);\n\t\t\t}\n\t\t\telse if (style.fontWeight) {\n\t\t\t\tfontStyle.push(style.fontWeight);\n\t\t\t}\n\t\t}\n\n\t\tif (style2 && style2.fontStyle) {\n\t\t\tfontStyle.push(style2.fontStyle);\n\t\t}\n\t\telse if (style.fontStyle) {\n\t\t\tfontStyle.push(style.fontStyle);\n\t\t}\n\n\t\tif (style2 && style2.fontSize) {\n\t\t\tif ($type.isNumber(style2.fontSize)) {\n\t\t\t\tstyle2.fontSize = style2.fontSize + \"px\";\n\t\t\t}\n\t\t\tfontStyle.push(style2.fontSize);\n\t\t}\n\t\telse if (style.fontSize) {\n\t\t\tif ($type.isNumber(style.fontSize)) {\n\t\t\t\tstyle.fontSize = style.fontSize + \"px\";\n\t\t\t}\n\t\t\tfontStyle.push(style.fontSize);\n\t\t}\n\n\t\tif (style2 && style2.fontFamily) {\n\t\t\tfontStyle.push(style2.fontFamily);\n\t\t}\n\t\telse if (style.fontFamily) {\n\t\t\tfontStyle.push(style.fontFamily);\n\t\t}\n\t\telse if (fontStyle.length) {\n\t\t\tfontStyle.push(\"Arial\");\n\t\t}\n\n\t\treturn fontStyle.join(\" \");\n\t}\n\n\tprotected _render(parentLayer: CanvasLayer): void {\n\t\tconst layer = this._layer || parentLayer;\n\n\t\t// We need measurements in order to properly position text for alignment\n\t\tif (!this._textInfo) {\n\t\t\tthis._measure(layer);\n\t\t}\n\n\t\tif (this._textVisible) {\n\n\t\t\tconst interactive = this._isInteractive();\n\t\t\tconst context = layer.context;\n\t\t\tconst layerDirty = layer.dirty;\n\t\t\tconst ghostContext = this._renderer._ghostContext;\n\n\t\t\tcontext.save();\n\t\t\tghostContext.save();\n\t\t\tthis._prerender(layer);\n\n\t\t\t// const lines = this.text.toString().replace(/\\r/g, \"\").split(/\\n/);\n\t\t\t// const x = this._localBounds && (this._localBounds.left < 0) ? Math.abs(this._localBounds.left) : 0;\n\n\t\t\t// Process text info produced by _measure()\n\t\t\t$array.each(this._textInfo!, (line, _index) => {\n\t\t\t\t$array.each(line.textChunks, (chunk, _index) => {\n\n\t\t\t\t\t// Set style\n\t\t\t\t\tif (chunk.style) {\n\t\t\t\t\t\tcontext.save();\n\t\t\t\t\t\tghostContext.save();\n\n\t\t\t\t\t\tcontext.font = chunk.style;\n\t\t\t\t\t\tif (this._isInteractive()) {\n\t\t\t\t\t\t\tghostContext.font = chunk.style;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (chunk.fill) {\n\t\t\t\t\t\tcontext.save();\n\t\t\t\t\t\tcontext.fillStyle = chunk.fill.toCSS();\n\t\t\t\t\t\t// Color does not affect ghostContext so we not set it\n\t\t\t\t\t}\n\n\t\t\t\t\t// Draw text\n\t\t\t\t\tif (layerDirty) {\n\t\t\t\t\t\tcontext.fillText(chunk.text, chunk.offsetX, line.offsetY + chunk.offsetY);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Draw underline\n\t\t\t\t\tif (chunk.textDecoration == \"underline\" || chunk.textDecoration == \"line-through\") {\n\n\t\t\t\t\t\tlet thickness = 1;\n\t\t\t\t\t\tlet offset = 1;\n\t\t\t\t\t\tlet fontSize = chunk.height;\n\n\t\t\t\t\t\tlet offsetX = chunk.offsetX;\n\t\t\t\t\t\tswitch (this.style.textAlign) {\n\t\t\t\t\t\t\tcase \"right\":\n\t\t\t\t\t\t\tcase \"end\":\n\t\t\t\t\t\t\t\toffsetX -= chunk.width;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase \"center\":\n\t\t\t\t\t\t\t\toffsetX -= chunk.width / 2;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (chunk.style) {\n\t\t\t\t\t\t\tconst format = TextFormatter.getTextStyle(chunk.style);\n\t\t\t\t\t\t\tswitch (format.fontWeight) {\n\t\t\t\t\t\t\t\tcase \"bolder\":\n\t\t\t\t\t\t\t\tcase \"bold\":\n\t\t\t\t\t\t\t\tcase \"700\":\n\t\t\t\t\t\t\t\tcase \"800\":\n\t\t\t\t\t\t\t\tcase \"900\":\n\t\t\t\t\t\t\t\t\tthickness = 2;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (fontSize) {\n\t\t\t\t\t\t\toffset = fontSize / 20;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet y: number;\n\n\t\t\t\t\t\tif (chunk.textDecoration == \"line-through\") {\n\t\t\t\t\t\t\ty = thickness + line.offsetY + chunk.offsetY - chunk.height / 2;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\ty = thickness + offset * 1.5 + line.offsetY + chunk.offsetY;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcontext.save();\n\t\t\t\t\t\tcontext.beginPath();\n\t\t\t\t\t\tif (chunk.fill) {\n\t\t\t\t\t\t\tcontext.strokeStyle = chunk.fill.toCSS();\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (this.style.fill && this.style.fill instanceof Color) {\n\t\t\t\t\t\t\tcontext.strokeStyle = this.style.fill.toCSS();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcontext.lineWidth = thickness * offset;\n\t\t\t\t\t\tcontext.moveTo(offsetX, y);\n\t\t\t\t\t\tcontext.lineTo(offsetX + chunk.width, y);\n\t\t\t\t\t\tcontext.stroke();\n\t\t\t\t\t\tcontext.restore();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (interactive && this.interactive) {\n\t\t\t\t\t\t// Draw text in ghost canvas ONLY if it is set as interactive\n\t\t\t\t\t\t// explicitly. This way we avoid hit test anomalies caused by anti\n\t\t\t\t\t\t// aliasing of text.\n\t\t\t\t\t\tghostContext.fillText(chunk.text, chunk.offsetX, line.offsetY + chunk.offsetY);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (chunk.fill) {\n\t\t\t\t\t\tcontext.restore();\n\t\t\t\t\t\t// Color does not affect ghostContext so we not set it\n\t\t\t\t\t}\n\n\t\t\t\t\t// Reset style\n\t\t\t\t\tif (chunk.style) {\n\t\t\t\t\t\tcontext.restore();\n\t\t\t\t\t\tghostContext.restore();\n\t\t\t\t\t}\n\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tcontext.restore();\n\t\t\tghostContext.restore();\n\t\t}\n\t}\n\n\tpublic _addBounds(bounds: IBounds): void {\n\t\tif (this.visible && this.isMeasured) {\n\t\t\t//if (this._textVisible) {\n\t\t\tconst x = this._measure(this.getLayer());\n\t\t\tsetPoint(bounds, { x: x.left, y: x.top });\n\t\t\tsetPoint(bounds, { x: x.right, y: x.bottom });\n\t\t\t//}\n\t\t}\n\t}\n\n\tpublic _measure(layer: CanvasLayer): IBounds {\n\t\tconst context = layer.context;\n\t\tconst ghostContext = this._renderer._ghostContext;\n\t\tconst rtl = this.style.direction == \"rtl\";\n\n\t\t// Reset text info\n\t\tthis._textInfo = [];\n\n\t\t// Init\n\t\tconst oversizedBehavior = this.style.oversizedBehavior;\n\t\tconst maxWidth = this.style.maxWidth!;\n\n\t\tconst truncate = $type.isNumber(maxWidth) && oversizedBehavior == \"truncate\";\n\t\tconst wrap = $type.isNumber(maxWidth) && (oversizedBehavior == \"wrap\" || oversizedBehavior == \"wrap-no-break\");\n\n\t\t// Pre-render\n\t\tcontext.save();\n\t\tghostContext.save();\n\t\tthis._prerender(layer, true, true);\n\n\t\t// Get default font metrix\n\t\tconst refText = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 \";\n\n\t\t// Split up text into lines\n\t\tconst lines = this.text.toString().replace(/\\r/g, \"\").split(/\\n/);\n\t\tlet styleRestored = true;\n\t\tlet minX = 0;\n\t\tlet maxX = 0;\n\n\t\t// Iterate through the lines\n\t\tlet offsetY = 0;\n\t\tlet currentStyle: string | undefined;\n\t\t$array.each(lines, (line, _index) => {\n\n\t\t\t// Split up line into format/value chunks\n\t\t\tlet chunks: ITextChunk[];\n\t\t\tif (line == \"\") {\n\t\t\t\tchunks = [{\n\t\t\t\t\ttype: \"value\",\n\t\t\t\t\ttext: \"\"\n\t\t\t\t}];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tchunks = TextFormatter.chunk(line, false, this.style.ignoreFormatting);\n\t\t\t}\n\n\t\t\twhile (chunks.length > 0) {\n\n\t\t\t\t// Init line object\n\t\t\t\tlet lineInfo: ILine = {\n\t\t\t\t\toffsetY: offsetY,\n\t\t\t\t\tascent: 0,\n\t\t\t\t\twidth: 0,\n\t\t\t\t\theight: 0,\n\t\t\t\t\tleft: 0,\n\t\t\t\t\tright: 0,\n\t\t\t\t\ttextChunks: []\n\t\t\t\t};\n\n\t\t\t\t// Measure reference text\n\t\t\t\tconst metrics = this._measureText(refText, context);\n\n\t\t\t\tconst height = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;\n\t\t\t\tlineInfo.height = height;\n\t\t\t\tlineInfo.ascent = metrics.actualBoundingBoxAscent;\n\n\t\t\t\tlet currentFormat: string;\n\t\t\t\tlet currentDecoration: string | undefined = this.style.textDecoration;\n\t\t\t\tlet currentFill: Color | undefined;\n\t\t\t\tlet currentChunkWidth: number | undefined;\n\t\t\t\tlet skipFurtherText = false;\n\t\t\t\tlet firstTextChunk = true;\n\t\t\t\tlet leftoverChunks: Array<ITextChunk> = [];\n\t\t\t\tlet currentVerticalAlign: \"baseline\" | \"sub\" | \"super\" | undefined;\n\t\t\t\t//let offsetX = 0;\n\t\t\t\t//let chunk;\n\n\t\t\t\t//while(chunk = chunks.shift()) {\n\t\t\t\t$array.eachContinue(chunks, (chunk, index) => {\n\n\t\t\t\t\t// Format chunk\n\t\t\t\t\tif (chunk.type == \"format\") {\n\t\t\t\t\t\tif (chunk.text == \"[/]\") {\n\t\t\t\t\t\t\tif (!styleRestored) {\n\t\t\t\t\t\t\t\tcontext.restore();\n\t\t\t\t\t\t\t\tghostContext.restore();\n\t\t\t\t\t\t\t\tstyleRestored = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcurrentFill = undefined;\n\t\t\t\t\t\t\tcurrentStyle = undefined;\n\t\t\t\t\t\t\tcurrentChunkWidth = undefined;\n\t\t\t\t\t\t\tcurrentDecoration = this.style.textDecoration;\n\t\t\t\t\t\t\tcurrentVerticalAlign = undefined\n\t\t\t\t\t\t\tcurrentFormat = chunk.text;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\tif (!styleRestored) {\n\t\t\t\t\t\t\t\tcontext.restore();\n\t\t\t\t\t\t\t\tghostContext.restore();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tlet format = TextFormatter.getTextStyle(chunk.text);\n\t\t\t\t\t\t\tconst fontStyle = this._getFontStyle(format);\n\t\t\t\t\t\t\tcontext.save();\n\t\t\t\t\t\t\tghostContext.save();\n\t\t\t\t\t\t\tcontext.font = fontStyle;\n\t\t\t\t\t\t\tcurrentStyle = fontStyle;\n\t\t\t\t\t\t\tcurrentFormat = chunk.text;\n\t\t\t\t\t\t\tif (format.textDecoration) {\n\t\t\t\t\t\t\t\tcurrentDecoration = format.textDecoration;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (format.fill) {\n\t\t\t\t\t\t\t\tcurrentFill = <Color>format.fill;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ((<any>format).width) {\n\t\t\t\t\t\t\t\tcurrentChunkWidth = $type.toNumber((<any>format).width);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (format.verticalAlign) {\n\t\t\t\t\t\t\t\tcurrentVerticalAlign = format.verticalAlign;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tstyleRestored = false;\n\n\t\t\t\t\t\t\t// Measure reference text after change of format\n\t\t\t\t\t\t\tconst metrics = this._measureText(refText, context);\n\t\t\t\t\t\t\tconst height = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;\n\t\t\t\t\t\t\tif (height > lineInfo.height) {\n\t\t\t\t\t\t\t\tlineInfo.height = height;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (metrics.actualBoundingBoxAscent > lineInfo.ascent) {\n\t\t\t\t\t\t\t\tlineInfo.ascent = metrics.actualBoundingBoxAscent;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Text chunk\n\t\t\t\t\telse if (chunk.type == \"value\" && !skipFurtherText) {\n\n\t\t\t\t\t\t// Measure\n\t\t\t\t\t\tconst metrics = this._measureText(chunk.text, context);\n\t\t\t\t\t\tlet chunkWidth = metrics.actualBoundingBoxLeft + metrics.actualBoundingBoxRight;\n\n\t\t\t\t\t\t// Check for fit\n\t\t\t\t\t\tif (truncate) {\n\n\t\t\t\t\t\t\t// Break words?\n\t\t\t\t\t\t\tlet breakWords = firstTextChunk || this.style.breakWords || false;\n\n\t\t\t\t\t\t\t// Measure ellipsis and check if it fits\n\t\t\t\t\t\t\tconst ellipsis = this.style.ellipsis || \"\";\n\t\t\t\t\t\t\tconst ellipsisMetrics = this._measureText(ellipsis, context);\n\t\t\t\t\t\t\tconst ellipsisWidth = ellipsisMetrics.actualBoundingBoxLeft + ellipsisMetrics.actualBoundingBoxRight;\n\n\t\t\t\t\t\t\t// Check fit\n\t\t\t\t\t\t\tif ((lineInfo.width + chunkWidth) > maxWidth) {\n\t\t\t\t\t\t\t\tconst excessWidth = maxWidth - lineInfo.width - ellipsisWidth;\n\t\t\t\t\t\t\t\tchunk.text = this._truncateText(context, chunk.text, excessWidth, breakWords);\n\t\t\t\t\t\t\t\tchunk.text += ellipsis;\n\t\t\t\t\t\t\t\tskipFurtherText = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (wrap) {\n\t\t\t\t\t\t\t// Check fit\n\t\t\t\t\t\t\tif ((lineInfo.width + chunkWidth) > maxWidth) {\n\t\t\t\t\t\t\t\tconst excessWidth = maxWidth - lineInfo.width;\n\t\t\t\t\t\t\t\tconst tmpText = this._truncateText(\n\t\t\t\t\t\t\t\t\tcontext,\n\t\t\t\t\t\t\t\t\tchunk.text,\n\t\t\t\t\t\t\t\t\texcessWidth,\n\t\t\t\t\t\t\t\t\tfalse,\n\t\t\t\t\t\t\t\t\t(firstTextChunk && this.style.oversizedBehavior != \"wrap-no-break\")\n\t\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t\tif (tmpText == \"\") {\n\t\t\t\t\t\t\t\t\t// Unable to fit a single letter - hide the whole label\n\t\t\t\t\t\t\t\t\tthis._textVisible = true;\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t//skipFurtherText = true;\n\n\t\t\t\t\t\t\t\t//Add remaining chunks for the next line\n\t\t\t\t\t\t\t\tleftoverChunks = chunks.slice(index + 1);\n\n\t\t\t\t\t\t\t\t//Add remaining text of current chunk if it was forced-cut\n\t\t\t\t\t\t\t\tif ($utils.trim(tmpText) != $utils.trim(chunk.text)) {\n\t\t\t\t\t\t\t\t\tleftoverChunks.unshift({\n\t\t\t\t\t\t\t\t\t\ttype: \"value\",\n\t\t\t\t\t\t\t\t\t\ttext: chunk.text.substr(tmpText.length)\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\tif (currentFormat) {\n\t\t\t\t\t\t\t\t\t\tleftoverChunks.unshift({\n\t\t\t\t\t\t\t\t\t\t\ttype: \"format\",\n\t\t\t\t\t\t\t\t\t\t\ttext: currentFormat\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// Set current chunk (truncated)\n\t\t\t\t\t\t\t\tchunk.text = $utils.trim(tmpText);\n\n\t\t\t\t\t\t\t\tchunks = [];\n\t\t\t\t\t\t\t\tskipFurtherText = true;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Chunk width?\n\t\t\t\t\t\tlet leftBoundMod = 1;\n\t\t\t\t\t\tlet rightBoundMod = 1;\n\t\t\t\t\t\tif (currentStyle && currentChunkWidth && (currentChunkWidth > chunkWidth)) {\n\t\t\t\t\t\t\t// increase horizontal bounding boxes accordingly\n\t\t\t\t\t\t\tconst boundsMod = chunkWidth / currentChunkWidth\n\t\t\t\t\t\t\tswitch (this.style.textAlign) {\n\t\t\t\t\t\t\t\tcase \"right\":\n\t\t\t\t\t\t\t\tcase \"end\":\n\t\t\t\t\t\t\t\t\tleftBoundMod = boundsMod;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\tcase \"center\":\n\t\t\t\t\t\t\t\t\tleftBoundMod = boundsMod;\n\t\t\t\t\t\t\t\t\trightBoundMod = boundsMod;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\trightBoundMod = boundsMod;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tchunkWidth = currentChunkWidth;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst chunkHeight = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;\n\n\n\t\t\t\t\t\tif (chunkHeight > lineInfo.height) {\n\t\t\t\t\t\t\tlineInfo.height = chunkHeight;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (metrics.actualBoundingBoxAscent > lineInfo.ascent) {\n\t\t\t\t\t\t\tlineInfo.ascent = metrics.actualBoundingBoxAscent;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlineInfo.width += chunkWidth;\n\t\t\t\t\t\tlineInfo.left += metrics.actualBoundingBoxLeft / leftBoundMod;\n\t\t\t\t\t\tlineInfo.right += metrics.actualBoundingBoxRight / rightBoundMod;\n\t\t\t\t\t\tlineInfo.textChunks.push({\n\t\t\t\t\t\t\tstyle: currentStyle,\n\t\t\t\t\t\t\tfill: currentFill,\n\t\t\t\t\t\t\ttext: chunk.text,\n\t\t\t\t\t\t\twidth: chunkWidth,\n\t\t\t\t\t\t\theight: chunkHeight,\n\t\t\t\t\t\t\tleft: metrics.actualBoundingBoxLeft,\n\t\t\t\t\t\t\tright: metrics.actualBoundingBoxRight,\n\t\t\t\t\t\t\tascent: metrics.actualBoundingBoxAscent,\n\t\t\t\t\t\t\toffsetX: 0,\n\t\t\t\t\t\t\toffsetY: 0,\n\t\t\t\t\t\t\ttextDecoration: currentDecoration,\n\t\t\t\t\t\t\tverticalAlign: currentVerticalAlign\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t//offsetX += chunkWidth;\n\n\t\t\t\t\t\tfirstTextChunk = false;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif (leftoverChunks) {\n\t\t\t\t\t\t//return false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\n\t\t\t\t\t//}\n\t\t\t\t});\n\n\t\t\t\tif (this.style.lineHeight instanceof Percent) {\n\t\t\t\t\tlineInfo.height *= this.style.lineHeight.value;\n\t\t\t\t\tlineInfo.ascent *= this.style.lineHeight.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tlineInfo.height *= this.style.lineHeight || 1.2;\n\t\t\t\t\tlineInfo.ascent *= this.style.lineHeight || 1.2;\n\t\t\t\t}\n\n\t\t\t\tif (minX < lineInfo.left) {\n\t\t\t\t\tminX = lineInfo.left;\n\t\t\t\t}\n\n\t\t\t\tif (maxX < lineInfo.right) {\n\t\t\t\t\tmaxX = lineInfo.right;\n\t\t\t\t}\n\n\t\t\t\tthis._textInfo!.push(lineInfo);\n\n\t\t\t\t//lineInfo.offsetY += lineInfo.ascent;\n\t\t\t\toffsetY += lineInfo.height;\n\n\t\t\t\t// Reset chunks so that it can proceed to the next line\n\t\t\t\tchunks = leftoverChunks || [];\n\t\t\t}\n\n\t\t});\n\n\t\tif (!styleRestored) {\n\t\t\tcontext.restore();\n\t\t\tghostContext.restore();\n\t\t}\n\n\t\t// Adjust chunk internal offsets\n\t\t$array.each(this._textInfo, (lineInfo, _index: number) => {\n\t\t\tlet currentChunkOffset = 0\n\t\t\t$array.each(lineInfo.textChunks, (chunk) => {\n\t\t\t\tchunk.offsetX = currentChunkOffset + chunk.left - lineInfo.left;\n\t\t\t\tchunk.offsetY += lineInfo.height - lineInfo.height * (this.style.baselineRatio || 0.19);\n\t\t\t\tcurrentChunkOffset += chunk.width;\n\n\t\t\t\tif (chunk.verticalAlign) {\n\t\t\t\t\tswitch (chunk.verticalAlign) {\n\t\t\t\t\t\tcase \"super\":\n\t\t\t\t\t\t\tchunk.offsetY -= lineInfo.height / 2 - chunk.height / 2;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase \"sub\":\n\t\t\t\t\t\t\tchunk.offsetY += chunk.height / 2;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tconst bounds = {\n\t\t\tleft: rtl ? -maxX : -minX,\n\t\t\ttop: 0,\n\t\t\tright: rtl ? minX : maxX,\n\t\t\tbottom: offsetY,\n\t\t};\n\n\n\t\t// We need to fit?\n\t\tif (oversizedBehavior !== \"none\") {\n\t\t\tconst ratio = this._fitRatio(bounds);\n\t\t\tif (ratio < 1) {\n\t\t\t\tif (oversizedBehavior == \"fit\") {\n\t\t\t\t\tif ($type.isNumber(this.style.minScale) && (ratio < this.style.minScale)) {\n\t\t\t\t\t\tthis._textVisible = false;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif (!this._originalScale || this._originalScale == 1) {\n\t\t\t\t\t\t\tthis._originalScale = this.scale;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.scale = ratio;\n\t\t\t\t\t\tthis._textVisible = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (oversizedBehavior == \"hide\") {\n\t\t\t\t\tthis._textVisible = false;\n\t\t\t\t}\n\t\t\t\telse {\n\n\t\t\t\t\tswitch (this.style.textAlign) {\n\t\t\t\t\t\tcase \"right\":\n\t\t\t\t\t\tcase \"end\":\n\t\t\t\t\t\t\tbounds.left = -maxWidth;\n\t\t\t\t\t\t\tbounds.right = 0;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase \"center\":\n\t\t\t\t\t\t\tbounds.left = -maxWidth / 2;\n\t\t\t\t\t\t\tbounds.right = maxWidth / 2;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tbounds.left = 0;\n\t\t\t\t\t\t\tbounds.right = maxWidth;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.scale = this._originalScale || 1;\n\t\t\t\t\tthis._originalScale = undefined;\n\t\t\t\t\tthis._textVisible = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.scale = this._originalScale || 1;\n\t\t\t\tthis._originalScale = undefined;\n\t\t\t\tthis._textVisible = true;\n\t\t\t}\n\t\t}\n\n\t\tcontext.restore();\n\t\tghostContext.restore();\n\n\t\treturn bounds;\n\t}\n\n\tprotected _fitRatio(bounds: IBounds): number {\n\t\tconst maxW = this.style.maxWidth;\n\t\tconst maxH = this.style.maxHeight;\n\t\tif (!$type.isNumber(maxW) && !$type.isNumber(maxH)) {\n\t\t\treturn 1;\n\t\t}\n\t\tconst w = bounds.right - bounds.left;\n\t\tconst h = bounds.bottom - bounds.top;\n\t\treturn Math.min(maxW! / w || 1, maxH! / h || 1);\n\t}\n\n\tprotected _truncateText(context: CanvasRenderingContext2D, text: string, maxWidth: number, breakWords: boolean = false, fallbackBreakWords: boolean = true): string {\n\t\tlet width: number;\n\t\tdo {\n\t\t\tif (breakWords) {\n\t\t\t\ttext = text.slice(0, -1);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlet tmp = text.replace(/[^,;:!?\\\\\\/\\s]+[,;:!?\\\\\\/\\s]*$/g, \"\");\n\t\t\t\tif (tmp == \"\" && fallbackBreakWords) {\n\t\t\t\t\tbreakWords = true;\n\t\t\t\t}\n\t\t\t\telse if (tmp == \"\") {\n\t\t\t\t\treturn text;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\ttext = tmp;\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst metrics = this._measureText(text, context);\n\t\t\twidth = metrics.actualBoundingBoxLeft + metrics.actualBoundingBoxRight;\n\t\t} while ((width > maxWidth) && text != \"\");\n\t\treturn text;\n\t}\n\n\tprotected _measureText(text: string, context: CanvasRenderingContext2D): TextMetrics {\n\t\tlet metrics = context.measureText(text);\n\t\tlet fakeMetrics: any = {};\n\t\tif (metrics.actualBoundingBoxAscent == null) {\n\t\t\tconst div = document.createElement(\"div\");\n\t\t\tdiv.innerText = text;\n\t\t\tdiv.style.visibility = \"hidden\";\n\t\t\tdiv.style.position = \"absolute\";\n\t\t\tdiv.style.top = \"-1000000px;\"\n\t\t\tdiv.style.fontFamily = this.style.fontFamily || \"\";\n\t\t\tdiv.style.fontSize = this.style.fontSize + \"\";\n\t\t\tdocument.body.appendChild(div);\n\t\t\tconst bbox = div.getBoundingClientRect();\n\t\t\tdocument.body.removeChild(div);\n\t\t\tconst h = bbox.height;\n\t\t\tconst w = metrics.width;\n\t\t\tlet left = 0;\n\t\t\tlet right = w;\n\n\t\t\tfakeMetrics = {\n\t\t\t\tactualBoundingBoxAscent: h,\n\t\t\t\tactualBoundingBoxDescent: 0,\n\t\t\t\tactualBoundingBoxLeft: left,\n\t\t\t\tactualBoundingBoxRight: right,\n\t\t\t\tfontBoundingBoxAscent: h,\n\t\t\t\tfontBoundingBoxDescent: 0,\n\t\t\t\twidth: w\n\t\t\t}\n\t\t\t//return fake;\n\t\t}\n\t\telse {\n\t\t\tfakeMetrics = {\n\t\t\t\tactualBoundingBoxAscent: metrics.actualBoundingBoxAscent,\n\t\t\t\tactualBoundingBoxDescent: metrics.actualBoundingBoxDescent,\n\t\t\t\tactualBoundingBoxLeft: metrics.actualBoundingBoxLeft,\n\t\t\t\tactualBoundingBoxRight: metrics.actualBoundingBoxRight,\n\t\t\t\tfontBoundingBoxAscent: metrics.actualBoundingBoxAscent,\n\t\t\t\tfontBoundingBoxDescent: metrics.actualBoundingBoxDescent,\n\t\t\t\twidth: metrics.width\n\t\t\t}\n\t\t}\n\n\t\tconst w = metrics.width;\n\t\tswitch (this.style.textAlign) {\n\t\t\tcase \"right\":\n\t\t\tcase \"end\":\n\t\t\t\tfakeMetrics.actualBoundingBoxLeft = w;\n\t\t\t\tfakeMetrics.actualBoundingBoxRight = 0;\n\t\t\t\tbreak;\n\t\t\tcase \"center\":\n\t\t\t\tfakeMetrics.actualBoundingBoxLeft = w / 2;\n\t\t\t\tfakeMetrics.actualBoundingBoxRight = w / 2;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tfakeMetrics.actualBoundingBoxLeft = 0;\n\t\t\t\tfakeMetrics.actualBoundingBoxRight = w;\n\t\t}\n\n\t\treturn fakeMetrics;\n\t}\n\n}\n\n/**\n * @ignore\n */\nexport class CanvasTextStyle implements ITextStyle {\n\t//public wordWrapWidth: number = 100;\n\tpublic fill?: Color | CanvasGradient | CanvasPattern;\n\tpublic textAlign?: \"start\" | \"end\" | \"left\" | \"right\" | \"center\";\n\tpublic fontFamily?: string;\n\tpublic fontSize?: string | number;\n\tpublic fontWeight?: 'normal' | 'bold' | 'bolder' | 'lighter' | '100' | '200' | '300' | '400' | '500' | '600' | '700' | '800' | '900'\n\tpublic fontStyle?: 'normal' | 'italic' | 'oblique';\n\tpublic fontVariant?: \"normal\" | \"small-caps\";\n\tpublic textDecoration?: \"underline\" | \"line-through\";\n\tpublic shadowColor?: Color | null;\n\tpublic shadowBlur?: number;\n\tpublic shadowOffsetX?: number;\n\tpublic shadowOffsetY?: number;\n\tpublic shadowOpacity?: number;\n\t// leading?: number;\n\t// letterSpacing?: number;\n\tpublic lineHeight?: number | Percent = percent(120);\n\tpublic baselineRatio?: number = 0.19;\n\t// padding?: number;\n\t// stroke?: number;\n\t// strokeThickness?: number;\n\t// trim?: number;\n\t// wordWrap?: boolean;\n\tpublic direction?: \"ltr\" | \"rtl\";\n\tpublic textBaseline?: \"top\" | \"hanging\" | \"middle\" | \"alphabetic\" | \"ideographic\" | \"bottom\";\n\tpublic oversizedBehavior?: \"none\" | \"hide\" | \"fit\" | \"wrap\" | \"wrap-no-break\" | \"truncate\" = \"none\";\n\tpublic breakWords?: boolean = false;\n\tpublic ellipsis?: string = \"…\";\n\tpublic maxWidth?: number;\n\tpublic maxHeight?: number;\n\tpublic minScale?: number;\n\tpublic ignoreFormatting?: boolean = false;\n}\n\n/**\n * @ignore\n */\nexport class CanvasRadialText extends CanvasText implements IRadialText {\n\tpublic textType?: \"regular\" | \"circular\" | \"radial\" | \"aligned\" | \"adjusted\" = \"circular\";\n\tpublic radius?: number;\n\tpublic startAngle?: number;\n\tpublic inside?: boolean = false;\n\tpublic orientation?: \"inward\" | \"outward\" | \"auto\" = \"auto\";\n\tpublic kerning?: number = 0;\n\n\tprivate _textReversed: boolean = false;\n\n\tpublic _render(parentLayer: CanvasLayer): void {\n\t\tswitch (this.textType) {\n\t\t\tcase \"circular\":\n\t\t\t\tthis._renderCircular(parentLayer);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tsuper._render(parentLayer);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tpublic _renderCircular(parentLayer: CanvasLayer): void {\n\t\tconst layer = this._layer || parentLayer;\n\n\t\tthis._prerender(layer);\n\n\t\tconst interactive = this._isInteractive();\n\t\tconst context = layer.context;\n\t\tconst layerDirty = layer.dirty;\n\t\tconst ghostContext = this._renderer._ghostContext;\n\n\t\t// Savepoint\n\t\tcontext.save();\n\t\tif (interactive) {\n\t\t\tghostContext.save();\n\t\t}\n\n\t\t// Init\n\t\tlet radius = (this.radius || 0);\n\t\tlet startAngle = (this.startAngle || 0);\n\t\tlet deltaAngle = 0;\n\t\tlet orientation = this.orientation;\n\t\tlet inward = orientation == \"auto\" ? \"auto\" : orientation == \"inward\";\n\t\tconst inside = this.inside;\n\t\tconst align = this.style.textAlign || \"left\";\n\t\tconst kerning = this.kerning || 0;\n\t\tlet clockwise = align == \"left\" ? 1 : -1;\n\t\tconst shouldReverse = !this._textReversed;\n\n\t\t// We need measurements in order to properly position text for alignment\n\t\tif (!this._textInfo) {\n\t\t\tthis._measure(layer);\n\t\t}\n\n\t\t// Check if we need to invert the whole stuff\n\t\tif (inward == \"auto\") {\n\t\t\t// Calc max angle so we know whether we need to flip it\n\t\t\tlet maxAngle = 0;\n\t\t\tlet midAngle = 0;\n\t\t\t$array.each(this._textInfo!, (line, _index) => {\n\t\t\t\tconst deltaAngle = startAngle + (line.width / (radius - line.height)) / 2 * -clockwise;\n\t\t\t\tif (deltaAngle > maxAngle) {\n\t\t\t\t\tmaxAngle = deltaAngle;\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (align == \"left\") {\n\t\t\t\tmidAngle = (maxAngle + deltaAngle / 2) * $math.DEGREES;\n\t\t\t}\n\t\t\telse if (align == \"right\") {\n\t\t\t\tmidAngle = (maxAngle - deltaAngle / 2) * $math.DEGREES;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tmidAngle = startAngle * $math.DEGREES;\n\t\t\t}\n\t\t\tmidAngle = $math.normalizeAngle(midAngle);\n\t\t\tinward = (midAngle >= 270) || (midAngle <= 90);\n\t\t}\n\n\t\tif (inward == true && shouldReverse) {\n\t\t\tthis._textInfo!.reverse();\n\t\t\tthis._textReversed = true;\n\t\t}\n\n\t\t// if ((inward == false && align == \"left\") || (inward == true && align == \"right\")) {\n\t\t// \tclockwise *= -1;\n\t\t// }\n\n\t\t// Process text info produced by _measure()\n\t\t$array.each(this._textInfo!, (line, _index) => {\n\n\t\t\tconst textHeight = line.height;\n\n\t\t\t// Adjust radius (for `inside = false`)\n\t\t\t// Radius adjustment for `inside = false` is below the line calculation\n\t\t\tif (!inside) {\n\t\t\t\tradius += textHeight;\n\t\t\t}\n\n\t\t\t// Reverse letters if we're painting them counter-clockwise\n\t\t\tif (((clockwise == -1 && inward) || (clockwise == 1 && !inward)) && shouldReverse) {\n\t\t\t\tline.textChunks.reverse();\n\t\t\t}\n\n\t\t\t// Init angles\n\t\t\tlet lineStartAngle = startAngle;\n\t\t\tdeltaAngle = 0;\n\n\t\t\t// Adjust for center-align\n\t\t\tif (align == \"center\") {\n\t\t\t\tlineStartAngle += (line.width / (radius - textHeight)) / 2 * -clockwise;\n\t\t\t\tdeltaAngle = lineStartAngle - startAngle;\n\t\t\t}\n\n\t\t\t// if (inward == \"auto\") {\n\t\t\t// \tlet midAngle;\n\t\t\t// \tif (align == \"left\") {\n\t\t\t// \t\tmidAngle = (lineStartAngle + deltaAngle / 2) * $math.DEGREES;\n\t\t\t// \t}\n\t\t\t// \telse if () {\n\t\t\t// \t\tmidAngle = (lineStartAngle - deltaAngle / 2) * $math.DEGREES;\n\t\t\t// \t}\n\t\t\t// \tinward = (midAngle >= 270) || (midAngle <= 90);\n\t\t\t// }\n\n\t\t\t// Rotate letters if they are facing outward\n\t\t\tlineStartAngle += (Math.PI * (inward ? 0 : 1)); // Rotate 180 if outward\n\n\t\t\t// Savepoint\n\t\t\tcontext.save();\n\t\t\tif (interactive) {\n\t\t\t\tghostContext.save();\n\t\t\t}\n\n\t\t\t// Assume starting angle\n\t\t\tcontext.rotate(lineStartAngle);\n\t\t\tif (interactive) {\n\t\t\t\tghostContext.rotate(lineStartAngle);\n\t\t\t}\n\n\t\t\tlet angleShift = 0;\n\t\t\t$array.each(line.textChunks, (chunk, _index) => {\n\n\t\t\t\t// Draw the letter\n\t\t\t\tconst char = chunk.text;\n\t\t\t\tconst charWidth = chunk.width;\n\n\t\t\t\t// Rotate half a letter\n\t\t\t\tangleShift = (charWidth / 2) / (radius - textHeight) * clockwise;\n\t\t\t\tcontext.rotate(angleShift);\n\t\t\t\tif (interactive) {\n\t\t\t\t\tghostContext.rotate(angleShift);\n\t\t\t\t}\n\n\t\t\t\t// Set style\n\t\t\t\tif (chunk.style) {\n\t\t\t\t\tcontext.save();\n\t\t\t\t\tghostContext.save();\n\n\t\t\t\t\tcontext.font = chunk.style;\n\t\t\t\t\tif (interactive) {\n\t\t\t\t\t\tghostContext.font = chunk.style;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (chunk.fill) {\n\t\t\t\t\tcontext.save();\n\t\t\t\t\tcontext.fillStyle = chunk.fill.toCSS();\n\t\t\t\t\t// Color does not affect ghostContext so we not set it\n\t\t\t\t}\n\n\t\t\t\t// Center letters\n\t\t\t\tcontext.textBaseline = \"middle\";\n\t\t\t\tcontext.textAlign = \"center\";\n\t\t\t\tif (interactive) {\n\t\t\t\t\tghostContext.textBaseline = \"middle\";\n\t\t\t\t\tghostContext.textAlign = \"center\";\n\t\t\t\t}\n\n\t\t\t\t// Plop the letter\n\t\t\t\tif (layerDirty) {\n\t\t\t\t\tcontext.fillText(char, 0, (inward ? 1 : -1) * (0 - radius + textHeight / 2));\n\t\t\t\t}\n\t\t\t\tif (interactive) {\n\t\t\t\t\tghostContext.fillText(char, 0, (inward ? 1 : -1) * (0 - radius + textHeight / 2));\n\t\t\t\t}\n\n\t\t\t\tif (chunk.fill) {\n\t\t\t\t\tcontext.restore();\n\t\t\t\t\t// Color does not affect ghostContext so we not set it\n\t\t\t\t}\n\n\t\t\t\t// Reset style\n\t\t\t\tif (chunk.style) {\n\t\t\t\t\tcontext.restore();\n\t\t\t\t\tghostContext.restore();\n\t\t\t\t}\n\n\t\t\t\t// Rotate half a letter and add spacing\n\t\t\t\tangleShift = (charWidth / 2 + kerning) / (radius - textHeight) * clockwise;\n\t\t\t\tcontext.rotate(angleShift);\n\t\t\t\tif (interactive) {\n\t\t\t\t\tghostContext.rotate(angleShift);\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\t// Restore angle\n\t\t\tcontext.restore();\n\t\t\tif (interactive) {\n\t\t\t\tghostContext.restore();\n\t\t\t}\n\n\t\t\t// Adjust radius (for `inside = true`)\n\t\t\tif (inside) {\n\t\t\t\tradius -= textHeight;\n\t\t\t}\n\n\t\t});\n\n\t\t// Restore\n\t\tcontext.restore();\n\t\tif (interactive) {\n\t\t\tghostContext.restore();\n\t\t}\n\t}\n\n\tpublic _measure(layer: CanvasLayer): IBounds {\n\t\tswitch (this.textType) {\n\t\t\tcase \"circular\":\n\t\t\t\treturn this._measureCircular(layer);\n\t\t\tdefault:\n\t\t\t\treturn super._measure(layer);\n\t\t}\n\t}\n\n\tpublic _measureCircular(layer: CanvasLayer): IBounds {\n\t\tconst context = layer.context;\n\t\tconst ghostContext = this._renderer._ghostContext;\n\t\tconst rtl = this.style.direction == \"rtl\";\n\n\t\t// Reset text info\n\t\tthis._textInfo = [];\n\t\tthis._textReversed = false;\n\n\t\t// Pre-render\n\t\tcontext.save();\n\t\tghostContext.save();\n\t\tthis._prerender(layer, true);\n\n\t\t// Split up text into lines\n\t\tconst lines = this.text.toString().replace(/\\r/g, \"\").split(/\\n/);\n\t\tlet styleRestored = true;\n\n\t\t// Iterate through the lines\n\t\tlet offsetY = 0;\n\t\t$array.each(lines, (line, _index) => {\n\n\t\t\t// Split up line into format/value chunks\n\t\t\tlet chunks = TextFormatter.chunk(line, false, this.style.ignoreFormatting);\n\n\t\t\t// Init line object\n\t\t\tlet lineInfo: ILine = {\n\t\t\t\toffsetY: offsetY,\n\t\t\t\tascent: 0,\n\t\t\t\twidth: 0,\n\t\t\t\theight: 0,\n\t\t\t\tleft: 0,\n\t\t\t\tright: 0,\n\t\t\t\ttextChunks: []\n\t\t\t};\n\n\t\t\tlet currentStyle: string | undefined;\n\t\t\tlet currentFill: Color | undefined;\n\t\t\tlet currentChunkWidth: number | undefined;\n\n\t\t\t//while(chunk = chunks.shift()) {\n\t\t\t$array.each(chunks, (chunk, _index) => {\n\n\t\t\t\t// Format chunk\n\t\t\t\tif (chunk.type == \"format\") {\n\t\t\t\t\tif (chunk.text == \"[/]\") {\n\t\t\t\t\t\tif (!styleRestored) {\n\t\t\t\t\t\t\tcontext.restore();\n\t\t\t\t\t\t\tghostContext.restore();\n\t\t\t\t\t\t\tstyleRestored = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcurrentFill = undefined;\n\t\t\t\t\t\tcurrentStyle = undefined;\n\t\t\t\t\t\tcurrentChunkWidth = undefined;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tlet format = TextFormatter.getTextStyle(chunk.text);\n\t\t\t\t\t\tconst fontStyle = this._getFontStyle(format);\n\t\t\t\t\t\tcontext.save();\n\t\t\t\t\t\tghostContext.save();\n\t\t\t\t\t\tcontext.font = fontStyle;\n\t\t\t\t\t\tcurrentStyle = fontStyle;\n\t\t\t\t\t\tif (format.fill) {\n\t\t\t\t\t\t\tcurrentFill = <Color>format.fill;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ((<any>format).width) {\n\t\t\t\t\t\t\tcurrentChunkWidth = $type.toNumber((<any>format).width);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstyleRestored = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Text format\n\t\t\t\telse if (chunk.type == \"value\") {\n\n\t\t\t\t\t// Measure each letter\n\t\t\t\t\tconst chars = chunk.text.match(/./ug) || [];\n\t\t\t\t\tif (rtl) {\n\t\t\t\t\t\tchars.reverse();\n\t\t\t\t\t}\n\t\t\t\t\tfor (let i = 0; i < chars.length; i++) {\n\n\t\t\t\t\t\tconst char = chars[i];\n\n\t\t\t\t\t\t// Measure\n\t\t\t\t\t\tconst metrics = this._measureText(char, context);\n\t\t\t\t\t\tlet chunkWidth = metrics.width;\n\n\t\t\t\t\t\t// Chunk width?\n\t\t\t\t\t\tif (currentStyle && currentChunkWidth && (currentChunkWidth > chunkWidth)) {\n\t\t\t\t\t\t\tchunkWidth = currentChunkWidth;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst chunkHeight = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;\n\t\t\t\t\t\tif (chunkHeight > lineInfo.height) {\n\t\t\t\t\t\t\tlineInfo.height = chunkHeight;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (metrics.actualBoundingBoxAscent > lineInfo.ascent) {\n\t\t\t\t\t\t\tlineInfo.ascent = metrics.actualBoundingBoxAscent;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlineInfo.width += chunkWidth;\n\t\t\t\t\t\tlineInfo.left += metrics.actualBoundingBoxLeft;\n\t\t\t\t\t\tlineInfo.right += metrics.actualBoundingBoxRight;\n\t\t\t\t\t\tlineInfo.textChunks.push({\n\t\t\t\t\t\t\tstyle: currentStyle,\n\t\t\t\t\t\t\tfill: currentFill,\n\t\t\t\t\t\t\ttext: char,\n\t\t\t\t\t\t\twidth: chunkWidth,\n\t\t\t\t\t\t\theight: chunkHeight + metrics.actualBoundingBoxDescent,\n\t\t\t\t\t\t\tleft: metrics.actualBoundingBoxLeft,\n\t\t\t\t\t\t\tright: metrics.actualBoundingBoxRight,\n\t\t\t\t\t\t\tascent: metrics.actualBoundingBoxAscent,\n\t\t\t\t\t\t\toffsetX: 0,\n\t\t\t\t\t\t\toffsetY: chunkHeight,\n\t\t\t\t\t\t\ttextDecoration: undefined\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (rtl) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (this.style.lineHeight instanceof Percent) {\n\t\t\t\tlineInfo.height *= this.style.lineHeight.value;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlineInfo.height *= this.style.lineHeight || 1.2;\n\t\t\t}\n\n\t\t\tthis._textInfo!.push(lineInfo);\n\n\t\t\t//lineInfo.offsetY += lineInfo.ascent;\n\t\t\toffsetY += lineInfo.height;\n\n\n\t\t});\n\n\t\tif (!styleRestored) {\n\t\t\tcontext.restore();\n\t\t\tghostContext.restore();\n\t\t}\n\n\t\t// Adjust chunk internal offsets\n\t\t$array.each(this._textInfo, (lineInfo) => {\n\t\t\t$array.each(lineInfo.textChunks, (chunk) => {\n\t\t\t\tchunk.offsetY += Math.round((lineInfo.height - chunk.height + (lineInfo.ascent - chunk.ascent)) / 2);\n\t\t\t});\n\t\t});\n\n\t\tcontext.restore();\n\t\tghostContext.restore();\n\n\t\treturn {\n\t\t\tleft: 0,\n\t\t\ttop: 0,\n\t\t\tright: 0,\n\t\t\tbottom: 0,\n\t\t};\n\t}\n\n}\n\n/**\n * @ignore\n */\nexport class CanvasImage extends CanvasDisplayObject implements IPicture {\n\tpublic width: number | undefined;\n\tpublic height: number | undefined;\n\tpublic image: HTMLImageElement | undefined;\n\tpublic tainted?: boolean;\n\n\tpublic shadowColor?: Color;\n\tpublic shadowBlur?: number;\n\tpublic shadowOffsetX?: number;\n\tpublic shadowOffsetY?: number;\n\tpublic shadowOpacity?: number;\n\n\tprotected _imageMask: HTMLCanvasElement | undefined;\n\n\tconstructor(renderer: CanvasRenderer, image: HTMLImageElement | undefined) {\n\t\tsuper(renderer);\n\t\tthis.image = image;\n\t}\n\n\tprotected _dispose(): void {\n\t\tsuper._dispose();\n\n\t\tif (this._imageMask) {\n\t\t\tclearCanvas(this._imageMask);\n\t\t}\n\t}\n\n\tgetLocalBounds(): IBounds {\n\t\tif (!this._localBounds) {\n\n\n\t\t\tlet w = 0;\n\t\t\tlet h = 0;\n\n\t\t\tif (this.width) {\n\t\t\t\tw = this.width;\n\t\t\t}\n\t\t\tif (this.height) {\n\t\t\t\th = this.height;\n\t\t\t}\n\n\t\t\tthis._localBounds = {\n\t\t\t\tleft: 0,\n\t\t\t\ttop: 0,\n\t\t\t\tright: w,\n\t\t\t\tbottom: h\n\t\t\t};\n\n\t\t\tthis._addBounds(this._localBounds);\n\t\t}\n\t\treturn this._localBounds;\n\t}\n\n\tprotected _render(parentLayer: CanvasLayer): void {\n\t\tsuper._render(parentLayer);\n\n\t\tif (this.image) {\n\t\t\tconst layer = this._layer || parentLayer;\n\n\t\t\tif (this.tainted === undefined) {\n\t\t\t\tthis.tainted = isTainted(this.image);\n\t\t\t\tlayer.tainted = true;\n\t\t\t}\n\n\t\t\tif (this.tainted && this._renderer._omitTainted) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (layer.dirty) {\n\n\t\t\t\tif (this.shadowColor) {\n\t\t\t\t\tlayer.context.shadowColor = this.shadowColor.toCSS(this.shadowOpacity || 1);\n\t\t\t\t}\n\t\t\t\tif (this.shadowBlur) {\n\t\t\t\t\tlayer.context.shadowBlur = this.shadowBlur;\n\t\t\t\t}\n\t\t\t\tif (this.shadowOffsetX) {\n\t\t\t\t\tlayer.context.shadowOffsetX = this.shadowOffsetX;\n\t\t\t\t}\n\t\t\t\tif (this.shadowOffsetY) {\n\t\t\t\t\tlayer.context.shadowOffsetY = this.shadowOffsetY;\n\t\t\t\t}\n\n\t\t\t\t// TODO should this round ?\n\t\t\t\tconst width = this.width || this.image.naturalWidth;\n\t\t\t\tconst height = this.height || this.image.naturalHeight;\n\n\t\t\t\tlayer.context.drawImage(this.image, 0, 0, width, height);\n\t\t\t}\n\n\t\t\tif (this.interactive && this._isInteractive()) {\n\t\t\t\tconst mask = this._getMask(this.image);\n\n\t\t\t\tthis._renderer._ghostContext.drawImage(mask, 0, 0);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic clear(): void {\n\t\tsuper.clear();\n\t\tthis.image = undefined;\n\t\tthis._imageMask = undefined;\n\t}\n\n\tprotected _getMask(image: HTMLImageElement): HTMLCanvasElement {\n\t\tif (this._imageMask === undefined) {\n\t\t\t// TODO should this round ?\n\t\t\tconst width = this.width || image.naturalWidth;\n\t\t\tconst height = this.height || image.naturalHeight;\n\n\t\t\t// We need to create a second canvas because destination-in clears out the entire canvas\n\t\t\tconst canvas = document.createElement(\"canvas\");\n\t\t\tcanvas.width = width;\n\t\t\tcanvas.height = height;\n\n\t\t\tconst context = canvas.getContext(\"2d\")!;\n\n\t\t\tcontext.imageSmoothingEnabled = false;\n\n\t\t\tcontext.fillStyle = this._getColorId();\n\t\t\tcontext.fillRect(0, 0, width, height);\n\n\t\t\tif (!isTainted(image)) {\n\t\t\t\tcontext.globalCompositeOperation = \"destination-in\";\n\t\t\t\tcontext.drawImage(image, 0, 0, width, height);\n\t\t\t}\n\n\t\t\tthis._imageMask = canvas;\n\t\t}\n\n\t\treturn this._imageMask;\n\t}\n\n}\n\n/**\n * @ignore\n */\nexport class CanvasRendererEvent<A> implements IRendererEvent<A> {\n\tpublic id: Id;\n\tpublic simulated: boolean = false;\n\tpublic native: boolean = true;\n\n\tconstructor(public event: A, public point: IPoint, public bbox: DOMRect) {\n\t\tif ($utils.supports(\"touchevents\") && event instanceof Touch) {\n\t\t\tthis.id = event.identifier;\n\n\t\t} else {\n\t\t\tthis.id = null;\n\t\t}\n\t}\n}\n\n/**\n * @ignore\n */\ninterface Event<Key extends keyof IRendererEvents> {\n\tobject: CanvasDisplayObject;\n\tcontext: unknown;\n\tcallback: (event: IRendererEvents[Key]) => void;\n\tdisposed: boolean;\n}\n\n/**\n * @ignore\n */\ninterface Events<Key extends keyof IRendererEvents> {\n\tdisposer: IDisposer;\n\tcallbacks: Array<Event<Key>>;\n\tdispatching: boolean;\n\tcleanup: boolean;\n}\n\n/**\n * @ignore\n */\nexport class CanvasRenderer extends ArrayDisposer implements IRenderer, IDisposer {\n\tpublic view: HTMLElement = document.createElement(\"div\");\n\tprotected _layerDom: HTMLElement = document.createElement(\"div\");\n\n\tpublic layers: Array<CanvasLayer> = [];\n\tpublic _dirtyLayers: Array<CanvasLayer> = [];\n\tpublic defaultLayer: CanvasLayer = this.getLayer(0);\n\n\tprotected _ghostView: HTMLCanvasElement;\n\tpublic _ghostContext: CanvasRenderingContext2D;\n\n\tprotected _patternCanvas: HTMLCanvasElement = document.createElement(\"canvas\");\n\tprotected _patternContext: CanvasRenderingContext2D = this._patternCanvas.getContext(\"2d\")!;\n\n\tprotected _width: number = 0;\n\tprotected _height: number = 0;\n\n\tprotected _clientWidth: number = 0;\n\tprotected _clientHeight: number = 0;\n\n\tpublic resolution: number;\n\tpublic interactionsEnabled: boolean = true;\n\n\tprotected _listeners: { [key: string]: CounterDisposer } = {};\n\tprotected _events: { [Key in keyof IRendererEvents]?: Events<Key> } = {};\n\n\tprotected _colorId: number = 0;\n\tprotected _colorMap: { [color: string]: CanvasDisplayObject } = {};\n\n\tpublic _forceInteractive: number = 0;\n\tpublic _omitTainted: boolean = false;\n\n\t// TODO this should store the Id as well\n\tpublic _hovering: Set<CanvasDisplayObject> = new Set();\n\tpublic _dragging: Array<{ id: Id, value: CanvasDisplayObject }> = [];\n\tpublic _mousedown: Array<{ id: Id, value: CanvasDisplayObject }> = [];\n\n\tprotected _lastPointerMoveEvent: { events: Array<IPointerEvent>, native: boolean } | undefined;\n\n\tpublic tapToActivate: boolean = false;\n\tpublic tapToActivateTimeout: number = 3000;\n\tpublic _touchActive: boolean = false;\n\tprotected _touchActiveTimeout?: number;\n\n\t/*protected _mouseMoveThrottler: Throttler = new Throttler(() => {\n\t\tthis._dispatchGlobalMousemove(this._lastPointerMoveEvent.event, this._lastPointerMoveEvent.native);\n\t});\n\t*/\n\n\tconstructor(resolution?: number) {\n\t\tsuper();\n\n\t\tif (resolution == null) {\n\t\t\tthis.resolution = window.devicePixelRatio;\n\t\t} else {\n\t\t\tthis.resolution = resolution;\n\t\t}\n\n\t\tthis.view.style.position = \"absolute\";\n\t\tthis.view.appendChild(this._layerDom);\n\n\t\tthis._disposers.push(new Disposer(() => {\n\t\t\t$object.each(this._events, (_key, events) => {\n\t\t\t\tevents.disposer.dispose();\n\t\t\t});\n\n\t\t\t$array.each(this.layers, (layer) => {\n\t\t\t\tclearCanvas(layer.view);\n\n\t\t\t\tif (layer.exportableView) {\n\t\t\t\t\tclearCanvas(layer.exportableView);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tclearCanvas(this._ghostView);\n\t\t\tclearCanvas(this._patternCanvas);\n\t\t}));\n\n\t\t// @todo : do the same for ghost\n\t\tthis._ghostView = document.createElement(\"canvas\");\n\t\tthis._ghostContext = this._ghostView.getContext(\"2d\", { alpha: false, willReadFrequently: true })! as CanvasRenderingContext2D;\n\t\tthis._ghostContext.imageSmoothingEnabled = false;\n\n\t\tthis._ghostView.style.position = \"absolute\";\n\t\tthis._ghostView.style.top = \"0px\";\n\t\tthis._ghostView.style.left = \"0px\";\n\n\t\tthis._disposers.push($utils.addEventListener(this._ghostView, \"click\", (originalEvent: MouseEvent) => {\n\t\t\tconst event = this.getEvent(originalEvent);\n\t\t\tconst target = this._getHitTarget(event.point, event.bbox);\n\t\t\tconsole.debug(target);\n\t\t}));\n\n\t\t// Monitor for possible pixel ratio changes (when page is zoomed)\n\t\tthis._disposers.push($utils.onZoom(() => {\n\t\t\tif (resolution == null) {\n\t\t\t\tthis.resolution = window.devicePixelRatio;\n\t\t\t}\n\t\t}));\n\n\t\t// We need this in order top prevent default touch gestures when dragging\n\t\t// draggable elements\n\t\tif ($utils.supports(\"touchevents\")) {\n\t\t\tconst listener = (ev: any) => {\n\t\t\t\tif (this._dragging.length !== 0) {\n\t\t\t\t\t$array.eachContinue(this._dragging, (item) => {\n\t\t\t\t\t\tif (item.value.shouldCancelTouch()) {\n\t\t\t\t\t\t\tev.preventDefault();\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// If touch down happends, delay touch out\n\t\t\t\tif (this._touchActiveTimeout) {\n\t\t\t\t\tthis._delayTouchDeactivate();\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis._disposers.push($utils.addEventListener(window, \"touchstart\", listener, { passive: false }));\n\t\t\tthis._disposers.push($utils.addEventListener(this.view, \"touchstart\", listener, { passive: false }));\n\n\t\t\tthis._disposers.push($utils.addEventListener(this.view, \"touchmove\", () => {\n\t\t\t\t// If touch is moving, delay touch out\n\t\t\t\tif (this._touchActiveTimeout) {\n\t\t\t\t\tthis._delayTouchDeactivate();\n\t\t\t\t}\n\t\t\t}, { passive: true }));\n\n\t\t\tthis._disposers.push($utils.addEventListener(window, \"click\", (_ev: any) => {\n\t\t\t\tthis._touchActive = false;\n\t\t\t}, { passive: true }));\n\n\t\t\tthis._disposers.push($utils.addEventListener(this.view, \"click\", (_ev: any) => {\n\t\t\t\twindow.setTimeout(() => {\n\t\t\t\t\tthis._touchActive = true;\n\t\t\t\t\tthis._delayTouchDeactivate();\n\t\t\t\t}, 100);\n\t\t\t}, { passive: true }));\n\n\t\t}\n\n\t\t// Prevent scrolling of the window when hovering on \"wheelable\" object\n\t\tif ($utils.supports(\"wheelevents\")) {\n\t\t\tthis._disposers.push($utils.addEventListener(this.view, \"wheel\", (ev) => {\n\t\t\t\tlet prevent = false;\n\t\t\t\tthis._hovering.forEach((obj) => {\n\t\t\t\t\tif (obj.wheelable) {\n\t\t\t\t\t\tprevent = true;\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tif (prevent) {\n\t\t\t\t\tev.preventDefault();\n\t\t\t\t}\n\t\t\t}, { passive: false }));\n\t\t}\n\n\t}\n\n\tprotected _delayTouchDeactivate(): void {\n\t\tif (this._touchActiveTimeout) {\n\t\t\tclearTimeout(this._touchActiveTimeout);\n\t\t}\n\t\tif (this.tapToActivateTimeout > 0) {\n\t\t\tthis._touchActiveTimeout = window.setTimeout(() => {\n\t\t\t\tthis._touchActive = false;\n\t\t\t}, this.tapToActivateTimeout);\n\t\t}\n\t}\n\n\tpublic get debugGhostView(): boolean {\n\t\treturn !!this._ghostView.parentNode;\n\t}\n\n\tpublic set debugGhostView(value: boolean) {\n\t\tif (value) {\n\t\t\tif (!this._ghostView.parentNode) {\n\t\t\t\tthis.view.appendChild(this._ghostView);\n\t\t\t}\n\n\t\t} else {\n\t\t\tif (this._ghostView.parentNode) {\n\t\t\t\tthis._ghostView.parentNode.removeChild(this._ghostView);\n\t\t\t}\n\t\t}\n\t}\n\n\tcreateLinearGradient(x1: number, y1: number, x2: number, y2: number): CanvasGradient {\n\t\treturn this.defaultLayer.context.createLinearGradient(x1, y1, x2, y2);\n\t}\n\n\tcreateRadialGradient(x1: number, y1: number, radius1: number, x2: number, y2: number, radius2: number): CanvasGradient {\n\t\treturn this.defaultLayer.context.createRadialGradient(x1, y1, radius1, x2, y2, radius2);\n\t}\n\n\tcreatePattern(graphics: CanvasGraphics, background: CanvasGraphics, repetition: string, width: number, height: number): CanvasPattern {\n\t\t// const patternCanvas = document.createElement(\"canvas\");\n\t\t// const patternContext = patternCanvas.getContext(\"2d\")!;\n\t\t// patternCanvas.width = width;\n\t\t// patternCanvas.height = height;\n\t\t// if (fill) {\n\t\t// \tpatternContext.fillStyle = fill.toCSS();\n\t\t// \tpatternContext.fillRect(0, 0, patternCanvas.width, patternCanvas.height);\n\t\t// }\n\n\t\t// const layer = {\n\t\t// \tview: patternCanvas,\n\t\t// \tcontext: patternContext,\n\t\t// \tvisible: true,\n\t\t// \torder: 0,\n\t\t// \twidth: width,\n\t\t// \theight: height,\n\t\t// \tdirty: true\n\t\t// };\n\n\t\t// // patternContext.arc(0, 0, 50, 0, .5 * Math.PI);\n\t\t// // patternContext.stroke();\n\n\t\t// image.targetLayer = layer;\n\t\t// image.render(layer);\n\n\t\t//this._layerDom.appendChild(patternCanvas);\n\n\t\tthis._patternCanvas.width = width;\n\t\tthis._patternCanvas.height = height;\n\n\t\tthis._patternContext.clearRect(0, 0, width, height);\n\n\t\t// patternCanvas.style.width = width * this.resolution + \"px\";\n\t\t// patternCanvas.style.height = height * this.resolution + \"px\";\n\n\t\tbackground.renderDetached(this._patternContext);\n\t\tgraphics.renderDetached(this._patternContext);\n\n\t\treturn this._patternContext.createPattern(this._patternCanvas, repetition)!;\n\t}\n\n\tmakeContainer(): CanvasContainer {\n\t\treturn new CanvasContainer(this);\n\t}\n\n\tmakeGraphics(): CanvasGraphics {\n\t\treturn new CanvasGraphics(this);\n\t}\n\n\tmakeText(text: string, style: CanvasTextStyle): CanvasText {\n\t\treturn new CanvasText(this, text, style);\n\t}\n\n\tmakeTextStyle(): CanvasTextStyle {\n\t\treturn new CanvasTextStyle();\n\t}\n\n\tmakeRadialText(text: string, style: CanvasTextStyle): CanvasRadialText {\n\t\treturn new CanvasRadialText(this, text, style);\n\t}\n\n\tmakePicture(image: HTMLImageElement | undefined): CanvasImage {\n\t\treturn new CanvasImage(this, image);\n\t}\n\n\tresize(width: number, height: number): void {\n\t\tthis._clientWidth = width;\n\t\tthis._clientHeight = height;\n\t\tthis._width = Math.floor(width * this.resolution);\n\t\tthis._height = Math.floor(height * this.resolution);\n\n\t\t$array.each(this.layers, (layer) => {\n\t\t\tif (layer) {\n\t\t\t\tlayer.dirty = true;\n\n\t\t\t\tif (layer.width != null) {\n\t\t\t\t\tlayer.view.width = layer.width;\n\t\t\t\t\tlayer.view.style.width = layer.width + \"px\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tlayer.view.width = this._width;\n\t\t\t\t\tlayer.view.style.width = width + \"px\";\n\t\t\t\t}\n\n\t\t\t\tif (layer.height != null) {\n\t\t\t\t\tlayer.view.height = layer.height;\n\t\t\t\t\tlayer.view.style.height = layer.height + \"px\";\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tlayer.view.height = this._height;\n\t\t\t\t\tlayer.view.style.height = height + \"px\";\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// @todo: do the same for ghost canvases\n\t\tthis._ghostView.width = this._width;\n\t\tthis._ghostView.height = this._height;\n\t\tthis._ghostView.style.width = width + \"px\";\n\t\tthis._ghostView.style.height = height + \"px\";\n\n\t\tthis.view.style.width = width + \"px\";\n\t\tthis.view.style.height = height + \"px\";\n\t}\n\n\tprivate createDetachedLayer(willReadFrequently: boolean = false): CanvasLayer {\n\t\tconst view = document.createElement(\"canvas\");\n\t\tconst context = view.getContext(\"2d\", { willReadFrequently: willReadFrequently })! as CanvasRenderingContext2D;\n\t\tconst layer = {\n\t\t\tview: view,\n\t\t\tcontext: context,\n\t\t\torder: 0,\n\t\t\tvisible: true,\n\t\t\twidth: undefined,\n\t\t\theight: undefined,\n\t\t\tdirty: true,\n\t\t\ttainted: false\n\t\t};\n\n\t\tview.style.position = \"absolute\";\n\t\tview.style.top = \"0px\";\n\t\tview.style.left = \"0px\";\n\n\t\treturn layer;\n\t}\n\n\tgetLayerByOrder(order: number): CanvasLayer | undefined {\n\t\tconst layers = this.layers;\n\t\tconst length = layers.length;\n\t\tfor (let i = 0; i < length; i++) {\n\t\t\tconst layer = layers[i];\n\t\t\tif (layer.order == order) {\n\t\t\t\treturn layer;\n\t\t\t}\n\t\t}\n\t}\n\n\tgetLayer(order: number, visible: boolean = true): CanvasLayer {\n\t\tlet existingLayer = this.getLayerByOrder(order);\n\t\tif (existingLayer) {\n\t\t\treturn existingLayer;\n\t\t}\n\n\t\tconst layer = this.createDetachedLayer(order == 99);\n\t\tlayer.order = order;\n\t\tlayer.visible = visible;\n\n\t\tif (layer.visible && this._width) {\n\t\t\tlayer.view.width = this._width;\n\t\t\tlayer.view.style.width = this._clientWidth + \"px\";\n\t\t\tlayer.view.height = this._height;\n\t\t\tlayer.view.style.height = this._clientHeight + \"px\";\n\t\t}\n\n\t\tconst layers = this.layers;\n\n\t\tlayers.push(layer);\n\n\t\tlayers.sort((a, b) => {\n\t\t\tif (a.order > b.order) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\telse if (a.order < b.order) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t});\n\n\t\tconst length = layers.length;\n\t\tconst layerIndex = $array.indexOf(layers, layer);\n\t\tlet next;\n\n\t\tfor (let i = layerIndex + 1; i < length; i++) {\n\t\t\tif (layers[i].visible) {\n\t\t\t\tnext = layers[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (layer.visible) {\n\t\t\tif (next === undefined) {\n\t\t\t\tthis._layerDom.appendChild(layer.view);\n\n\t\t\t} else {\n\t\t\t\tthis._layerDom.insertBefore(layer.view, next.view);\n\t\t\t}\n\t\t}\n\n\t\treturn layer;\n\t}\n\n\trender(root: CanvasDisplayObject): void {\n\n\t\tthis._dirtyLayers.length = 0;\n\n\t\t$array.each(this.layers, (layer) => {\n\t\t\tif (layer) {\n\t\t\t\tif (layer.dirty && layer.visible) {\n\t\t\t\t\tconst context = layer.context;\n\n\t\t\t\t\tthis._dirtyLayers.push(layer);\n\n\t\t\t\t\tcontext.save();\n\t\t\t\t\tcontext.clearRect(0, 0, this._width, this._height);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis._ghostContext.save();\n\t\t//this._ghostContext.clearRect(0, 0, this._width, this._height);\n\t\t//this._ghostContext.beginPath();\n\t\tthis._ghostContext.fillStyle = '#000';\n\t\tthis._ghostContext.fillRect(0, 0, this._width, this._height);\n\n\t\troot.render(this.defaultLayer);\n\n\t\tthis._ghostContext.restore();\n\n\t\t//setTimeout(() => {\n\n\t\t// Remove this after the Chrome bug is fixed:\n\t\t// https://bugs.chromium.org/p/chromium/issues/detail?id=1279394\n\t\t$array.each(this.layers, (layer) => {\n\t\t\tif (layer) {\n\t\t\t\tconst context = layer.context;\n\t\t\t\tcontext.beginPath();\n\t\t\t\tcontext.moveTo(0, 0);\n\t\t\t\tcontext.stroke();\n\t\t\t}\n\t\t});\n\n\t\t$array.each(this._dirtyLayers, (layer) => {\n\t\t\tlayer.context.restore();\n\t\t\tlayer.dirty = false;\n\t\t});\n\t\t//}, 100)\n\n\t\tif (this._hovering.size && this._lastPointerMoveEvent) {\n\t\t\t//this._mouseMoveThrottler.run();\n\t\t\tconst native = this._lastPointerMoveEvent.native;\n\n\t\t\t$array.each(this._lastPointerMoveEvent.events, (event) => {\n\t\t\t\tthis._dispatchGlobalMousemove(event, native);\n\t\t\t});\n\t\t}\n\t}\n\n\tpaintId(obj: CanvasDisplayObject): string {\n\t\tconst id = distributeId(++this._colorId);\n\t\tconst color = Color.fromHex(id).toCSS();\n\t\tthis._colorMap[color] = obj;\n\t\treturn color;\n\t}\n\n\t_removeObject(obj: CanvasDisplayObject): void {\n\t\tif (obj._colorId !== undefined) {\n\t\t\tdelete this._colorMap[obj._colorId];\n\t\t}\n\t}\n\n\t// protected _identifyObjectByColor(colorId: number): CanvasDisplayObject | undefined {\n\t// \treturn this._colorMap[colorId];\n\t// }\n\n\tpublic getEvent<A extends IPointerEvent>(originalEvent: A, adjustPoint: boolean = true): CanvasRendererEvent<A> {\n\t\tconst bbox: DOMRect = adjustPoint ? this.view.getBoundingClientRect() : new DOMRect(0, 0, 0, 0);\n\n\t\treturn new CanvasRendererEvent(\n\t\t\toriginalEvent,\n\t\t\t(originalEvent.clientX || originalEvent.clientY ? {\n\t\t\t\tx: originalEvent.clientX - (originalEvent.clientX ? bbox.left : 0),\n\t\t\t\ty: originalEvent.clientY - (originalEvent.clientY ? bbox.top : 0),\n\t\t\t} : {\n\t\t\t\tx: 0,\n\t\t\t\ty: 0\n\t\t\t}),\n\t\t\tbbox,\n\t\t);\n\t}\n\n\t_getHitTarget(point: IPoint, bbox: DOMRect): CanvasDisplayObject | undefined | false {\n\t\tif (point.x < 0 || point.x > bbox.width || point.y < 0 || point.y > bbox.height) {\n\t\t\treturn;\n\t\t}\n\t\telse {\n\t\t\tconst pixel = this._ghostContext.getImageData(\n\t\t\t\t// TODO should this round ?\n\t\t\t\tMath.round((point.x / bbox.width) * this._width),\n\t\t\t\tMath.round((point.y / bbox.height) * this._height),\n\t\t\t\t1,\n\t\t\t\t1\n\t\t\t);\n\n\t\t\tif (pixel.data[0] === 0 && pixel.data[1] === 0 && pixel.data[2] === 0) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst colorId = Color.fromRGB(pixel.data[0], pixel.data[1], pixel.data[2]).toCSS();\n\t\t\tconst hit = this._colorMap[colorId];\n\n\t\t\treturn hit;\n\t\t}\n\t}\n\n\t_withEvents<Key extends keyof IRendererEvents>(key: Key, f: (events: Events<Key>) => void): void {\n\t\tconst events = this._events[key] as Events<Key> | undefined;\n\n\t\tif (events !== undefined) {\n\t\t\tevents.dispatching = true;\n\n\t\t\ttry {\n\t\t\t\tf(events);\n\n\t\t\t} finally {\n\t\t\t\tevents.dispatching = false;\n\n\t\t\t\tif (events.cleanup) {\n\t\t\t\t\tevents.cleanup = false;\n\n\t\t\t\t\t$array.keepIf(events.callbacks, (callback) => {\n\t\t\t\t\t\treturn !callback.disposed;\n\t\t\t\t\t});\n\n\t\t\t\t\tif (events.callbacks.length === 0) {\n\t\t\t\t\t\tevents.disposer.dispose();\n\t\t\t\t\t\tdelete this._events[key];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t_dispatchEventAll<Key extends keyof IRendererEvents>(key: Key, event: IRendererEvents[Key]): void {\n\t\tif (!this.interactionsEnabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._withEvents(key, (events) => {\n\t\t\t$array.each(events.callbacks, (callback) => {\n\t\t\t\tif (!callback.disposed) {\n\t\t\t\t\tcallback.callback.call(callback.context, event);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t_dispatchEvent<Key extends keyof IRendererEvents>(key: Key, target: CanvasDisplayObject, event: IRendererEvents[Key]): boolean {\n\t\tif (!this.interactionsEnabled) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet dispatched = false;\n\n\t\tthis._withEvents(key, (events) => {\n\t\t\t$array.each(events.callbacks, (callback) => {\n\t\t\t\tif (!callback.disposed && callback.object === target) {\n\t\t\t\t\tcallback.callback.call(callback.context, event);\n\t\t\t\t\tdispatched = true;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\treturn dispatched;\n\t}\n\n\t_dispatchMousedown(originalEvent: IPointerEvent): void {\n\n\t\tconst button = (<PointerEvent>originalEvent).button;\n\t\tif (button != 0 && button != 2 && button != 1 && button !== undefined) {\n\t\t\t// Ignore non-primary mouse buttons\n\t\t\treturn;\n\t\t}\n\n\t\tconst event = this.getEvent(originalEvent);\n\t\tconst target = this._getHitTarget(event.point, event.bbox);\n\n\n\t\tif (target) {\n\t\t\tconst id = event.id;\n\n\t\t\tlet dragged = false;\n\n\t\t\teachTargets(target, (obj) => {\n\t\t\t\tconst info = { id: id, value: obj };\n\n\t\t\t\tthis._mousedown.push(info);\n\n\t\t\t\tif (!dragged && this._dispatchEvent(\"pointerdown\", obj, event)) {\n\t\t\t\t\t// Only dispatch the first element which matches\n\t\t\t\t\tdragged = true;\n\n\t\t\t\t\tconst has = this._dragging.some((x) => {\n\t\t\t\t\t\treturn x.value === obj && x.id === id;\n\t\t\t\t\t});\n\n\t\t\t\t\tif (!has) {\n\t\t\t\t\t\tthis._dragging.push(info);\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t});\n\t\t}\n\t}\n\n\t_dispatchGlobalMousemove(originalEvent: IPointerEvent, native: boolean): void {\n\t\tconst event = this.getEvent(originalEvent);\n\n\t\tconst target = this._getHitTarget(event.point, event.bbox);\n\t\tevent.native = native;\n\n\t\tif (target) {\n\t\t\tthis._hovering.forEach((obj) => {\n\t\t\t\tif (!obj.contains(target)) {\n\t\t\t\t\tthis._hovering.delete(obj);\n\t\t\t\t\tif (obj.cursorOverStyle) {\n\t\t\t\t\t\t$utils.setStyle(document.body, \"cursor\", obj._replacedCursorStyle!);\n\t\t\t\t\t}\n\t\t\t\t\tthis._dispatchEvent(\"pointerout\", obj, event);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (event.native) {\n\t\t\t\teachTargets(target, (obj) => {\n\t\t\t\t\tif (!this._hovering.has(obj)) {\n\t\t\t\t\t\tthis._hovering.add(obj);\n\t\t\t\t\t\tif (obj.cursorOverStyle) {\n\t\t\t\t\t\t\tobj._replacedCursorStyle = $utils.getStyle(document.body, \"cursor\");\n\t\t\t\t\t\t\t$utils.setStyle(document.body, \"cursor\", obj.cursorOverStyle);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis._dispatchEvent(\"pointerover\", obj, event);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn true;\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t//} else if (target === false) {\n\t\t} else {\n\t\t\tthis._hovering.forEach((obj) => {\n\t\t\t\tif (obj.cursorOverStyle) {\n\t\t\t\t\t$utils.setStyle(document.body, \"cursor\", obj._replacedCursorStyle!);\n\t\t\t\t}\n\t\t\t\tthis._dispatchEvent(\"pointerout\", obj, event);\n\t\t\t});\n\n\t\t\tthis._hovering.clear();\n\t\t}\n\t\tthis._dispatchEventAll(\"globalpointermove\", event);\n\t}\n\n\t_dispatchGlobalMouseup(originalEvent: IPointerEvent, native: boolean): void {\n\t\tconst event = this.getEvent(originalEvent);\n\t\tevent.native = native;\n\t\t//const target = this._getHitTarget(event.point);\n\t\tthis._dispatchEventAll(\"globalpointerup\", event);\n\t}\n\n\t_dispatchDragMove(originalEvent: IPointerEvent): void {\n\t\tif (this._dragging.length !== 0) {\n\t\t\tconst event = this.getEvent(originalEvent);\n\t\t\tconst id = event.id;\n\n\t\t\tthis._dragging.forEach((obj) => {\n\t\t\t\tif (obj.id === id) {\n\t\t\t\t\tthis._dispatchEvent(\"pointermove\", obj.value, event);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t_dispatchDragEnd(originalEvent: IPointerEvent): void {\n\t\tconst button = (<PointerEvent>originalEvent).button;\n\t\tlet clickevent: \"click\" | \"rightclick\" | \"middleclick\";\n\t\tif (button == 0 || button === undefined) {\n\t\t\tclickevent = \"click\";\n\t\t}\n\t\telse if (button == 2) {\n\t\t\tclickevent = \"rightclick\";\n\t\t}\n\t\telse if (button == 1) {\n\t\t\tclickevent = \"middleclick\";\n\t\t}\n\t\telse {\n\t\t\t// Ignore non-primary mouse buttons\n\t\t\treturn;\n\t\t}\n\n\t\tconst event = this.getEvent(originalEvent);\n\t\tconst id = event.id;\n\n\t\tif (this._mousedown.length !== 0) {\n\t\t\tconst target = this._getHitTarget(event.point, event.bbox);\n\n\t\t\tif (target) {\n\t\t\t\tthis._mousedown.forEach((obj) => {\n\t\t\t\t\tif (obj.id === id && obj.value.contains(target)) {\n\t\t\t\t\t\tthis._dispatchEvent(clickevent, obj.value, event);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis._mousedown.length = 0;\n\t\t}\n\n\t\tif (this._dragging.length !== 0) {\n\t\t\tthis._dragging.forEach((obj) => {\n\t\t\t\tif (obj.id === id) {\n\t\t\t\t\tthis._dispatchEvent(\"pointerup\", obj.value, event);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis._dragging.length = 0;\n\t\t}\n\t}\n\n\t_dispatchDoubleClick(originalEvent: IPointerEvent): void {\n\t\tconst event = this.getEvent(originalEvent);\n\t\tconst target = this._getHitTarget(event.point, event.bbox);\n\n\t\tif (target) {\n\t\t\teachTargets(target, (obj) => {\n\t\t\t\tif (this._dispatchEvent(\"dblclick\", obj, event)) {\n\t\t\t\t\treturn false;\n\t\t\t\t} else {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t_dispatchWheel(originalEvent: WheelEvent): void {\n\t\tconst event = this.getEvent(originalEvent);\n\t\tconst target = this._getHitTarget(event.point, event.bbox);\n\n\t\tif (target) {\n\t\t\teachTargets(target, (obj) => {\n\t\t\t\tif (this._dispatchEvent(\"wheel\", obj, event)) {\n\t\t\t\t\treturn false;\n\t\t\t\t} else {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\t_makeSharedEvent(key: string, f: () => IDisposer): IDisposer {\n\t\tif (this._listeners[key] === undefined) {\n\t\t\tconst listener = f();\n\n\t\t\tthis._listeners[key] = new CounterDisposer(() => {\n\t\t\t\tdelete this._listeners[key];\n\t\t\t\tlistener.dispose();\n\t\t\t});\n\t\t}\n\n\t\treturn this._listeners[key].increment();\n\t}\n\n\t_onPointerEvent(name: string, f: (event: Array<IPointerEvent>, native: boolean) => void): IDisposer {\n\t\tlet native = false;\n\t\tlet timer: number | null = null;\n\n\t\tfunction clear() {\n\t\t\ttimer = null;\n\t\t\tnative = false;\n\t\t}\n\n\t\treturn new MultiDisposer([\n\t\t\tnew Disposer(() => {\n\t\t\t\tif (timer !== null) {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t}\n\n\t\t\t\tclear();\n\t\t\t}),\n\n\t\t\t$utils.addEventListener(this.view, $utils.getRendererEvent(name), (_) => {\n\t\t\t\tnative = true;\n\n\t\t\t\tif (timer !== null) {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t}\n\n\t\t\t\ttimer = window.setTimeout(clear, 0);\n\t\t\t}),\n\n\t\t\tonPointerEvent(window, name, (ev) => {\n\t\t\t\tif (timer !== null) {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\ttimer = null;\n\t\t\t\t}\n\n\t\t\t\tf(ev, native);\n\n\t\t\t\tnative = false;\n\t\t\t}),\n\t\t]);\n\t}\n\n\t// This ensures that only a single DOM event is added (e.g. only a single mousemove event listener)\n\t_initEvent(key: keyof IRendererEvents): IDisposer | undefined {\n\t\tswitch (key) {\n\t\t\tcase \"globalpointermove\":\n\t\t\tcase \"pointerover\":\n\t\t\tcase \"pointerout\":\n\t\t\t\treturn this._makeSharedEvent(\"pointermove\", () => {\n\t\t\t\t\tconst listener = (events: Array<IPointerEvent>, native: boolean) => {\n\t\t\t\t\t\tthis._lastPointerMoveEvent = { events, native };\n\n\t\t\t\t\t\t$array.each(events, (event) => {\n\t\t\t\t\t\t\tthis._dispatchGlobalMousemove(event, native);\n\t\t\t\t\t\t});\n\t\t\t\t\t};\n\n\t\t\t\t\treturn new MultiDisposer([\n\t\t\t\t\t\tthis._onPointerEvent(\"pointerdown\", listener),\n\t\t\t\t\t\tthis._onPointerEvent(\"pointermove\", listener),\n\t\t\t\t\t]);\n\t\t\t\t});\n\t\t\tcase \"globalpointerup\":\n\t\t\t\treturn this._makeSharedEvent(\"pointerup\", () => {\n\t\t\t\t\tvar mouseup = this._onPointerEvent(\"pointerup\", (events, native) => {\n\t\t\t\t\t\t$array.each(events, (event) => {\n\t\t\t\t\t\t\tthis._dispatchGlobalMouseup(event, native);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthis._lastPointerMoveEvent = { events, native };\n\t\t\t\t\t});\n\n\t\t\t\t\tvar pointercancel = this._onPointerEvent(\"pointercancel\", (events, native) => {\n\t\t\t\t\t\t$array.each(events, (event) => {\n\t\t\t\t\t\t\tthis._dispatchGlobalMouseup(event, native);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tthis._lastPointerMoveEvent = { events, native };\n\t\t\t\t\t});\n\n\t\t\t\t\treturn new Disposer(() => {\n\t\t\t\t\t\tmouseup.dispose();\n\t\t\t\t\t\tpointercancel.dispose();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\tcase \"click\":\n\t\t\tcase \"rightclick\":\n\t\t\tcase \"middleclick\":\n\t\t\tcase \"pointerdown\":\n\t\t\t/*\n\t\t\t\treturn this._makeSharedEvent(\"pointerdown\", () => {\n\t\t\t\t\treturn this._onPointerEvent(\"pointerdown\", (event, native) => {\n\t\t\t\t\t\tthis._lastPointerMoveEvent = { event, native };\n\t\t\t\t\t\tthis._dispatchMousedown(event)\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t*/\n\t\t\tcase \"pointermove\":\n\t\t\tcase \"pointerup\":\n\t\t\t\treturn this._makeSharedEvent(\"pointerdown\", () => {\n\t\t\t\t\t//const throttler = new Throttler();\n\n\t\t\t\t\tconst mousedown = onPointerEvent(this.view, \"pointerdown\", (events) => {\n\t\t\t\t\t\t$array.each(events, (ev) => {\n\t\t\t\t\t\t\tthis._dispatchMousedown(ev);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\t// TODO handle throttling properly for multitouch\n\t\t\t\t\tconst mousemove = this._onPointerEvent(\"pointermove\", (ev: Array<IPointerEvent>) => {\n\t\t\t\t\t\t//throttler.throttle(() => {\n\t\t\t\t\t\t$array.each(ev, (ev) => {\n\t\t\t\t\t\t\tthis._dispatchDragMove(ev);\n\t\t\t\t\t\t});\n\t\t\t\t\t\t//});\n\t\t\t\t\t});\n\n\t\t\t\t\tconst mouseup = this._onPointerEvent(\"pointerup\", (ev: Array<IPointerEvent>) => {\n\t\t\t\t\t\t$array.each(ev, (ev) => {\n\t\t\t\t\t\t\tthis._dispatchDragEnd(ev);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\tconst pointercancel = this._onPointerEvent(\"pointercancel\", (ev: Array<IPointerEvent>) => {\n\t\t\t\t\t\t$array.each(ev, (ev) => {\n\t\t\t\t\t\t\tthis._dispatchDragEnd(ev);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\treturn new Disposer(() => {\n\t\t\t\t\t\tmousedown.dispose();\n\t\t\t\t\t\tmousemove.dispose();\n\t\t\t\t\t\tmouseup.dispose();\n\t\t\t\t\t\tpointercancel.dispose();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\tcase \"dblclick\":\n\t\t\t\treturn this._makeSharedEvent(\"dblclick\", () => {\n\t\t\t\t\treturn this._onPointerEvent(\"dblclick\", (ev) => {\n\t\t\t\t\t\t$array.each(ev, (ev) => {\n\t\t\t\t\t\t\tthis._dispatchDoubleClick(ev);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\tcase \"wheel\":\n\t\t\t\treturn this._makeSharedEvent(\"wheel\", () => {\n\t\t\t\t\treturn $utils.addEventListener(window, $utils.getRendererEvent(\"wheel\"), (event: WheelEvent) => {\n\t\t\t\t\t\tthis._dispatchWheel(event);\n\t\t\t\t\t}, { passive: false });\n\t\t\t\t});\n\t\t}\n\t}\n\n\t_addEvent<C, Key extends keyof IRendererEvents>(object: CanvasDisplayObject, key: Key, callback: (this: C, event: IRendererEvents[Key]) => void, context?: C): IDisposer {\n\t\tlet events: Events<Key> | undefined = this._events[key] as any;\n\n\t\tif (events === undefined) {\n\t\t\tevents = this._events[key] = {\n\t\t\t\tdisposer: this._initEvent(key)!,\n\t\t\t\tcallbacks: [],\n\t\t\t\tdispatching: false,\n\t\t\t\tcleanup: false,\n\t\t\t};\n\t\t}\n\n\t\tconst listener = { object, context, callback, disposed: false };\n\n\t\tevents!.callbacks.push(listener);\n\n\t\treturn new Disposer(() => {\n\t\t\tlistener.disposed = true;\n\n\t\t\tif (events!.dispatching) {\n\t\t\t\tevents!.cleanup = true;\n\n\t\t\t} else {\n\t\t\t\t$array.removeFirst(events!.callbacks, listener);\n\n\t\t\t\tif (events!.callbacks.length === 0) {\n\t\t\t\t\tevents!.disposer.dispose();\n\t\t\t\t\tdelete this._events[key];\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic getCanvas(root: CanvasDisplayObject, options?: ICanvasOptions): HTMLCanvasElement {\n\n\t\t// Make sure everything is rendered\n\t\tthis.render(root);\n\n\t\tif (!options) {\n\t\t\toptions = {};\n\t\t}\n\n\t\tlet scale: number = this.resolution;\n\n\t\t// Check if we need to scale\n\t\tif (options.minWidth && (options.minWidth > this._width)) {\n\t\t\tlet minScale = options.minWidth / this._width;\n\t\t\tif (minScale > scale) {\n\t\t\t\tscale = minScale * this.resolution;\n\t\t\t}\n\t\t}\n\n\t\tif (options.minHeight && (options.minHeight > this._height)) {\n\t\t\tlet minScale = options.minHeight / this._height;\n\t\t\tif (minScale > scale) {\n\t\t\t\tscale = minScale * this.resolution;\n\t\t\t}\n\t\t}\n\n\t\tif (options.maxWidth && (options.maxWidth < this._width)) {\n\t\t\tlet maxScale = options.maxWidth / this._width;\n\t\t\tif (maxScale < scale) {\n\t\t\t\tscale = maxScale * this.resolution;\n\t\t\t}\n\t\t}\n\n\t\tif (options.maxHeight && (options.maxHeight > this._height)) {\n\t\t\tlet maxScale = options.maxHeight / this._height;\n\t\t\tif (maxScale < scale) {\n\t\t\t\tscale = maxScale * this.resolution;\n\t\t\t}\n\t\t}\n\n\t\t// Check if we need to compensate for pixel ratio\n\t\tif (options.maintainPixelRatio) {\n\t\t\tscale /= this.resolution;\n\t\t}\n\n\t\t// Init list canvases to remove from DOM after export\n\t\tconst canvases: HTMLCanvasElement[] = [];\n\n\t\t// Set up new canvas for export\n\t\tlet forceRender = false;\n\t\tlet canvasWidth = this._width;\n\t\tlet canvasHeight = this._height;\n\t\tconst canvas = document.createElement(\"canvas\");\n\t\tif (scale != this.resolution) {\n\t\t\tforceRender = true;\n\t\t\tcanvasWidth = this._width * scale / this.resolution;\n\t\t\tcanvasHeight = this._height * scale / this.resolution;\n\t\t}\n\n\t\tcanvas.width = canvasWidth;\n\t\tcanvas.height = canvasHeight;\n\n\t\t// Add to DOM so it inherits CSS\n\t\tcanvas.style.position = \"fixed\";\n\t\tcanvas.style.top = \"-10000px\";\n\t\tthis.view.appendChild(canvas);\n\t\tcanvases.push(canvas);\n\n\t\t// Context\n\t\tconst context = canvas.getContext(\"2d\")!;\n\n\t\tlet width = 0;\n\t\tlet height = 0;\n\t\tlet needRerender = false;\n\n\t\t$array.each(this.layers, (layer) => {\n\t\t\tif (layer && layer.visible) {\n\t\t\t\tif (layer.tainted || forceRender) {\n\t\t\t\t\tneedRerender = true;\n\n\t\t\t\t\tlayer.exportableView = layer.view;\n\t\t\t\t\tlayer.exportableContext = layer.context;\n\n\t\t\t\t\tlayer.view = document.createElement(\"canvas\");\n\n\t\t\t\t\t// Add to DOM so it inherits CSS\n\t\t\t\t\tlayer.view.style.position = \"fixed\";\n\t\t\t\t\tlayer.view.style.top = \"-10000px\";\n\t\t\t\t\tthis.view.appendChild(layer.view);\n\t\t\t\t\tcanvases.push(layer.view);\n\n\t\t\t\t\tlayer.view.width = canvasWidth;\n\t\t\t\t\tlayer.view.height = canvasHeight;\n\n\t\t\t\t\tlayer.context = layer.view.getContext(\"2d\")!;\n\n\t\t\t\t\tlayer.dirty = true;\n\t\t\t\t\tlayer.scale = scale;\n\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (needRerender) {\n\t\t\tthis._omitTainted = true;\n\t\t\tthis.render(root);\n\t\t\tthis._omitTainted = false;\n\t\t}\n\n\t\t$array.each(this.layers, (layer) => {\n\t\t\tif (layer && layer.visible) {\n\n\t\t\t\t// Layer is fine. Just plop it into our target canvas\n\t\t\t\tcontext.drawImage(layer.view, 0, 0);\n\n\t\t\t\t// Restore layer original canvas\n\t\t\t\tif (layer.exportableView) {\n\t\t\t\t\tlayer.view = layer.exportableView;\n\t\t\t\t\tlayer.exportableView = undefined;\n\t\t\t\t}\n\n\t\t\t\tif (layer.exportableContext) {\n\t\t\t\t\tlayer.context = layer.exportableContext;\n\t\t\t\t\tlayer.exportableContext = undefined;\n\t\t\t\t}\n\n\t\t\t\tif (width < layer.view.clientWidth) {\n\t\t\t\t\twidth = layer.view.clientWidth;\n\t\t\t\t}\n\t\t\t\tif (height < layer.view.clientHeight) {\n\t\t\t\t\theight = layer.view.clientHeight;\n\t\t\t\t}\n\n\t\t\t\tlayer.scale = undefined;\n\t\t\t}\n\t\t});\n\n\t\tcanvas.style.width = width + \"px\";\n\t\tcanvas.style.height = height + \"px\";\n\n\t\t$array.each(canvases, (canvas) => {\n\t\t\tcanvas.style.position = \"\";\n\t\t\tcanvas.style.top = \"\";\n\t\t\tthis.view.removeChild(canvas);\n\t\t})\n\n\t\treturn canvas;\n\t}\n\n}\n\n/**\n * @ignore\n */\nexport interface CanvasLayer extends ILayer {\n\tview: HTMLCanvasElement;\n\tcontext: CanvasRenderingContext2D;\n\ttainted?: boolean;\n\texportableView?: HTMLCanvasElement;\n\texportableContext?: CanvasRenderingContext2D;\n\tscale?: number;\n}\n"]},"metadata":{},"sourceType":"module"}